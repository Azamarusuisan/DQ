<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ドラゴンクエストII - HTML版</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
body{background:#111;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;height:100dvh;overflow:hidden;font-family:monospace;touch-action:none}
#gc{position:relative;width:768px;height:720px;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor;max-width:100vw}
canvas{width:100%;height:100%;display:block;image-rendering:pixelated;image-rendering:crisp-edges}
#pad{display:none;width:100%;max-width:520px;padding:8px 12px 16px;justify-content:space-between;align-items:center;flex-shrink:0}
.dpad{position:relative;width:140px;height:140px}
.dpad button{position:absolute;width:48px;height:48px;background:rgba(255,255,255,0.18);border:2px solid rgba(255,255,255,0.35);border-radius:12px;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;outline:none}
.dpad button:active,.dpad button.held{background:rgba(255,255,255,0.5)}
.dpad .up{top:0;left:46px}.dpad .down{bottom:0;left:46px}.dpad .left{top:46px;left:0}.dpad .right{top:46px;right:0}
.dpad .center{top:46px;left:46px;width:48px;height:48px;background:rgba(255,255,255,0.08);border:none;border-radius:4px;pointer-events:none;font-size:10px;color:rgba(255,255,255,0.2)}
.ab-area{display:flex;flex-direction:column;align-items:center;gap:8px}
.ab-row{display:flex;gap:16px;align-items:center}
.ab-row button{width:56px;height:56px;border-radius:50%;border:2px solid rgba(255,255,255,0.4);background:rgba(60,60,255,0.25);color:#fff;font-size:16px;font-weight:bold;-webkit-tap-highlight-color:transparent;outline:none}
.ab-row button:active,.ab-row button.held{background:rgba(100,100,255,0.6)}
.btn-b{background:rgba(255,80,80,0.25)!important;border-color:rgba(255,80,80,0.5)!important}
.btn-b:active,.btn-b.held{background:rgba(255,80,80,0.6)!important}
.meta-row{display:flex;gap:12px;margin-top:4px}
.meta-row button{width:60px;height:28px;border-radius:14px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#aaa;font-size:10px;-webkit-tap-highlight-color:transparent;outline:none}
.meta-row button:active{background:rgba(255,255,255,0.3)}
@media(pointer:coarse),(max-width:700px){
#gc{max-height:52vh;max-height:52dvh}
#pad{display:flex}
}
@media(max-height:500px){
#gc{max-height:45vh;max-height:45dvh}
.dpad{width:110px;height:110px}
.dpad button{width:38px;height:38px;font-size:16px}
.dpad .up{left:36px}.dpad .down{left:36px}.dpad .left{top:36px}.dpad .right{top:36px}
.dpad .center{top:36px;left:36px;width:38px;height:38px}
.ab-row button{width:46px;height:46px;font-size:14px}
}
</style>
</head>
<body>
<div id="gc"><canvas id="cv" width="768" height="720"></canvas></div>
<div id="pad">
<div class="dpad">
<button class="up" data-key="ArrowUp">▲</button>
<button class="down" data-key="ArrowDown">▼</button>
<button class="left" data-key="ArrowLeft">◀</button>
<button class="right" data-key="ArrowRight">▶</button>
<div class="center">+</div>
</div>
<div class="ab-area">
<div class="ab-row">
<button class="btn-b" data-key="KeyX">B</button>
<button data-key="KeyZ">A</button>
</div>
<div class="meta-row">
<button data-key="Escape">MENU</button>
<button data-key="Enter">START</button>
</div>
</div>
</div>
<script>
'use strict';
const T=16,SW=256,SH=240,COLS=SW/T,ROWS=SH/T;
const TL={};
function mkTile(n,fn){const c=document.createElement('canvas');c.width=c.height=T;fn(c.getContext('2d'));TL[n]=c}
function initTiles(){
mkTile('grass',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#3a3';c.fillRect(2,2,2,2);c.fillRect(10,8,2,2);c.fillRect(6,12,2,2)});
mkTile('sea',c=>{c.fillStyle='#1155cc';c.fillRect(0,0,T,T);c.fillStyle='#2266dd';c.fillRect(0,4,T,4);c.fillRect(0,12,T,4)});
mkTile('desert',c=>{c.fillStyle='#daa520';c.fillRect(0,0,T,T);c.fillStyle='#c89418';c.fillRect(4,4,2,2);c.fillRect(10,10,2,2)});
mkTile('mountain',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#8B4513';c.beginPath();c.moveTo(8,1);c.lineTo(15,15);c.lineTo(1,15);c.fill();c.fillStyle='#fff';c.beginPath();c.moveTo(8,1);c.lineTo(10,5);c.lineTo(6,5);c.fill()});
mkTile('forest',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#006400';c.beginPath();c.arc(8,6,5,0,Math.PI*2);c.fill();c.fillStyle='#8B4513';c.fillRect(7,11,2,5)});
mkTile('wall',c=>{c.fillStyle='#888';c.fillRect(0,0,T,T);c.fillStyle='#666';c.fillRect(0,0,T,1);c.fillRect(0,8,T,1);c.fillStyle='#aaa';c.fillRect(0,7,T,1)});
mkTile('floor',c=>{c.fillStyle='#c4a882';c.fillRect(0,0,T,T);c.strokeStyle='#b09870';c.strokeRect(0,0,T,T)});
mkTile('town',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#d44';c.fillRect(3,3,10,10);c.fillStyle='#a33';c.beginPath();c.moveTo(8,1);c.lineTo(14,5);c.lineTo(2,5);c.fill();c.fillStyle='#daa520';c.fillRect(6,8,4,5)});
mkTile('cave',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#333';c.beginPath();c.arc(8,10,5,Math.PI,0);c.fill();c.fillRect(3,10,10,6)});
mkTile('castle',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#ddd';c.fillRect(2,4,12,12);c.fillStyle='#aaa';c.fillRect(2,2,3,4);c.fillRect(11,2,3,4);c.fillStyle='#8B4513';c.fillRect(6,9,4,7)});
mkTile('bridge',c=>{c.fillStyle='#1155cc';c.fillRect(0,0,T,T);c.fillStyle='#8B4513';c.fillRect(2,0,12,T);c.fillStyle='#a0522d';c.fillRect(2,0,1,T);c.fillRect(13,0,1,T)});
mkTile('stairs_up',c=>{c.fillStyle='#c4a882';c.fillRect(0,0,T,T);c.fillStyle='#8B4513';for(let i=0;i<4;i++)c.fillRect(2+i*2,i*4,T-4-i*4,3)});
mkTile('stairs_down',c=>{c.fillStyle='#c4a882';c.fillRect(0,0,T,T);c.fillStyle='#333';for(let i=0;i<4;i++)c.fillRect(2+i*2,i*4,T-4-i*4,3)});
mkTile('swamp',c=>{c.fillStyle='#4a2';c.fillRect(0,0,T,T);c.fillStyle='#6b3';c.fillRect(2,2,4,4);c.fillRect(8,8,4,4)});
mkTile('tower',c=>{c.fillStyle='#2d8a2d';c.fillRect(0,0,T,T);c.fillStyle='#999';c.fillRect(4,2,8,14);c.fillStyle='#777';c.fillRect(4,0,2,4);c.fillRect(10,0,2,4);c.fillStyle='#555';c.fillRect(6,10,4,6)});
mkTile('chest',c=>{c.fillStyle='#c4a882';c.fillRect(0,0,T,T);c.fillStyle='#daa520';c.fillRect(3,4,10,8);c.fillStyle='#a07010';c.fillRect(3,4,10,1);c.fillRect(3,7,10,1);c.fillStyle='#fff';c.fillRect(7,5,2,2)});
mkTile('chest_open',c=>{c.fillStyle='#c4a882';c.fillRect(0,0,T,T);c.fillStyle='#8a6a10';c.fillRect(3,4,10,8);c.fillStyle='#6a5010';c.fillRect(3,4,10,1);c.fillStyle='#555';c.fillRect(5,6,6,4)});
// ローレシアの王子: 青い鎧、紫の兜、剣
['down','up','left','right'].forEach(dir=>{mkTile('hero_'+dir,c=>{
// 兜(紫)
c.fillStyle='#60c';c.fillRect(5,0,6,3);c.fillRect(4,1,1,2);c.fillRect(11,1,1,2);
// 顔(肌色)
c.fillStyle='#fdb';c.fillRect(5,3,6,3);
// 目
c.fillStyle='#000';
if(dir==='down'){c.fillRect(6,4,1,1);c.fillRect(9,4,1,1)}
else if(dir==='left'){c.fillRect(5,4,1,1)}
else if(dir==='right'){c.fillRect(10,4,1,1)}
// 鎧(青)
c.fillStyle='#22f';c.fillRect(4,6,8,5);
// 鎧のライン
c.fillStyle='#55f';c.fillRect(7,7,2,3);
// 腕
c.fillStyle='#22f';c.fillRect(3,7,1,4);c.fillRect(12,7,1,4);
// 剣(右手)
if(dir!=='up'){c.fillStyle='#ccc';c.fillRect(13,5,1,5);c.fillStyle='#daa520';c.fillRect(12,9,3,1)}
// 足
c.fillStyle='#a52';c.fillRect(5,11,2,3);c.fillRect(9,11,2,3);
// ブーツ
c.fillStyle='#630';c.fillRect(5,13,2,2);c.fillRect(9,13,2,2);
})});
// サマルトリアの王子: 緑のローブ、黄色い帽子
['down','up','left','right'].forEach(dir=>{mkTile('prince_'+dir,c=>{
// 帽子(黄)
c.fillStyle='#ec0';c.fillRect(5,0,6,2);c.fillRect(4,1,8,1);
// 髪
c.fillStyle='#530';c.fillRect(5,2,6,1);
// 顔
c.fillStyle='#fdb';c.fillRect(5,3,6,3);
c.fillStyle='#000';
if(dir==='down'){c.fillRect(6,4,1,1);c.fillRect(9,4,1,1)}
else if(dir==='left'){c.fillRect(5,4,1,1)}
else if(dir==='right'){c.fillRect(10,4,1,1)}
// ローブ(緑)
c.fillStyle='#0a0';c.fillRect(4,6,8,5);
c.fillStyle='#0c0';c.fillRect(6,6,4,1);
// 腕
c.fillStyle='#0a0';c.fillRect(3,7,1,3);c.fillRect(12,7,1,3);
// 杖
if(dir!=='up'){c.fillStyle='#a52';c.fillRect(13,3,1,8);c.fillStyle='#0ff';c.fillRect(13,2,1,1)}
// 足
c.fillStyle='#0a0';c.fillRect(5,11,2,3);c.fillRect(9,11,2,3);
c.fillStyle='#850';c.fillRect(5,13,2,2);c.fillRect(9,13,2,2);
})});
// ムーンブルクの王女: ピンクのローブ、長い髪
['down','up','left','right'].forEach(dir=>{mkTile('princess_'+dir,c=>{
// 髪(青紫)
c.fillStyle='#40a';c.fillRect(4,0,8,6);c.fillRect(3,2,1,8);c.fillRect(12,2,1,8);
// 顔
c.fillStyle='#fdb';c.fillRect(5,2,6,4);
c.fillStyle='#000';
if(dir==='down'){c.fillRect(6,3,1,1);c.fillRect(9,3,1,1);c.fillStyle='#f66';c.fillRect(7,5,2,1)}
else if(dir==='left'){c.fillRect(5,3,1,1)}
else if(dir==='right'){c.fillRect(10,3,1,1)}
// ローブ(ピンク)
c.fillStyle='#f6a';c.fillRect(4,6,8,5);
c.fillStyle='#f8c';c.fillRect(6,7,4,1);
// 腕
c.fillStyle='#f6a';c.fillRect(3,7,1,3);c.fillRect(12,7,1,3);
// スカート
c.fillStyle='#f6a';c.fillRect(4,11,8,3);
c.fillStyle='#d48';c.fillRect(4,13,8,1);
// 足
c.fillStyle='#f8c';c.fillRect(5,14,2,1);c.fillRect(9,14,2,1);
})});
}
initTiles();
const SPELLS={hoimi:{name:'ホイミ',mp:3,type:'heal',power:30,target:'ally'},behoimi:{name:'ベホイミ',mp:5,type:'heal',power:80,target:'ally'},gira:{name:'ギラ',mp:4,type:'damage',power:20,target:'enemies'},begirama:{name:'ベギラマ',mp:6,type:'damage',power:40,target:'enemies'},rariho:{name:'ラリホー',mp:3,type:'status',effect:'sleep',target:'enemy'},manusa:{name:'マヌーサ',mp:3,type:'status',effect:'blind',target:'enemies'},ruura:{name:'ルーラ',mp:8,type:'field'},riremito:{name:'リレミト',mp:6,type:'field'},zaoriku:{name:'ザオリク',mp:15,type:'revive',power:999,target:'ally'},ionazun:{name:'イオナズン',mp:10,type:'damage',power:70,target:'enemies'},sukuruto:{name:'スクルト',mp:4,type:'buff',effect:'def_up',target:'allies'},baikiruto:{name:'バイキルト',mp:6,type:'buff',effect:'atk_up',target:'ally'}};
const WEAPONS=[{id:0,name:'ひのきのぼう',atk:2,price:10,who:[0,1]},{id:1,name:'どうのつるぎ',atk:10,price:100,who:[0,1]},{id:2,name:'はがねのつるぎ',atk:25,price:500,who:[0,1]},{id:3,name:'はやぶさのけん',atk:35,price:0,who:[0],hits:2},{id:4,name:'いなずまのけん',atk:45,price:0,who:[0]},{id:5,name:'ロトのつるぎ',atk:60,price:0,who:[0]},{id:6,name:'てつのやり',atk:20,price:300,who:[1]},{id:7,name:'まどうしのつえ',atk:8,price:200,who:[2]},{id:8,name:'ちからのつえ',atk:15,price:0,who:[2]}];
const ARMORS=[{id:0,name:'ぬののふく',def:2,price:30,who:[0,1,2]},{id:1,name:'かわのよろい',def:8,price:80,who:[0,1]},{id:2,name:'くさりかたびら',def:16,price:300,who:[0,1]},{id:3,name:'はがねのよろい',def:25,price:700,who:[0]},{id:4,name:'みずのはごろも',def:35,price:0,who:[0,1,2]},{id:5,name:'ロトのよろい',def:50,price:0,who:[0]}];
const SHIELDS=[{id:0,name:'かわのたて',def:4,price:60,who:[0,1]},{id:1,name:'てつのたて',def:10,price:250,who:[0,1]},{id:2,name:'ちからのたて',def:18,price:0,who:[0]},{id:3,name:'ロトのたて',def:30,price:0,who:[0]}];
const HELMETS=[{id:0,name:'かわのぼうし',def:2,price:40,who:[0,1,2]},{id:1,name:'てつかぶと',def:6,price:200,who:[0,1]},{id:2,name:'ロトのかぶと',def:20,price:0,who:[0]}];
const ITEMS=[{id:0,name:'やくそう',type:'heal',power:30,price:8},{id:1,name:'どくけしそう',type:'cure',cure:'poison',price:10},{id:2,name:'キメラのつばさ',type:'field',effect:'ruura',price:25},{id:3,name:'せかいじゅのは',type:'revive',power:999,price:0},{id:4,name:'ぎんのカギ',type:'key',price:0},{id:5,name:'きんのカギ',type:'key',price:0},{id:6,name:'ろうやのカギ',type:'key',price:0},{id:7,name:'ふねのきっぷ',type:'key',price:0},{id:8,name:'ラーのかがみ',type:'story',price:0},{id:9,name:'つきのかけら',type:'story',price:0},{id:10,name:'いのちのきのみ',type:'stat',stat:'maxHp',value:5,price:0},{id:11,name:'ふしぎなきのみ',type:'stat',stat:'maxMp',value:5,price:0}];
const HERO_LV=[[0,20,0,8,4,[]],[10,28,0,12,6,[]],[30,36,5,16,9,[]],[80,44,8,22,12,[]],[150,55,12,28,16,['gira']],[250,65,16,35,20,[]],[400,78,20,42,25,['begirama']],[600,90,25,50,30,[]],[900,105,30,58,36,['ionazun']],[1300,120,35,68,42,[]],[1800,138,42,78,48,[]],[2500,155,48,88,55,['baikiruto']],[3500,170,55,98,62,[]],[5000,190,62,110,70,[]],[7000,210,70,120,80,[]]];
const PRINCE_LV=[[0,18,10,6,5,['hoimi']],[12,24,16,10,8,[]],[40,30,22,14,11,['gira']],[100,38,28,18,15,[]],[200,48,36,24,20,['behoimi','sukuruto']],[350,56,42,30,24,[]],[550,66,50,36,29,['begirama']],[800,78,58,44,34,['zaoriku']],[1200,88,66,52,40,[]],[1700,100,75,60,46,[]],[2400,112,84,68,52,[]],[3300,126,94,78,60,[]],[4500,140,104,88,68,[]],[6200,156,116,98,76,[]],[8500,172,128,108,85,[]]];
const PRINCESS_LV=[[0,14,18,4,6,['hoimi','rariho']],[15,18,26,6,10,[]],[50,22,34,8,14,['manusa']],[120,28,42,11,18,['ruura']],[230,34,52,14,23,['behoimi']],[400,40,60,17,28,['riremito']],[650,48,70,21,34,[]],[1000,56,80,26,40,['ionazun']],[1500,64,92,31,46,[]],[2200,74,104,36,52,['zaoriku']],[3100,84,116,42,58,[]],[4200,94,128,48,64,[]],[5800,106,142,55,72,[]],[7800,118,156,62,80,[]],[10000,132,172,70,88,[]]];
const MONSTERS=[{name:'スライム',hp:8,mp:0,atk:6,def:3,agi:3,exp:2,gold:2,spells:[],zone:[0]},{name:'おおなめくじ',hp:14,mp:0,atk:10,def:4,agi:2,exp:4,gold:4,spells:[],zone:[0]},{name:'ドラキー',hp:12,mp:0,atk:9,def:5,agi:6,exp:3,gold:3,spells:[],zone:[0,1]},{name:'ゴースト',hp:20,mp:5,atk:14,def:8,agi:5,exp:6,gold:8,spells:['gira'],zone:[1]},{name:'リカント',hp:28,mp:0,atk:20,def:12,agi:8,exp:10,gold:12,spells:[],zone:[1]},{name:'マンドリル',hp:35,mp:0,atk:28,def:15,agi:10,exp:14,gold:18,spells:[],zone:[1,2]},{name:'メイジドラキー',hp:22,mp:10,atk:12,def:10,agi:12,exp:8,gold:10,spells:['gira'],zone:[1]},{name:'キラービー',hp:18,mp:0,atk:24,def:18,agi:15,exp:12,gold:14,spells:[],zone:[2]},{name:'バピラス',hp:40,mp:8,atk:32,def:20,agi:14,exp:18,gold:22,spells:['rariho'],zone:[2]},{name:'デスフラッター',hp:30,mp:6,atk:26,def:16,agi:18,exp:16,gold:20,spells:['manusa'],zone:[2]},{name:'ようがんまじん',hp:60,mp:0,atk:50,def:40,agi:8,exp:35,gold:45,spells:[],zone:[3]},{name:'アークデーモン',hp:80,mp:20,atk:55,def:35,agi:20,exp:50,gold:60,spells:['begirama'],zone:[3]},{name:'はぐれメタル',hp:5,mp:99,atk:10,def:250,agi:200,exp:1050,gold:10,spells:[],zone:[2,3],flee:0.5},{name:'ハーゴン',hp:200,mp:50,atk:80,def:60,agi:40,exp:0,gold:0,spells:['begirama','behoimi'],zone:[],boss:true},{name:'シドー',hp:300,mp:99,atk:120,def:80,agi:50,exp:0,gold:0,spells:['ionazun','behoimi'],zone:[],boss:true}];
const TILE_NAMES=['grass','sea','forest','mountain','desert','swamp','town','castle','cave','tower','bridge'];
const WALKABLE=[true,false,true,false,true,true,true,true,true,true,true];
function genWorld(){const W=64,H=64,m=[];for(let y=0;y<H;y++){m[y]=[];for(let x=0;x<W;x++){if(x<2||x>W-3||y<2||y>H-3){m[y][x]=1;continue}const cx=W/2,cy=H/2,d=Math.sqrt((x-cx)**2+(y-cy)**2);if(d>28){m[y][x]=1;continue}if(d>18&&d<22&&y>cy-3&&y<cy+3&&x>cx+5){m[y][x]=1;continue}m[y][x]=0;const n=Math.sin(x*0.8)*Math.cos(y*0.6)*0.5+Math.sin(x*0.3+y*0.4)*0.5;if(n>0.6)m[y][x]=2;if(y>18&&y<26&&x>12&&x<22)m[y][x]=3;if(y>36&&y<42&&x>36&&x<46)m[y][x]=3;if(x>40&&x<52&&y>12&&y<22&&d<28)m[y][x]=4;if(x>26&&x<33&&y>38&&y<44)m[y][x]=5}}
// Locations: all within d<28 from center(32,32) except hargon island
// ローレシア城(12,14) サマルトリア城(16,40) リリザ(22,28) ムーンペタ(28,42)
// ベラヌール(42,18) ペルポイ(48,35) ロンダルキアのほこら(38,10)
m[14][12]=7;m[28][22]=6;m[42][28]=6;m[18][42]=6;m[35][48]=6;m[40][16]=7;m[10][38]=7;
// 湖の洞窟(20,22) ロンの洞窟(45,28) ドラゴンの角(40,40)
m[22][20]=8;m[28][45]=8;m[40][40]=9;
// ハーゴン島 (55,50) - small island only reachable by ship
for(let y=48;y<=53;y++)for(let x=53;x<=58;x++){if(m[y]&&m[y][x]!==undefined)m[y][x]=0}
m[50][55]=9; // ハーゴン神殿
// Bridges
m[14][18]=10;m[14][19]=10;m[40][20]=10;m[40][21]=10;
// Clear paths near start
for(let x=13;x<22;x++)if(m[14][x]===0||m[14][x]===2)m[14][x]=0;
for(let y=14;y<28;y++)if(m[y][22]===0||m[y][22]===2)m[y][22]=0;
// Path south to samaltria
for(let y=28;y<41;y++)if(m[y][16]===3||m[y][16]===2)m[y][16]=0;
return m}
const worldMap=genWorld(),WORLD_W=64,WORLD_H=64;
function getZone(x,y){if(x<25&&y<30)return 0;if(x<40&&y<45)return 1;if(x<50)return 2;return 3}
const GS={TITLE:0,EXPLORE:1,BATTLE:2,MENU:3,DIALOG:4,SHOP:5,GAMEOVER:6,ENDING:7};
class Chara{constructor(id,name,lt){this.id=id;this.name=name;this.lt=lt;this.level=1;this.exp=0;const s=lt[0];this.maxHp=s[1];this.hp=s[1];this.maxMp=s[2];this.mp=s[2];this.str=s[3];this.agi=s[4];this.spells=[...s[5]];this.weapon=null;this.armor=null;this.shield=null;this.helmet=null;this.alive=true;this.status=[];this.atkBuf=0;this.defBuf=0}get atk(){return this.str+(this.weapon!=null?WEAPONS[this.weapon].atk:0)+this.atkBuf}get def(){let d=Math.floor(this.agi/2);if(this.armor!=null)d+=ARMORS[this.armor].def;if(this.shield!=null)d+=SHIELDS[this.shield].def;if(this.helmet!=null)d+=HELMETS[this.helmet].def;return d+this.defBuf}lvUp(){let didLevel=false;while(this.level<this.lt.length){const n=this.lt[this.level];if(this.exp>=n[0]){this.level++;this.maxHp=n[1];this.maxMp=n[2];this.str=n[3];this.agi=n[4];this.hp=this.maxHp;this.mp=this.maxMp;for(const s of n[5])if(!this.spells.includes(s))this.spells.push(s);didLevel=true}else break}return didLevel}}
const G={state:GS.TITLE,keys:{},kp:{},hero:null,prince:null,princess:null,party:[],mapId:'world',px:10,py:10,pdir:0,moveTimer:0,cam:{x:0,y:0},steps:0,gold:50,items:[],flags:{},hasShip:false,shipX:0,shipY:0,onShip:false,visited:[],msgQ:[],msgT:'',msgCb:null,ms:null,bs:null,ss:null,frame:0,maps:{},warps:{},npcs:{},shops:{},chests:{},innPrice:6};
window.addEventListener('keydown',e=>{G.keys[e.code]=true;G.kp[e.code]=true;e.preventDefault()});
window.addEventListener('keyup',e=>{G.keys[e.code]=false});
function kp(c){const r=G.kp[c];G.kp[c]=false;return r}
function kh(c){return G.keys[c]}
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');ctx.imageSmoothingEnabled=false;ctx.scale(3,3);
function dt(t,x,y,s=8,c='#fff'){ctx.fillStyle=c;ctx.font=s+'px monospace';ctx.textAlign='left';ctx.fillText(t,x,y)}
function dtc(t,x,y,s=8,c='#fff'){ctx.fillStyle=c;ctx.font=s+'px monospace';ctx.textAlign='center';ctx.fillText(t,x,y)}
function dw(x,y,w,h){ctx.fillStyle='#000';ctx.fillRect(x,y,w,h);ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.strokeRect(x+1,y+1,w-2,h-2)}
function dc(x,y){ctx.fillStyle='#fff';ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+6,y+4);ctx.lineTo(x,y+8);ctx.fill()}
function showMsg(t,cb){G.msgQ.push({t,cb});if(!G.msgT)nxtMsg()}
function nxtMsg(){if(G.msgQ.length===0){G.msgT='';G.msgCb=null;return}const m=G.msgQ.shift();G.msgT=m.t;G.msgCb=m.cb||null}
function drawMsg(){if(!G.msgT)return;dw(8,SH-56,SW-16,48);const mx=SW-32,ls=[];let l='';ctx.font='8px monospace';for(const ch of G.msgT){if(ctx.measureText(l+ch).width>mx||ch==='\n'){ls.push(l);l=ch==='\n'?'':ch}else l+=ch}if(l)ls.push(l);ctx.fillStyle='#fff';ctx.textAlign='left';for(let i=0;i<Math.min(ls.length,3);i++)ctx.fillText(ls[i],16,SH-42+i*14);if(G.frame%40<20)dt('▼',SW-24,SH-12)}
const INDOOR={5:'wall',6:'floor',7:'stairs_up',8:'stairs_down',9:'chest',10:'chest_open'};
function initMaps(){G.maps.loracia={w:16,h:16,data:mkTown(16,16,'castle'),er:0};G.maps.liriza={w:12,h:12,data:mkTown(12,12,'town'),er:0};G.maps.moonpeta={w:14,h:14,data:mkTown(14,14,'town'),er:0};G.maps.beranule={w:12,h:12,data:mkTown(12,12,'town'),er:0};G.maps.samaltria={w:14,h:14,data:mkTown(14,14,'castle'),er:0};G.maps.perpoi={w:12,h:12,data:mkTown(12,12,'town'),er:0};G.maps.lake_cave={w:16,h:16,data:mkDungeon(16,16),er:16,zone:0};G.maps.ron_cave={w:20,h:20,data:mkDungeon(20,20),er:16,zone:1};G.maps.dragon_horn={w:14,h:14,data:mkDungeon(14,14),er:16,zone:2};G.maps.rhone={w:14,h:14,data:mkTown(14,14,'castle'),er:0};G.maps.hargon={w:16,h:16,data:mkHargon(),er:12,zone:3};
// Place treasure chests in dungeons
placeChest('lake_cave',12,8,{id:8,name:'ラーのかがみ'});
placeChest('lake_cave',4,12,{id:4,name:'ぎんのカギ'});
placeChest('ron_cave',15,15,{id:7,name:'ふねのきっぷ'});
placeChest('ron_cave',5,10,{weapon:3,name:'はやぶさのけん'});
placeChest('dragon_horn',7,12,{armor:4,name:'みずのはごろも'});
placeChest('hargon',2,8,{id:3,name:'せかいじゅのは'});
placeChest('dragon_horn',5,5,{weapon:5,name:'ロトのつるぎ'});
placeChest('hargon',14,8,{armor:5,name:'ロトのよろい'});
// Chest in loracia castle
placeChest('loracia',10,3,{id:0,name:'やくそう',count:3});
G.warps={
'world_12_14':{map:'loracia',x:8,y:14},'loracia_8_15':{map:'world',x:12,y:15},
'world_22_28':{map:'liriza',x:6,y:10},'liriza_6_11':{map:'world',x:22,y:29},
'world_28_42':{map:'moonpeta',x:7,y:12},'moonpeta_7_13':{map:'world',x:28,y:43},
'world_42_18':{map:'beranule',x:6,y:10},'beranule_6_11':{map:'world',x:42,y:19},
'world_16_40':{map:'samaltria',x:7,y:12},'samaltria_7_13':{map:'world',x:16,y:41},
'world_48_35':{map:'perpoi',x:6,y:10},'perpoi_6_11':{map:'world',x:48,y:36},
'world_20_22':{map:'lake_cave',x:8,y:1},'lake_cave_8_0':{map:'world',x:20,y:21},
'world_45_28':{map:'ron_cave',x:10,y:1},'ron_cave_10_0':{map:'world',x:45,y:27},
'world_40_40':{map:'dragon_horn',x:7,y:1},'dragon_horn_7_0':{map:'world',x:40,y:39},
'world_55_50':{map:'hargon',x:8,y:14},'hargon_8_15':{map:'world',x:55,y:51},
'world_38_10':{map:'rhone',x:7,y:12},'rhone_7_13':{map:'world',x:38,y:11}}}
function mkTown(w,h,type){const m=[];for(let y=0;y<h;y++){m[y]=[];for(let x=0;x<w;x++){if(x===0||x===w-1||y===0||y===h-1)m[y][x]=5;else m[y][x]=6}}if(type==='castle'){for(let y=2;y<6;y++)for(let x=3;x<7;x++)m[y][x]=5;m[5][5]=6;m[3][5]=6}m[h-1][Math.floor(w/2)]=6;return m}
function mkDungeon(w,h){const m=[];for(let y=0;y<h;y++){m[y]=[];for(let x=0;x<w;x++)m[y][x]=5}const rs=[];for(let i=0;i<6;i++){const rw=3+Math.floor(Math.random()*3),rh=3+Math.floor(Math.random()*3),rx=1+Math.floor(Math.random()*(w-rw-2)),ry=1+Math.floor(Math.random()*(h-rh-2));rs.push({x:rx,y:ry,w:rw,h:rh});for(let y=ry;y<ry+rh;y++)for(let x=rx;x<rx+rw;x++)m[y][x]=6}
// Connect rooms with corridors
for(let i=0;i<rs.length-1;i++){let cx=rs[i].x+Math.floor(rs[i].w/2),cy=rs[i].y+Math.floor(rs[i].h/2);const tx=rs[i+1].x+Math.floor(rs[i+1].w/2),ty=rs[i+1].y+Math.floor(rs[i+1].h/2);while(cx!==tx){m[cy][cx]=6;cx+=cx<tx?1:-1}while(cy!==ty){m[cy][cx]=6;cy+=cy<ty?1:-1}}
// Entrance at top center
const ex=Math.floor(w/2);m[0][ex]=6;m[1][ex]=6;
// Connect entrance to nearest room
let cx=ex,cy=1;const nr=rs[0];const tx=nr.x+Math.floor(nr.w/2),ty=nr.y+Math.floor(nr.h/2);
while(cx!==tx){m[cy][cx]=6;cx+=cx<tx?1:-1}while(cy!==ty){m[cy][cx]=6;cy+=cy<ty?1:-1}
// Exit at bottom center
m[h-2][ex]=6;m[h-1][ex]=6;
return m}
function placeChest(mapId,x,y,reward){const m=G.maps[mapId];if(!m||!m.data[y])return;m.data[y][x]=9;
// Carve path from chest to entrance using simple L-shaped corridor
const ex=Math.floor(m.w/2),ey=1; // entrance position
let cx=x,cy=y;
// First go horizontally toward entrance column, then vertically toward entrance row
while(cx!==ex){const nx=cx+(cx<ex?1:-1);if(m.data[cy][nx]===5)m.data[cy][nx]=6;cx=nx}
while(cy!==ey){const ny=cy+(cy<ey?1:-1);if(m.data[ny][cx]===5)m.data[ny][cx]=6;cy=ny}
const key=mapId+'_'+x+'_'+y;G.chests[key]=reward}
function openChest(mapId,x,y){const key=mapId+'_'+x+'_'+y;if(G.flags['chest_'+key])return;const r=G.chests[key];if(!r)return;G.flags['chest_'+key]=true;const m=G.maps[mapId];if(m&&m.data[y])m.data[y][x]=10;if(r.id!=null){const ex=G.items.find(it=>it.id===r.id);const cnt=r.count||1;if(ex)ex.count+=cnt;else G.items.push({id:r.id,count:cnt});showMsg('たからばこから\n'+r.name+'を みつけた！')}else if(r.weapon!=null){G.party[0].weapon=r.weapon;showMsg('たからばこから\n'+r.name+'を みつけた！\nそうびした！')}else if(r.armor!=null){G.party[0].armor=r.armor;showMsg('たからばこから\n'+r.name+'を みつけた！\nそうびした！')}}
function useInn(){const cost=G.innPrice*G.party.length;if(G.gold<cost){showMsg('ゴールドが たりない！\n('+cost+'G ひつよう)');return}G.gold-=cost;G.party.forEach(c=>{if(c.alive){c.hp=c.maxHp;c.mp=c.maxMp;c.status=[]}});showMsg('ゆっくり やすんだ。\nHPとMPが かいふくした！\n('+cost+'G)')}
function mkHargon(){const w=16,h=16,m=[];for(let y=0;y<h;y++){m[y]=[];for(let x=0;x<w;x++)m[y][x]=5}
// Entrance corridor
for(let y=13;y>=10;y--)m[y][8]=6;
// Main hall
for(let y=6;y<=10;y++)for(let x=4;x<=12;x++)m[y][x]=6;
// Corridor to Hargon
for(let y=5;y>=3;y--)m[y][8]=6;
// Hargon room
for(let y=2;y<=4;y++)for(let x=6;x<=10;x++)m[y][x]=6;
// Side rooms
for(let y=7;y<=9;y++){for(let x=1;x<=3;x++)m[y][x]=6;for(let x=13;x<=15;x++)m[y][x]=6}
m[8][3]=6;m[8][13]=6;
// Exit
m[14][8]=6;m[15][8]=6;
return m}
function drawMap(){const map=G.mapId==='world'?worldMap:G.maps[G.mapId].data;const mw=G.mapId==='world'?WORLD_W:G.maps[G.mapId].w;const mh=G.mapId==='world'?WORLD_H:G.maps[G.mapId].h;G.cam.x=Math.max(0,Math.min(G.px-Math.floor(COLS/2),mw-COLS));G.cam.y=Math.max(0,Math.min(G.py-Math.floor(ROWS/2),mh-ROWS));for(let sy=0;sy<ROWS+1;sy++)for(let sx=0;sx<COLS+1;sx++){const mx=G.cam.x+sx,my=G.cam.y+sy;if(mx<0||mx>=mw||my<0||my>=mh)continue;const tid=map[my][mx];let tn=G.mapId==='world'?(TILE_NAMES[tid]||'grass'):(INDOOR[tid]||'floor');if(TL[tn])ctx.drawImage(TL[tn],(mx-G.cam.x)*T,(my-G.cam.y)*T)}}
function drawPlayer(){const ds=['down','up','left','right'];const sx=(G.px-G.cam.x)*T,sy=(G.py-G.cam.y)*T;if(G.onShip&&G.mapId==='world'){ctx.fillStyle='#8B4513';ctx.fillRect(sx+1,sy+4,14,10);ctx.fillStyle='#daa520';ctx.fillRect(sx+6,sy+1,2,12);ctx.fillStyle='#fff';ctx.fillRect(sx+8,sy+2,5,4)}const sp='hero_'+ds[G.pdir];if(TL[sp])ctx.drawImage(TL[sp],sx,sy);if(G.hasShip&&!G.onShip&&G.mapId==='world'){const bx=(G.shipX-G.cam.x)*T,by=(G.shipY-G.cam.y)*T;if(bx>-T&&bx<SW&&by>-T&&by<SH){ctx.fillStyle='#8B4513';ctx.fillRect(bx+1,by+4,14,10);ctx.fillStyle='#daa520';ctx.fillRect(bx+6,by+1,2,12)}}}
function tryMove(dx,dy){const nx=G.px+dx,ny=G.py+dy;const map=G.mapId==='world'?worldMap:G.maps[G.mapId].data;const mw=G.mapId==='world'?WORLD_W:G.maps[G.mapId].w;const mh=G.mapId==='world'?WORLD_H:G.maps[G.mapId].h;if(nx<0||nx>=mw||ny<0||ny>=mh)return false;const tid=map[ny][nx];if(G.mapId==='world'){if(tid===1){if(!G.hasShip)return false;if(!G.onShip){if(Math.abs(nx-G.shipX)+Math.abs(ny-G.shipY)>1)return false;G.onShip=true}};if(tid!==1&&G.onShip){G.onShip=false;G.shipX=G.px;G.shipY=G.py}if(tid===3)return false;if(tid!==1&&!WALKABLE[tid])return false}else{if(tid===5)return false}
// NPC collision check - prevent walking onto NPCs
if(G.mapId!=='world'){const npcs=G.npcs[G.mapId];if(npcs&&npcs.some(n=>n.x===nx&&n.y===ny))return false}G.px=nx;G.py=ny;G.steps++;const wk=G.mapId+'_'+nx+'_'+ny;if(G.warps[wk]){const w=G.warps[wk];G.mapId=w.map;G.px=w.x;G.py=w.y;if(w.map!=='world'&&!G.visited.includes(w.map))G.visited.push(w.map);return true}if(G.mapId!=='world'&&tid===9){openChest(G.mapId,nx,ny);return true}
if(G.mapId==='world'&&tid!==6&&tid!==7&&tid!==8&&tid!==9&&tid!==10&&Math.random()*32<1)startBattle();else if(G.mapId!=='world'&&G.maps[G.mapId].er>0&&Math.random()*G.maps[G.mapId].er<1)startBattle();if(G.mapId==='world'&&tid===5)G.party.forEach(c=>{if(c.alive)c.hp=Math.max(1,c.hp-1)});return true}
function startBattle(bossName){const zone=bossName?3:(G.mapId==='world'?getZone(G.px,G.py):(G.maps[G.mapId].zone||0));let pool;if(bossName)pool=MONSTERS.filter(m=>m.name===bossName);else pool=MONSTERS.filter(m=>m.zone.includes(zone));if(pool.length===0)return;const count=bossName?1:1+Math.floor(Math.random()*3);const enemies=[];for(let i=0;i<count;i++){const m=pool[Math.floor(Math.random()*pool.length)];enemies.push({...m,hp:m.hp,maxHp:m.hp,alive:true,status:[]})}G.bs={enemies,cursor:0,spellCursor:0,itemCursor:0,partyActs:[],curActor:0,msg:'まものが あらわれた！',msgTimer:60,phase:'msg',nextPhase:'select',resultMsgs:[],resultIdx:0};G.state=GS.BATTLE}
function updateBattle(){const bs=G.bs;if(!bs)return;if(bs.phase==='msg'){bs.msgTimer--;if(bs.msgTimer<=0||kp('KeyZ')||kp('Enter')){if(bs.nextPhase){bs.phase=bs.nextPhase;bs.nextPhase=null}else bs.phase='select';bs.msg=''}return}if(bs.phase==='start'){bs.phase='select';bs.cursor=0;bs.partyActs=[];bs.curActor=0}if(bs.phase==='select'){const a=G.party[bs.curActor];if(!a||!a.alive){bs.curActor++;if(bs.curActor>=G.party.length){bs.phase='exec';bs.curActor=0}return}if(kp('ArrowUp'))bs.cursor=(bs.cursor-1+4)%4;if(kp('ArrowDown'))bs.cursor=(bs.cursor+1)%4;if(kp('KeyZ')||kp('Enter')){if(bs.cursor===0){bs.partyActs.push({ai:bs.curActor,type:'atk',tgt:0});bs.curActor++;bs.cursor=0}else if(bs.cursor===1){if(a.spells.length>0){bs.phase='spell';bs.spellCursor=0}else{bs.msg='じゅもんを おぼえていない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}}else if(bs.cursor===2){if(G.items.length>0){bs.phase='item';bs.itemCursor=0}else{bs.msg='どうぐがない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}}else if(bs.cursor===3){if(bs.enemies.some(e=>e.boss)){bs.msg='ボスからは にげられない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}else if(Math.random()>0.5){bs.msg='うまく にげきれた！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='end'}else{bs.msg='にげられない！';bs.msgTimer=40;bs.phase='msg';bs.partyActs.push({ai:bs.curActor,type:'def'});bs.curActor++;bs.nextPhase='select'}}}if(bs.curActor>=G.party.length&&bs.phase==='select'){bs.phase='exec';bs.curActor=0}}if(bs.phase==='spell'){const a=G.party[bs.curActor];if(!a){bs.phase='select';return}if(kp('ArrowUp'))bs.spellCursor=Math.max(0,bs.spellCursor-1);if(kp('ArrowDown'))bs.spellCursor=Math.min(a.spells.length-1,bs.spellCursor);if(kp('KeyZ')||kp('Enter')){const sp=SPELLS[a.spells[bs.spellCursor]];if(a.mp<sp.mp){bs.msg='MPが たりない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='spell'}else{bs.partyActs.push({ai:bs.curActor,type:'spell',spell:a.spells[bs.spellCursor],tgt:0});bs.curActor++;bs.spellCursor=0;bs.phase='select'}}if(kp('KeyX')||kp('Escape')){bs.phase='select';bs.cursor=1}}if(bs.phase==='item'){if(kp('ArrowUp'))bs.itemCursor=Math.max(0,bs.itemCursor-1);if(kp('ArrowDown'))bs.itemCursor=Math.min(G.items.length-1,bs.itemCursor);if(kp('KeyZ')||kp('Enter')){bs.partyActs.push({ai:bs.curActor,type:'item',itemId:G.items[bs.itemCursor].id});bs.curActor++;bs.itemCursor=0;bs.phase='select'}if(kp('KeyX')||kp('Escape')){bs.phase='select';bs.cursor=2}}if(bs.phase==='exec')execBattle();if(bs.phase==='result'){bs.msgTimer--;if(bs.msgTimer<=0){if(bs.resultIdx<bs.resultMsgs.length){bs.msg=bs.resultMsgs[bs.resultIdx];bs.resultIdx++;bs.msgTimer=50}else if(kp('KeyZ')||kp('Enter')||bs.msgTimer<-60){const allED=bs.enemies.every(e=>!e.alive),allPD=G.party.every(c=>!c.alive);if(allPD)G.state=GS.GAMEOVER;else if(G.flags.sidoDown)G.state=GS.ENDING;else if(allED)bs.phase='end';else{bs.phase='select';bs.cursor=0;bs.partyActs=[];bs.curActor=0;bs.msg=''}}}}if(bs.phase==='end'){G.state=GS.EXPLORE;G.bs=null;G.party.forEach(c=>{c.atkBuf=0;c.defBuf=0})}}
function execBattle(){const bs=G.bs,acts=[];bs.partyActs.forEach(a=>{const ac=G.party[a.ai];if(ac&&ac.alive)acts.push({...a,agi:ac.agi,isP:true,obj:ac})});bs.enemies.forEach((e,i)=>{if(!e.alive)return;let t='atk';if(e.spells.length>0&&e.mp>0&&Math.random()>0.5)t='spell';acts.push({type:t,ai:i,isP:false,obj:e,agi:e.agi,spell:t==='spell'?e.spells[Math.floor(Math.random()*e.spells.length)]:null,tgt:Math.floor(Math.random()*G.party.length)})});acts.sort((a,b)=>b.agi-a.agi);const ms=[];for(const act of acts){if(act.isP){const a=act.obj;if(!a.alive)continue;if(a.status.includes('sleep')){if(Math.random()>0.5)a.status=a.status.filter(s=>s!=='sleep');ms.push(a.name+'は ねている。');continue}if(act.type==='atk'){const al=bs.enemies.filter(e=>e.alive);if(al.length===0)continue;const t=al[Math.floor(Math.random()*al.length)];const w=a.weapon!=null?WEAPONS[a.weapon]:null;const hits=w&&w.hits?w.hits:1;let td=0;for(let h=0;h<hits;h++){const d=Math.max(1,Math.floor(a.atk-t.def/2+Math.random()*4-2));t.hp-=d;td+=d}ms.push(a.name+'のこうげき！ '+t.name+'に '+td+'ダメージ！');if(t.hp<=0){t.alive=false;ms.push(t.name+'を たおした！')}}else if(act.type==='spell'){const sp=SPELLS[act.spell];a.mp-=sp.mp;if(sp.type==='damage'){const al=bs.enemies.filter(e=>e.alive);al.forEach(e=>{const d=Math.max(1,Math.floor(sp.power+Math.random()*10-e.def/4));e.hp-=d;if(e.hp<=0){e.alive=false;ms.push(e.name+'を たおした！')}});ms.push(a.name+'は '+sp.name+'！')}else if(sp.type==='heal'){const t=G.party.find(c=>c.alive&&c.hp<c.maxHp)||a;t.hp=Math.min(t.maxHp,t.hp+sp.power);ms.push(a.name+'は '+sp.name+'！ '+t.name+'のHPかいふく！')}else if(sp.type==='buff'){if(sp.effect==='def_up'){G.party.forEach(c=>{if(c.alive)c.defBuf+=10});ms.push(a.name+'は '+sp.name+'！ しゅびりょくUP！')}else if(sp.effect==='atk_up'){a.atkBuf+=15;ms.push(a.name+'は '+sp.name+'！ こうげきりょくUP！')}}else if(sp.type==='status'){const al=bs.enemies.filter(e=>e.alive);if(al.length>0){const t=al[Math.floor(Math.random()*al.length)];if(Math.random()>0.3){t.status.push('sleep');ms.push(a.name+'は '+sp.name+'！ '+t.name+'は ねむった！')}else ms.push(a.name+'は '+sp.name+'！ しかし きかなかった！')}}else if(sp.type==='revive'){const t=G.party.find(c=>!c.alive);if(t){t.alive=true;t.hp=t.maxHp;ms.push(a.name+'は '+sp.name+'！ '+t.name+'は いきかえった！')}else ms.push(a.name+'は '+sp.name+'！ しかし だれも たおれていない。')}}else if(act.type==='item'){const itIdx=G.items.findIndex(i=>i.id===act.itemId);if(itIdx>=0){const it=G.items[itIdx];const item=ITEMS[it.id];if(item.type==='heal'){a.hp=Math.min(a.maxHp,a.hp+item.power);ms.push(a.name+'は '+item.name+'を つかった！ HPが '+item.power+' かいふく！');it.count--;if(it.count<=0)G.items.splice(itIdx,1)}else if(item.type==='revive'){const t=G.party.find(c=>!c.alive);if(t){t.alive=true;t.hp=t.maxHp;ms.push(a.name+'は '+item.name+'を つかった！ '+t.name+'は いきかえった！');it.count--;if(it.count<=0)G.items.splice(itIdx,1)}else{ms.push(a.name+'は '+item.name+'を つかった！ しかし こうかがなかった！')}}else{ms.push(a.name+'は '+item.name+'を つかった！ しかし こうかがなかった！')}}}}else{const e=act.obj;if(!e.alive)continue;if(e.flee&&Math.random()<e.flee){e.alive=false;ms.push(e.name+'は にげだした！');continue}if(e.status.includes('sleep')){if(Math.random()>0.5)e.status=e.status.filter(s=>s!=='sleep');ms.push(e.name+'は ねている。');continue}const ap=G.party.filter(c=>c.alive);if(ap.length===0)continue;const t=ap[Math.floor(Math.random()*ap.length)];if(act.type==='atk'){const d=Math.max(1,Math.floor(e.atk-t.def/2+Math.random()*4-2));t.hp-=d;ms.push(e.name+'のこうげき！ '+t.name+'に '+d+'ダメージ！');if(t.hp<=0){t.hp=0;t.alive=false;ms.push(t.name+'は ちからつきた…')}}else if(act.type==='spell'){const sp=SPELLS[act.spell];if(e.mp<sp.mp){const d=Math.max(1,Math.floor(e.atk-t.def/2+Math.random()*4-2));t.hp-=d;ms.push(e.name+'のこうげき！ '+t.name+'に '+d+'ダメージ！');if(t.hp<=0){t.hp=0;t.alive=false;ms.push(t.name+'は ちからつきた…')}}else{e.mp-=sp.mp;if(sp.type==='damage'){ap.forEach(c=>{const d=Math.max(1,Math.floor(sp.power+Math.random()*8-c.def/4));c.hp-=d;if(c.hp<=0){c.hp=0;c.alive=false;ms.push(c.name+'は ちからつきた…')}});ms.push(e.name+'は '+sp.name+'！')}else if(sp.type==='heal'){e.hp=Math.min(e.maxHp,e.hp+sp.power);ms.push(e.name+'は '+sp.name+'！ HPかいふく！')}}}}}const allED=bs.enemies.every(e=>!e.alive),allPD=G.party.every(c=>!c.alive);if(allED){let te=0,tg=0;bs.enemies.forEach(e=>{te+=e.exp;tg+=e.gold});G.gold+=tg;ms.push('かった！ '+te+'EXP '+tg+'G かくとく！');G.party.forEach(c=>{if(!c.alive)return;c.exp+=te;if(c.lvUp())ms.push(c.name+' Lv'+c.level+'に UP！')});bs.enemies.forEach(e=>{if(e.name==='ハーゴン')G.flags.hargonDown=true;if(e.name==='シドー'){G.flags.sidoDown=true;ms.push('へいわが おとずれた…！')}})}if(allPD)ms.push('ぜんめつ…');bs.phase='result';bs.resultMsgs=ms;bs.resultIdx=0;bs.msgTimer=0}
function drawBattle(){const bs=G.bs;if(!bs)return;ctx.fillStyle='#111';ctx.fillRect(0,0,SW,SH);const al=bs.enemies.filter(e=>e.alive);al.forEach((e,i)=>{const ex=SW/(al.length+1)*(i+1),ey=60;ctx.fillStyle=e.boss?'#a00':'#c80';ctx.fillRect(ex-12,ey-12,24,24);ctx.fillStyle='#fff';ctx.fillRect(ex-6,ey-6,4,4);ctx.fillRect(ex+2,ey-6,4,4);ctx.fillStyle='#000';ctx.fillRect(ex-4,ey+2,8,2);dtc(e.name,ex,ey+22,6);dtc('HP'+e.hp,ex,ey+30,5,'#0f0')});dw(SW-120,SH-100,112,92);G.party.forEach((c,i)=>{const y=SH-92+i*28;dt(c.name.slice(0,4),SW-112,y,6,c.alive?'#fff':'#888');dt('HP'+c.hp+'/'+c.maxHp,SW-112,y+10,6,c.hp<c.maxHp/4?'#f00':'#0f0');dt('MP'+c.mp+'/'+c.maxMp,SW-112,y+18,6,'#0af')});if(bs.phase==='select'){const a=G.party[bs.curActor];if(a){dw(8,SH-80,80,72);dt(a.name.slice(0,5),16,SH-70,6,'#ffd700');['たたかう','じゅもん','どうぐ','にげる'].forEach((c,i)=>dt(c,24,SH-56+i*14,7));dc(14,SH-63+bs.cursor*14)}}if(bs.phase==='spell'){const a=G.party[bs.curActor];if(a){dw(8,8,120,a.spells.length*14+20);dt('じゅもん',16,24,7,'#ffd700');a.spells.forEach((sp,i)=>{const s=SPELLS[sp];dt((i===bs.spellCursor?'▶':' ')+s.name+' '+s.mp,16,38+i*14,7)})}}if(bs.phase==='item'){dw(8,8,140,G.items.length*14+20);dt('どうぐ',16,24,7,'#ffd700');G.items.forEach((it,i)=>{dt((i===bs.itemCursor?'▶':' ')+ITEMS[it.id].name,16,38+i*14,7)})}if(bs.msg){dw(8,SH-40,SW-16,32);dt(bs.msg,16,SH-22,7)}}
function updateMenu(){const ms=G.ms;if(!ms)return;if(ms.pg==='main'){const it=['はなす','じゅもん','どうぐ','つよさ','そうび','さくせん','とじる'];if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+it.length)%it.length;if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%it.length;if(kp('KeyZ')||kp('Enter')){switch(ms.cursor){case 0:G.state=GS.EXPLORE;checkInteraction();break;case 1:ms.pg='spell';ms.cursor=0;ms.ci=0;break;case 2:ms.pg='item';ms.cursor=0;break;case 3:ms.pg='status';ms.ci=0;break;case 4:ms.pg='equip';ms.cursor=0;ms.ci=0;break;case 5:ms.pg='sakusen';ms.cursor=0;break;case 6:G.state=GS.EXPLORE;break}}if(kp('KeyX')||kp('Escape'))G.state=GS.EXPLORE}else if(ms.pg==='status'){if(kp('KeyX')||kp('Escape')||kp('KeyZ'))ms.pg='main';if(kp('ArrowLeft'))ms.ci=(ms.ci-1+G.party.length)%G.party.length;if(kp('ArrowRight'))ms.ci=(ms.ci+1)%G.party.length}else if(ms.pg==='item'){if(kp('ArrowUp'))ms.cursor=Math.max(0,ms.cursor-1);if(kp('ArrowDown'))ms.cursor=Math.min(G.items.length-1,ms.cursor);if(kp('KeyZ')||kp('Enter')){if(G.items.length>0)useItem(ms.cursor)}if(kp('KeyX')||kp('Escape'))ms.pg='main'}else if(ms.pg==='spell'){const c=G.party[ms.ci];if(kp('ArrowUp'))ms.cursor=Math.max(0,ms.cursor-1);if(kp('ArrowDown'))ms.cursor=Math.min(c.spells.length-1,ms.cursor);if(kp('ArrowLeft')){ms.ci=(ms.ci-1+G.party.length)%G.party.length;ms.cursor=0}if(kp('ArrowRight')){ms.ci=(ms.ci+1)%G.party.length;ms.cursor=0}if(kp('KeyZ')||kp('Enter')){if(c.spells.length>0)useFieldSpell(c,c.spells[ms.cursor])}if(kp('KeyX')||kp('Escape'))ms.pg='main'}else if(ms.pg==='equip'){const c=G.party[ms.ci];if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+4)%4;if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%4;if(kp('ArrowLeft')){ms.ci=(ms.ci-1+G.party.length)%G.party.length;ms.cursor=0}if(kp('ArrowRight')){ms.ci=(ms.ci+1)%G.party.length;ms.cursor=0}if(kp('KeyZ')||kp('Enter')){if(ms.cursor===0&&c.weapon!=null){c.weapon=null;showMsg('ぶきを はずした。');G.state=GS.EXPLORE}else if(ms.cursor===1&&c.armor!=null){c.armor=null;showMsg('よろいを はずした。');G.state=GS.EXPLORE}else if(ms.cursor===2&&c.shield!=null){c.shield=null;showMsg('たてを はずした。');G.state=GS.EXPLORE}else if(ms.cursor===3&&c.helmet!=null){c.helmet=null;showMsg('かぶとを はずした。');G.state=GS.EXPLORE}}if(kp('KeyX')||kp('Escape'))ms.pg='main'}
else if(ms.pg==='sakusen'){
if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+3)%3;
if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%3;
if(kp('KeyZ')||kp('Enter')){
if(ms.cursor===0){saveGame();G.state=GS.EXPLORE}
else if(ms.cursor===1){ms.pg='jumon_show';ms.jumon=encodeJumon()}
else{ms.pg='main';ms.cursor=5}
}if(kp('KeyX')||kp('Escape')){ms.pg='main';ms.cursor=5}
}else if(ms.pg==='jumon_show'){
if(kp('KeyZ')||kp('Enter')||kp('KeyX')||kp('Escape')){ms.pg='sakusen';ms.cursor=1}
}else if(ms.pg==='jumon_input'){
if(!ms.inputBuf)ms.inputBuf='';
if(!ms.jcursor)ms.jcursor={x:0,y:0};
const jc=JUMON_CHARS;const cols=10;const rows=Math.ceil(jc.length/cols);
if(kp('ArrowRight'))ms.jcursor.x=Math.min(cols-1,ms.jcursor.x+1);
if(kp('ArrowLeft'))ms.jcursor.x=Math.max(0,ms.jcursor.x-1);
if(kp('ArrowDown'))ms.jcursor.y=Math.min(rows,ms.jcursor.y+1);
if(kp('ArrowUp'))ms.jcursor.y=Math.max(0,ms.jcursor.y-1);
if(kp('KeyZ')||kp('Enter')){
if(ms.jcursor.y===rows){
// けってい row
const data=decodeJumon(ms.inputBuf);
if(data){applyJumon(data);showMsg('ふっかつのじゅもんを うけつけた！')}
else showMsg('じゅもんが ちがいます。');
ms.pg='main';ms.cursor=0;
}else{
const idx=ms.jcursor.y*cols+ms.jcursor.x;
if(idx<jc.length)ms.inputBuf+=jc[idx];
}}
if(kp('KeyX')||kp('Escape')){
if(ms.inputBuf.length>0)ms.inputBuf=ms.inputBuf.slice(0,-1);
else{ms.pg='sakusen';ms.cursor=1}
}}
}
function drawMenu(){const ms=G.ms;if(!ms)return;if(ms.pg==='main'){dw(8,8,80,120);['はなす','じゅもん','どうぐ','つよさ','そうび','さくせん','とじる'].forEach((t,i)=>dt(t,24,24+i*14));dc(14,17+ms.cursor*14);dw(96,8,152,40*G.party.length);G.party.forEach((c,i)=>{const y=20+i*36;dt(c.name.slice(0,6),104,y,7);dt('HP'+c.hp+'/'+c.maxHp,104,y+12,7);dt('MP'+c.mp+'/'+c.maxMp,104,y+22,7);dt('Lv'+c.level,180,y,7)})}else if(ms.pg==='status'){const c=G.party[ms.ci];dw(8,8,240,200);dt('< '+c.name+' >',16,26,8,'#ffd700');dt('レベル: '+c.level,16,44);dt('HP: '+c.hp+'/'+c.maxHp,16,58);dt('MP: '+c.mp+'/'+c.maxMp,16,72);dt('ちから: '+c.str,16,86);dt('すばやさ: '+c.agi,16,100);dt('こうげき力: '+c.atk,16,114);dt('しゅび力: '+c.def,16,128);dt('EXP: '+c.exp,16,142);const nx=c.level<c.lt.length?c.lt[c.level][0]-c.exp:'---';dt('つぎのLvまで: '+nx,16,156);dt('←→ キャラ切替 Z/Escで戻る',16,190,6,'#888')}else if(ms.pg==='item'){dw(8,8,200,180);dt('どうぐ',16,26,8,'#ffd700');if(G.items.length===0)dt('なにも もっていない',16,44);G.items.forEach((it,i)=>{dt((i===ms.cursor?'▶':'  ')+ITEMS[it.id].name+(it.count>1?' x'+it.count:''),16,44+i*14,7)});dt('G: '+G.gold,16,170,7,'#ffd700')}else if(ms.pg==='spell'){const c=G.party[ms.ci];dw(8,8,200,180);dt(c.name+'のじゅもん',16,26,8,'#ffd700');if(c.spells.length===0)dt('おぼえていない',16,44);c.spells.forEach((sp,i)=>{const s=SPELLS[sp];dt((i===ms.cursor?'▶':'  ')+s.name+' MP'+s.mp,16,44+i*14,7)});dt('←→ キャラ切替',16,170,6,'#888')}else if(ms.pg==='equip'){const c=G.party[ms.ci];dw(8,8,240,150);dt(c.name+'のそうび',16,26,8,'#ffd700');dt((ms.cursor===0?'▶':' ')+'ぶき: '+(c.weapon!=null?WEAPONS[c.weapon].name:'なし'),16,44);dt((ms.cursor===1?'▶':' ')+'よろい: '+(c.armor!=null?ARMORS[c.armor].name:'なし'),16,58);dt((ms.cursor===2?'▶':' ')+'たて: '+(c.shield!=null?SHIELDS[c.shield].name:'なし'),16,72);dt((ms.cursor===3?'▶':' ')+'かぶと: '+(c.helmet!=null?HELMETS[c.helmet].name:'なし'),16,86);dt('Z:はずす ←→:キャラ切替',16,110,6,'#888');dt('X:もどる',16,122,6,'#888')}
else if(ms.pg==='sakusen'){
dw(8,8,140,66);dt('さくせん',16,26,8,'#ffd700');
['きろくする','ふっかつのじゅもん','もどる'].forEach((t,i)=>dt((i===ms.cursor?'▶':' ')+t,16,42+i*14,7));
}else if(ms.pg==='jumon_show'){
dw(4,4,248,232);dt('ふっかつのじゅもん',16,24,8,'#ffd700');
dt('この じゅもんを ひかえよ！',16,42,7);
const j=ms.jumon||'';
for(let i=0;i<j.length;i++){
const row=Math.floor(i/14),col=i%14;
dt(j[i],16+col*16,66+row*18,8,'#0f0');
}dt('Z/Escで もどる',16,218,6,'#888');
}else if(ms.pg==='jumon_input'){
dw(4,4,248,232);dt('ふっかつのじゅもんを いれよ',16,22,7,'#ffd700');
// Show input buffer
dw(8,32,240,24);dt(ms.inputBuf||'',14,48,8,'#0f0');
// Kana grid
const jc=JUMON_CHARS,cols=10;
for(let i=0;i<jc.length;i++){
const r=Math.floor(i/cols),c=i%cols;
const sel=ms.jcursor&&ms.jcursor.y===r&&ms.jcursor.x===c;
dt(jc[i],14+c*22,76+r*16,8,sel?'#ff0':'#fff');
}
// けってい button
const rows=Math.ceil(jc.length/cols);
const selK=ms.jcursor&&ms.jcursor.y===rows;
dt('けってい',14,76+rows*16,8,selK?'#ff0':'#fff');
dt('X:1文字けす Esc:もどる',14,218,5,'#888');
}}
function useItem(idx){if(idx>=G.items.length)return;const it=G.items[idx],item=ITEMS[it.id];if(item.type==='heal'){const c=G.party.find(c=>c.alive&&c.hp<c.maxHp);if(c){c.hp=Math.min(c.maxHp,c.hp+item.power);it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(c.name+'のHP '+item.power+' かいふく！')}else showMsg('つかう ひつようが ない。')}else if(item.type==='cure'){const c=G.party.find(c=>c.alive&&c.status.includes(item.cure));if(c){c.status=c.status.filter(s=>s!==item.cure);it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(item.cure+'が なおった！')}else showMsg('つかう ひつようが ない。')}else if(item.type==='revive'){const c=G.party.find(c=>!c.alive);if(c){c.alive=true;c.hp=c.maxHp;it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(c.name+'は いきかえった！')}else showMsg('つかう ひつようが ない。')}else if(item.type==='field'&&item.effect==='ruura'){if(G.visited.length===0){showMsg('まだ町を訪れていない。');return}it.count--;if(it.count<=0)G.items.splice(idx,1);G.mapId='world';G.px=12;G.py=15;G.state=GS.EXPLORE;showMsg('キメラのつばさを つかった！')}else if(item.type==='stat'){const c=G.party[0];if(c){c[item.stat]=(c[item.stat]||0)+item.value;if(item.stat==='maxHp')c.hp=Math.min(c.hp+item.value,c.maxHp);if(item.stat==='maxMp')c.mp=Math.min(c.mp+item.value,c.maxMp);it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(item.name+'を つかった！')}else showMsg('つかえない。')}else showMsg('ここでは つかえない。')}
function useFieldSpell(caster,sid){const s=SPELLS[sid];if(caster.mp<s.mp){showMsg('MPが たりない！');return}if(s.type==='heal'){const t=G.party.find(c=>c.alive&&c.hp<c.maxHp);if(!t){showMsg('つかう ひつようがない。');return}caster.mp-=s.mp;t.hp=Math.min(t.maxHp,t.hp+s.power);G.state=GS.EXPLORE;showMsg(caster.name+'は '+s.name+'！\n'+t.name+'のHP '+s.power+' かいふく！')}else if(s.type==='revive'){const t=G.party.find(c=>!c.alive);if(!t){showMsg('つかう ひつようがない。');return}caster.mp-=s.mp;t.alive=true;t.hp=t.maxHp;G.state=GS.EXPLORE;showMsg(caster.name+'は '+s.name+'！\n'+t.name+'は いきかえった！')}else if(sid==='ruura'){if(G.visited.length===0){showMsg('まだ町を訪れていない。');return}caster.mp-=s.mp;G.mapId='world';G.px=12;G.py=15;G.state=GS.EXPLORE;showMsg(caster.name+'は ルーラ！')}else if(sid==='riremito'){if(G.mapId==='world'){showMsg('ここでは つかえない。');return}caster.mp-=s.mp;G.mapId='world';G.state=GS.EXPLORE;showMsg(caster.name+'は リレミト！')}else showMsg('ここでは つかえない。')}
function initNPCs(){G.npcs={loracia:[{x:5,y:3,name:'ローレシア王',msg:'ローレシア王「サマルトリアの王子を\n仲間にするのじゃ！\n南西のサマルトリア城を訪ねよ。」'},{x:10,y:8,name:'兵士',msg:'兵士「東にリリザの町があります。\n南の湖のほこらには\n大切なものがあるそうです。」'},{x:3,y:8,name:'宿屋',msg:'inn',inn:true}],liriza:[{x:4,y:5,name:'商人',msg:'商人「ここはリリザだよ。」',shop:true},{x:8,y:3,name:'女性',msg:'女性「サマルトリアの王子は\n旅に出たらしいわよ。\nサマルトリア城にいるみたい。」'},{x:2,y:8,name:'宿屋',msg:'inn',inn:true}],samaltria:[{x:7,y:3,name:'サマルトリア王',msg:'サマルトリア王「うちの王子が\nお前を探していたぞ。\nこの城のどこかにいるはず。」'},{x:5,y:8,name:'サマルトリアのおうじ',recruit:'prince',msg:'サマルトリアのおうじ「おお！\nぼくも つれていってください！」'},{x:10,y:8,name:'宿屋',msg:'inn',inn:true}],moonpeta:[{x:5,y:5,name:'老人',msg:'老人「この町の東に犬がいるだろう？\nあれは ムーンブルクの王女\nなのじゃ。ラーのかがみが\nあれば 元の姿にもどせるぞ。」'},{x:9,y:7,name:'犬',recruit:'princess',msg:'犬「ワン！ワン！」\nラーのかがみを つかった！'},{x:3,y:9,name:'道具屋',msg:'道具屋「いらっしゃい！」',shop:true},{x:3,y:3,name:'宿屋',msg:'inn',inn:true}],beranule:[{x:4,y:5,name:'船乗り',msg:'船乗り「船が欲しいのか？\nふねのきっぷを持ってきな！」',giveShip:true},{x:8,y:3,name:'道具屋',msg:'道具屋「いらっしゃい！」',shop:true},{x:8,y:8,name:'宿屋',msg:'inn',inn:true}],perpoi:[{x:4,y:5,name:'学者',msg:'学者「ロンダルキアへの洞窟は\n北西にある。\n強い装備が必要じゃ。\nハーゴンの神殿は東の果てに。」'},{x:8,y:3,name:'道具屋',msg:'道具屋「いらっしゃい！」',shop:true},{x:2,y:8,name:'宿屋',msg:'inn',inn:true}],rhone:[{x:7,y:5,name:'神官',msg:'神官「ここはロンダルキアのほこら。\nハーゴン神殿は東の果てにある。\n気をつけてゆくのじゃ。」'},{x:5,y:5,name:'宿屋',msg:'inn',inn:true}]};G.shops={liriza:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:0,p:10},{id:1,p:100}],armors:[{id:0,p:30},{id:1,p:80}]},moonpeta:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:2,p:500},{id:7,p:200}],armors:[{id:2,p:300}]},beranule:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:2,p:500},{id:6,p:300}],armors:[{id:3,p:700}]},perpoi:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:4,p:3500}],armors:[{id:4,p:3000}]}}}
function checkInteraction(){const dirs=[[0,1],[0,-1],[-1,0],[1,0]];const d=dirs[G.pdir],tx=G.px+d[0],ty=G.py+d[1];if(G.mapId==='world')return;const npcs=G.npcs[G.mapId];if(!npcs)return;for(const npc of npcs){if(npc.x===tx&&npc.y===ty){if(npc.inn){useInn();return}if(npc.recruit==='prince'&&!G.prince&&!G.flags.princeJoined){G.flags.princeJoined=true;G.prince=new Chara(1,'サマルトリアのおうじ',PRINCE_LV);G.prince.weapon=0;G.prince.armor=0;G.party.push(G.prince);showMsg(npc.msg,()=>showMsg('サマルトリアのおうじ が なかまになった！'));return}if(npc.recruit==='princess'&&!G.princess&&!G.flags.princessJoined){if(G.items.some(it=>it.id===8)){G.flags.princessJoined=true;G.princess=new Chara(2,'ムーンブルクのおうじょ',PRINCESS_LV);G.princess.weapon=7;G.princess.armor=0;G.party.push(G.princess);const ki=G.items.findIndex(it=>it.id===8);if(ki>=0)G.items.splice(ki,1);showMsg('ラーのかがみを つかった！\n犬の姿が みるみる変わっていく…',()=>showMsg('ムーンブルクのおうじょ が なかまになった！'));return}else{showMsg('犬「ワン！ ワン！」\n（ラーのかがみが あれば…）');return}}if(npc.giveShip){if(G.items.some(it=>it.id===7)){G.hasShip=true;
// Find nearest sea tile to beranule exit
let sx=42,sy=20,found=false;
for(let r=1;r<10&&!found;r++)for(let dy=-r;dy<=r&&!found;dy++)for(let dx=-r;dx<=r&&!found;dx++){
if(Math.abs(dx)===r||Math.abs(dy)===r){const nx=42+dx,ny=19+dy;if(nx>=0&&nx<64&&ny>=0&&ny<64&&worldMap[ny][nx]===1){sx=nx;sy=ny;found=true}}}
G.shipX=sx;G.shipY=sy;G.items=G.items.filter(it=>it.id!==7);showMsg('船乗り「おお きっぷを持っているな！\nこの船を つかいな！」',()=>showMsg('船を てにいれた！'));return}else{showMsg('船乗り「船が欲しいのか？\nふねのきっぷを持ってきな！\n東の洞窟にあるらしいぞ。」');return}}if(npc.shop&&G.shops[G.mapId]){enterShop();return}showMsg(npc.msg);return}}showMsg('だれもいない。')}
function enterShop(){const s=G.shops[G.mapId];if(!s)return;G.state=GS.SHOP;G.ss={pg:'main',cursor:0,items:s.items||[],weapons:s.weapons||[],armors:s.armors||[]}}
function updateShop(){const ss=G.ss;if(!ss)return;if(ss.pg==='main'){if(kp('ArrowUp'))ss.cursor=(ss.cursor-1+4)%4;if(kp('ArrowDown'))ss.cursor=(ss.cursor+1)%4;if(kp('KeyZ')||kp('Enter')){if(ss.cursor===0){ss.pg='buy_item';ss.cursor=0}else if(ss.cursor===1){ss.pg='buy_weapon';ss.cursor=0}else if(ss.cursor===2){ss.pg='buy_armor';ss.cursor=0}else{G.state=GS.EXPLORE;G.ss=null}}if(kp('KeyX')||kp('Escape')){G.state=GS.EXPLORE;G.ss=null}}else{let list;if(ss.pg==='buy_item')list=ss.items;else if(ss.pg==='buy_weapon')list=ss.weapons;else list=ss.armors;if(kp('ArrowUp'))ss.cursor=Math.max(0,ss.cursor-1);if(kp('ArrowDown'))ss.cursor=Math.min(list.length-1,ss.cursor);if(kp('KeyZ')||kp('Enter')){if(list.length>0){const it=list[ss.cursor];if(G.gold>=it.p){G.gold-=it.p;if(ss.pg==='buy_item'){const ex=G.items.find(i=>i.id===it.id);if(ex)ex.count++;else G.items.push({id:it.id,count:1});showMsg(ITEMS[it.id].name+'を かった！')}else if(ss.pg==='buy_weapon'){const w=WEAPONS[it.id];const tgt=G.party.find(c=>c.alive&&w.who.includes(c.id))||G.party[0];tgt.weapon=it.id;showMsg(w.name+'を かった！\n'+tgt.name+'が そうびした！')}else{const a=ARMORS[it.id];const tgt=G.party.find(c=>c.alive&&a.who.includes(c.id))||G.party[0];tgt.armor=it.id;showMsg(a.name+'を かった！\n'+tgt.name+'が そうびした！')}}else showMsg('ゴールドが たりない！')}}if(kp('KeyX')||kp('Escape')){ss.pg='main';ss.cursor=0}}}
function drawShop(){const ss=G.ss;if(!ss)return;if(ss.pg==='main'){dw(8,8,120,80);dt('おみせ  G:'+G.gold,16,26,7,'#ffd700');['どうぐ','ぶき','よろい','やめる'].forEach((t,i)=>dt((i===ss.cursor?'▶':' ')+t,16,42+i*14,7))}else{let list,names;if(ss.pg==='buy_item'){list=ss.items;names=list.map(i=>ITEMS[i.id].name)}else if(ss.pg==='buy_weapon'){list=ss.weapons;names=list.map(i=>WEAPONS[i.id].name)}else{list=ss.armors;names=list.map(i=>ARMORS[i.id].name)}dw(8,8,200,list.length*14+40);dt('G: '+G.gold,16,26,7,'#ffd700');list.forEach((it,i)=>dt((i===ss.cursor?'▶':' ')+names[i]+' '+it.p+'G',16,42+i*14,7));dt('Xで もどる',16,list.length*14+42,6,'#888')}}
function drawNPCs(){if(G.mapId==='world')return;const npcs=G.npcs[G.mapId];if(!npcs)return;const npcColors={'ローレシア王':'#c00','サマルトリア王':'#00c','船乗り':'#a52','老人':'#888','学者':'#448','神官':'#fff','犬':'#a80','宿屋':'#0a8','兵士':'#888'};npcs.forEach(npc=>{const sx=(npc.x-G.cam.x)*T,sy=(npc.y-G.cam.y)*T;if(sx<-T||sx>SW||sy<-T||sy>SH)return;if(npc.name==='犬'){ctx.fillStyle='#a60';ctx.fillRect(sx+4,sy+8,8,4);ctx.fillRect(sx+4,sy+12,2,3);ctx.fillRect(sx+10,sy+12,2,3);ctx.fillRect(sx+3,sy+6,4,3);ctx.fillStyle='#000';ctx.fillRect(sx+4,sy+7,1,1);ctx.fillStyle='#a60';ctx.fillRect(sx+11,sy+9,2,1);return}const col=npcColors[npc.name]||'#fa0';ctx.fillStyle='#fdb';ctx.fillRect(sx+5,sy+2,6,4);ctx.fillStyle='#000';ctx.fillRect(sx+6,sy+3,1,1);ctx.fillRect(sx+9,sy+3,1,1);ctx.fillStyle=col;ctx.fillRect(sx+4,sy+6,8,5);ctx.fillRect(sx+3,sy+7,1,3);ctx.fillRect(sx+12,sy+7,1,3);ctx.fillRect(sx+5,sy+11,2,3);ctx.fillRect(sx+9,sy+11,2,3);if(npc.name.includes('王')){ctx.fillStyle='#ffd700';ctx.fillRect(sx+5,sy+0,6,2);ctx.fillRect(sx+5,sy+0,1,1);ctx.fillRect(sx+7,sy+0,1,1);ctx.fillRect(sx+10,sy+0,1,1)}else{ctx.fillStyle='#531';ctx.fillRect(sx+5,sy+1,6,1)}})}
function drawTitle(){ctx.fillStyle='#000';ctx.fillRect(0,0,SW,SH);dtc('ドラゴンクエストII',SW/2,60,12,'#ffd700');dtc('～悪霊の神々～',SW/2,78,8,'#ffd700');ctx.strokeStyle='#ffd700';ctx.lineWidth=1;ctx.beginPath();ctx.arc(SW/2,120,30,0,Math.PI*2);ctx.stroke();ctx.beginPath();ctx.moveTo(SW/2,90);ctx.lineTo(SW/2+26,135);ctx.lineTo(SW/2-26,135);ctx.closePath();ctx.stroke();dtc('ぼうけんをはじめる',SW/2,166,8);dtc('ぼうけんのしょ',SW/2,182,8);dtc('ふっかつのじゅもん',SW/2,198,8);
const tc=G.ms?G.ms.cursor||0:0;
if(G.frame%40<20)dc(SW/2-66,159+tc*16);
if(kp('Enter')||kp('Space')||kp('KeyZ')){
if(tc===0)newGame();
else if(tc===1)loadGame();
else{G.state=GS.MENU;G.ms={pg:'jumon_input',cursor:0,ci:0,inputBuf:'',jcursor:{x:0,y:0}}}
}
if(kp('ArrowDown')){if(!G.ms)G.ms={cursor:0};G.ms.cursor=Math.min(2,(G.ms.cursor||0)+1)}
if(kp('ArrowUp')){if(!G.ms)G.ms={cursor:0};G.ms.cursor=Math.max(0,(G.ms.cursor||0)-1)};dtc('Z/Enter: けってい  矢印: いどう',SW/2,220,6,'#888')}
function newGame(){G.hero=new Chara(0,'ローレシアのおうじ',HERO_LV);G.hero.weapon=1;G.hero.armor=1;G.party=[G.hero];G.gold=50;G.items=[{id:0,count:3}];G.mapId='world';G.px=12;G.py=15;G.pdir=0;G.flags={};G.visited=['loracia'];G.prince=null;G.princess=null;G.hasShip=false;G.onShip=false;G.chests={};initMaps();initNPCs();G.state=GS.DIALOG;showMsg('ローレシア王「おお ローレシアのおうじよ！\n魔王ハーゴンを倒す旅に出るのじゃ！」',()=>{showMsg('ローレシア王「サマルトリアの王子を\n仲間にするのじゃ！\n南のサマルトリア城を訪ねよ。」',()=>{G.state=GS.EXPLORE})})}
// ===== FUKKATSU NO JUMON (Revival Password) =====
const JUMON_CHARS='あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
function encodeJumon(){
const d=[];
// Hero level (4bit), prince level (4bit), princess level (4bit)
d.push(G.hero?G.hero.level:0);
d.push(G.prince?G.prince.level:0);
d.push(G.princess?G.princess.level:0);
// Gold (16bit, max 65535)
const g=Math.min(G.gold,65535);
d.push(g>>8);d.push(g&0xFF);
// Hero exp (16bit)
const he=G.hero?Math.min(G.hero.exp,65535):0;
d.push(he>>8);d.push(he&0xFF);
// Prince exp (16bit)
const pe=G.prince?Math.min(G.prince.exp,65535):0;
d.push(pe>>8);d.push(pe&0xFF);
// Princess exp (16bit)
const pre=G.princess?Math.min(G.princess.exp,65535):0;
d.push(pre>>8);d.push(pre&0xFF);
// Flags (8bit): princeJoined, princessJoined, hasShip, hargonDown, key items...
let flags=0;
if(G.flags.princeJoined)flags|=1;
if(G.flags.princessJoined)flags|=2;
if(G.hasShip)flags|=4;
if(G.flags.hargonDown)flags|=8;
if(G.items.some(it=>it.id===4))flags|=16; // ぎんのカギ
if(G.items.some(it=>it.id===5))flags|=32; // きんのカギ
if(G.items.some(it=>it.id===8))flags|=64; // ラーのかがみ
d.push(flags);
// Equipment: hero weapon(4bit)+armor(4bit)
const hw=G.hero&&G.hero.weapon!=null?G.hero.weapon+1:0;
const ha=G.hero&&G.hero.armor!=null?G.hero.armor+1:0;
d.push((hw<<4)|ha);
// Items count: yakusou (4bit)
const yc=G.items.find(it=>it.id===0);
d.push(yc?Math.min(yc.count,15):0);
// Checksum
let cs=0;for(const v of d)cs=(cs+v)&0xFF;
d.push(cs);
// Encode to kana: each byte -> 2 chars (high nibble + low nibble) using base-46
const jc=JUMON_CHARS;
let s='';
for(const v of d){s+=jc[Math.floor(v/46)%46];s+=jc[v%46]}
return s;
}
function decodeJumon(s){
const jc=JUMON_CHARS;
const clean=s.replace(/[\s　]/g,'');
if(clean.length<28)return null;
const d=[];
for(let i=0;i<clean.length;i+=2){
const hi=jc.indexOf(clean[i]),lo=jc.indexOf(clean[i+1]);
if(hi<0||lo<0)return null;
d.push(hi*46+lo);
}
// Verify checksum
const cs=d.pop();
let ck=0;for(const v of d)ck=(ck+v)&0xFF;
if(ck!==cs)return null;
// Decode
const heroLv=d[0],princeLv=d[1],princessLv=d[2];
const gold=(d[3]<<8)|d[4];
const heroExp=(d[5]<<8)|d[6];
const princeExp=(d[7]<<8)|d[8];
const princessExp=(d[9]<<8)|d[10];
const flags=d[11];
const hw=d[12]>>4,ha=d[12]&0xF;
const yakusou=d[13];
return{heroLv,princeLv,princessLv,gold,heroExp,princeExp,princessExp,flags,hw,ha,yakusou};
}
function applyJumon(data){
G.hero=new Chara(0,'ローレシアのおうじ',HERO_LV);
G.hero.level=1;G.hero.exp=0;
while(G.hero.level<data.heroLv&&G.hero.level<HERO_LV.length)
{G.hero.level++;const s=HERO_LV[G.hero.level-1];G.hero.maxHp=s[1];G.hero.maxMp=s[2];G.hero.str=s[3];G.hero.agi=s[4];for(const sp of s[5])if(!G.hero.spells.includes(sp))G.hero.spells.push(sp)}
G.hero.hp=G.hero.maxHp;G.hero.mp=G.hero.maxMp;G.hero.exp=data.heroExp;
if(data.hw>0)G.hero.weapon=data.hw-1;
if(data.ha>0)G.hero.armor=data.ha-1;
G.party=[G.hero];G.prince=null;G.princess=null;
if(data.flags&1){
G.prince=new Chara(1,'サマルトリアのおうじ',PRINCE_LV);
G.prince.level=1;
while(G.prince.level<data.princeLv&&G.prince.level<PRINCE_LV.length)
{G.prince.level++;const s=PRINCE_LV[G.prince.level-1];G.prince.maxHp=s[1];G.prince.maxMp=s[2];G.prince.str=s[3];G.prince.agi=s[4];for(const sp of s[5])if(!G.prince.spells.includes(sp))G.prince.spells.push(sp)}
G.prince.hp=G.prince.maxHp;G.prince.mp=G.prince.maxMp;G.prince.exp=data.princeExp;
G.party.push(G.prince);G.flags.princeJoined=true;
}
if(data.flags&2){
G.princess=new Chara(2,'ムーンブルクのおうじょ',PRINCESS_LV);
G.princess.level=1;
while(G.princess.level<data.princessLv&&G.princess.level<PRINCESS_LV.length)
{G.princess.level++;const s=PRINCESS_LV[G.princess.level-1];G.princess.maxHp=s[1];G.princess.maxMp=s[2];G.princess.str=s[3];G.princess.agi=s[4];for(const sp of s[5])if(!G.princess.spells.includes(sp))G.princess.spells.push(sp)}
G.princess.hp=G.princess.maxHp;G.princess.mp=G.princess.maxMp;G.princess.exp=data.princessExp;
G.party.push(G.princess);G.flags.princessJoined=true;
}
G.gold=data.gold;
G.items=[];
if(data.yakusou>0)G.items.push({id:0,count:data.yakusou});
if(data.flags&16)G.items.push({id:4,count:1});
if(data.flags&32)G.items.push({id:5,count:1});
if(data.flags&64)G.items.push({id:8,count:1});
G.hasShip=!!(data.flags&4);
if(data.flags&8)G.flags.hargonDown=true;
G.mapId='world';G.px=12;G.py=15;G.pdir=0;
G.visited=['loracia'];G.chests={};initMaps();initNPCs();
G.state=GS.EXPLORE;
}
function saveGame(){const d={party:G.party.map(c=>({id:c.id,name:c.name,level:c.level,exp:c.exp,hp:c.hp,maxHp:c.maxHp,mp:c.mp,maxMp:c.maxMp,str:c.str,agi:c.agi,spells:c.spells,weapon:c.weapon,armor:c.armor,shield:c.shield,helmet:c.helmet,alive:c.alive})),gold:G.gold,items:G.items,flags:G.flags,mapId:G.mapId,px:G.px,py:G.py,pdir:G.pdir,visited:G.visited,hasShip:G.hasShip,shipX:G.shipX,shipY:G.shipY};localStorage.setItem('dq2save',JSON.stringify(d));showMsg('ぼうけんのしょに きろくしました。')}
function loadGame(){const r=localStorage.getItem('dq2save');if(!r){showMsg('ぼうけんのしょが ありません。');return}try{const d=JSON.parse(r);const ts=[HERO_LV,PRINCE_LV,PRINCESS_LV];G.party=d.party.map(p=>{const c=new Chara(p.id,p.name,ts[p.id]);Object.assign(c,p);c.lt=ts[p.id];return c});G.hero=G.party[0];G.prince=G.party.find(c=>c.id===1)||null;G.princess=G.party.find(c=>c.id===2)||null;G.gold=d.gold;G.items=d.items;G.flags=d.flags;G.mapId=d.mapId;G.px=d.px;G.py=d.py;G.pdir=d.pdir;G.visited=d.visited||[];G.hasShip=d.hasShip||false;G.shipX=d.shipX||0;G.shipY=d.shipY||0;G.state=GS.EXPLORE}catch(e){showMsg('ぼうけんのしょが こわれています。')}}
function updateExplore(){if(G.msgT)return;G.moveTimer--;if(G.moveTimer>0)return;let dx=0,dy=0;if(kh('ArrowUp')){dy=-1;G.pdir=1}else if(kh('ArrowDown')){dy=1;G.pdir=0}else if(kh('ArrowLeft')){dx=-1;G.pdir=2}else if(kh('ArrowRight')){dx=1;G.pdir=3}if(dx||dy){tryMove(dx,dy);G.moveTimer=8}if(kp('KeyX')||kp('Escape')){G.state=GS.MENU;G.ms={pg:'main',cursor:0,ci:0}}if(kp('KeyZ')||kp('Enter'))checkInteraction()}
function drawGameOver(){ctx.fillStyle='#000';ctx.fillRect(0,0,SW,SH);dtc('ぜんめつ してしまった…',SW/2,80,10,'#f00');dtc('ローレシア王「おお なさけない！',SW/2,120,8);dtc('もういちど がんばるのじゃ！」',SW/2,136,8);dtc('▶ つづきから (Zキー)',SW/2,180,8);if(kp('KeyZ')||kp('Enter')){loadGame();if(G.state!==GS.EXPLORE){G.ms={cursor:0};G.state=GS.TITLE}else{G.party.forEach(c=>{c.alive=true;c.hp=Math.max(1,Math.floor(c.maxHp/2));c.status=[]});G.gold=Math.floor(G.gold/2)}}}
function drawEnding(){ctx.fillStyle='#000';ctx.fillRect(0,0,SW,SH);dtc('邪神シドーは たおされた！',SW/2,40,10,'#ffd700');dtc('せかいに へいわが もどった！',SW/2,70,8);G.party.forEach((c,i)=>dtc(c.name,SW/2,110+i*20,8));dtc('あなたの ぼうけんは',SW/2,180,8);dtc('でんせつとして かたりつがれる',SW/2,196,8);dtc('- THE END -',SW/2,220,10,'#ffd700')}
function checkBossEvents(){if(G.mapId==='hargon'&&G.px===8&&G.py===3&&!G.flags.hargonDown){showMsg('ハーゴン「おろかもの！\nわがやみのちからを みるがよい！」',()=>startBattle('ハーゴン'))}if(G.mapId==='hargon'&&G.px===8&&G.py===2&&G.flags.hargonDown&&!G.flags.sidoDown){showMsg('大地がゆれる…\n邪神シドーが あらわれた！',()=>startBattle('シドー'))}}
function mainLoop(){G.frame++;switch(G.state){case GS.TITLE:drawTitle();break;case GS.EXPLORE:updateExplore();checkBossEvents();drawMap();drawPlayer();drawNPCs();if(G.party.length>0){dw(0,0,SW,14);G.party.forEach((c,i)=>{const col=c.alive?(c.hp<c.maxHp/4?'#f00':'#fff'):'#555';dt(c.name.slice(0,2)+' H'+c.hp+' M'+c.mp,i*85+4,10,6,col)})}break;case GS.BATTLE:updateBattle();drawBattle();break;case GS.MENU:updateMenu();drawMap();drawPlayer();drawNPCs();drawMenu();break;case GS.DIALOG:drawMap();drawPlayer();drawNPCs();break;case GS.SHOP:updateShop();drawMap();drawPlayer();drawNPCs();drawShop();break;case GS.GAMEOVER:drawGameOver();break;case GS.ENDING:drawEnding();break}if(G.msgT){drawMsg();if(kp('KeyZ')||kp('Enter')){if(G.msgCb){const cb=G.msgCb;G.msgCb=null;G.msgT='';cb();if(!G.msgT)nxtMsg()}else nxtMsg()}}requestAnimationFrame(mainLoop)}
// ===== TOUCH CONTROLS =====
document.querySelectorAll('#pad button[data-key]').forEach(btn=>{
const key=btn.dataset.key;
function tstart(e){e.preventDefault();G.keys[key]=true;G.kp[key]=true;btn.classList.add('held')}
function tend(e){e.preventDefault();G.keys[key]=false;btn.classList.remove('held')}
btn.addEventListener('touchstart',tstart,{passive:false});
btn.addEventListener('touchend',tend,{passive:false});
btn.addEventListener('touchcancel',tend,{passive:false});
btn.addEventListener('mousedown',tstart);
btn.addEventListener('mouseup',tend);
btn.addEventListener('mouseleave',tend);
});
// Prevent zoom/scroll on mobile
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
initMaps();initNPCs();G.state=GS.TITLE;G.ms={cursor:0};mainLoop();
</script>
</body>
</html>
