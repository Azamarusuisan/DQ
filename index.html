<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ドラゴンクエストII - HTML版</title>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-user-select:none;user-select:none}
body{background:#111;display:flex;flex-direction:column;justify-content:center;align-items:center;height:100vh;height:100dvh;overflow:hidden;font-family:monospace;touch-action:none}
#gc{position:relative;width:768px;height:720px;image-rendering:pixelated;image-rendering:crisp-edges;-ms-interpolation-mode:nearest-neighbor;max-width:100vw}
canvas{width:100%;height:100%;display:block;image-rendering:pixelated;image-rendering:crisp-edges}
#pad{display:none;width:100%;max-width:520px;padding:8px 12px 16px;justify-content:space-between;align-items:center;flex-shrink:0}
.dpad{position:relative;width:140px;height:140px}
.dpad button{position:absolute;width:48px;height:48px;background:rgba(255,255,255,0.18);border:2px solid rgba(255,255,255,0.35);border-radius:12px;color:#fff;font-size:22px;display:flex;align-items:center;justify-content:center;-webkit-tap-highlight-color:transparent;outline:none}
.dpad button:active,.dpad button.held{background:rgba(255,255,255,0.5)}
.dpad .up{top:0;left:46px}.dpad .down{bottom:0;left:46px}.dpad .left{top:46px;left:0}.dpad .right{top:46px;right:0}
.dpad .center{top:46px;left:46px;width:48px;height:48px;background:rgba(255,255,255,0.08);border:none;border-radius:4px;pointer-events:none;font-size:10px;color:rgba(255,255,255,0.2)}
.ab-area{display:flex;flex-direction:column;align-items:center;gap:8px}
.ab-row{display:flex;gap:16px;align-items:center}
.ab-row button{width:56px;height:56px;border-radius:50%;border:2px solid rgba(255,255,255,0.4);background:rgba(60,60,255,0.25);color:#fff;font-size:16px;font-weight:bold;-webkit-tap-highlight-color:transparent;outline:none}
.ab-row button:active,.ab-row button.held{background:rgba(100,100,255,0.6)}
.btn-b{background:rgba(255,80,80,0.25)!important;border-color:rgba(255,80,80,0.5)!important}
.btn-b:active,.btn-b.held{background:rgba(255,80,80,0.6)!important}
.meta-row{display:flex;gap:12px;margin-top:4px}
.meta-row button{width:60px;height:28px;border-radius:14px;border:1px solid rgba(255,255,255,0.3);background:rgba(255,255,255,0.1);color:#aaa;font-size:10px;-webkit-tap-highlight-color:transparent;outline:none}
.meta-row button:active{background:rgba(255,255,255,0.3)}
@media(pointer:coarse),(max-width:700px){
#gc{max-height:52vh;max-height:52dvh}
#pad{display:flex}
}
@media(max-height:500px){
#gc{max-height:45vh;max-height:45dvh}
.dpad{width:110px;height:110px}
.dpad button{width:38px;height:38px;font-size:16px}
.dpad .up{left:36px}.dpad .down{left:36px}.dpad .left{top:36px}.dpad .right{top:36px}
.dpad .center{top:36px;left:36px;width:38px;height:38px}
.ab-row button{width:46px;height:46px;font-size:14px}
}
</style>
</head>
<body>
<div id="gc"><canvas id="cv" width="768" height="720"></canvas></div>
<div id="pad">
<div class="dpad">
<button class="up" data-key="ArrowUp">▲</button>
<button class="down" data-key="ArrowDown">▼</button>
<button class="left" data-key="ArrowLeft">◀</button>
<button class="right" data-key="ArrowRight">▶</button>
<div class="center">+</div>
</div>
<div class="ab-area">
<div class="ab-row">
<button class="btn-b" data-key="KeyX">B</button>
<button data-key="KeyZ">A</button>
</div>
<div class="meta-row">
<button data-key="Escape">MENU</button>
<button data-key="Enter">START</button>
</div>
</div>
</div>
<script>
'use strict';
const T=16,SW=256,SH=240,COLS=SW/T,ROWS=SH/T;
const TL={};
function mkTile(n,fn){const c=document.createElement('canvas');c.width=c.height=T;fn(c.getContext('2d'));TL[n]=c}
function initTiles(){
mkTile('grass',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#4ab04a';c.fillRect(1,1,6,6);c.fillRect(9,9,6,6);c.fillStyle='#2d8a2d';c.fillRect(3,10,2,1);c.fillRect(11,4,2,1);c.fillRect(7,7,1,1)});
mkTile('sea',c=>{c.fillStyle='#1858cc';c.fillRect(0,0,T,T);c.fillStyle='#2068dd';c.fillRect(0,3,T,3);c.fillRect(0,10,T,3);c.fillStyle='#3080ee';c.fillRect(2,4,4,1);c.fillRect(10,11,4,1);c.fillStyle='#1050aa';c.fillRect(0,7,T,1)});
mkTile('desert',c=>{c.fillStyle='#e8b840';c.fillRect(0,0,T,T);c.fillStyle='#d0a030';c.fillRect(0,0,8,8);c.fillRect(8,8,8,8);c.fillStyle='#f0c850';c.fillRect(3,3,2,2);c.fillRect(11,11,2,2);c.fillStyle='#c89418';c.fillRect(6,12,3,1);c.fillRect(12,5,2,1)});
mkTile('mountain',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#8B5a23';c.beginPath();c.moveTo(8,1);c.lineTo(15,14);c.lineTo(1,14);c.fill();c.fillStyle='#a07040';c.fillRect(6,4,4,3);c.fillStyle='#fff';c.beginPath();c.moveTo(8,1);c.lineTo(10,4);c.lineTo(6,4);c.fill();c.fillStyle='#704020';c.fillRect(1,14,14,2)});
mkTile('forest',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#1a6a1a';c.beginPath();c.arc(8,5,5,0,Math.PI*2);c.fill();c.fillStyle='#228a22';c.beginPath();c.arc(6,4,3,0,Math.PI*2);c.fill();c.beginPath();c.arc(10,4,3,0,Math.PI*2);c.fill();c.fillStyle='#0a4a0a';c.beginPath();c.arc(8,6,2,0,Math.PI*2);c.fill();c.fillStyle='#8B4513';c.fillRect(7,10,2,6)});
mkTile('wall',c=>{c.fillStyle='#7a7a8a';c.fillRect(0,0,T,T);c.fillStyle='#9a9aaa';c.fillRect(0,0,7,7);c.fillRect(8,8,8,7);c.fillStyle='#5a5a6a';c.fillRect(7,0,1,T);c.fillRect(0,7,T,1);c.fillStyle='#aaaabc';c.fillRect(1,1,2,1);c.fillRect(10,10,2,1)});
mkTile('floor',c=>{c.fillStyle='#d4b892';c.fillRect(0,0,T,T);c.fillStyle='#c4a882';c.fillRect(0,0,8,8);c.fillRect(8,8,8,8);c.strokeStyle='#b09870';c.lineWidth=0.5;c.strokeRect(0.5,0.5,T-1,T-1);c.strokeRect(0.5,8,T-1,0)});
mkTile('town',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#cc3333';c.fillRect(3,5,10,9);c.fillStyle='#dd4444';c.fillRect(4,6,8,7);c.fillStyle='#aa2222';c.beginPath();c.moveTo(8,1);c.lineTo(14,5);c.lineTo(2,5);c.fill();c.fillStyle='#ffd700';c.fillRect(7,8,2,6);c.fillStyle='#4af';c.fillRect(4,7,2,2);c.fillRect(10,7,2,2)});
mkTile('cave',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#555';c.beginPath();c.arc(8,10,6,Math.PI,0);c.fill();c.fillRect(2,10,12,6);c.fillStyle='#222';c.beginPath();c.arc(8,10,4,Math.PI,0);c.fill();c.fillRect(4,10,8,6);c.fillStyle='#888';c.fillRect(2,9,1,1);c.fillRect(13,9,1,1)});
mkTile('castle',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#eee';c.fillRect(2,5,12,11);c.fillStyle='#ddd';c.fillRect(3,6,10,9);c.fillStyle='#ccc';c.fillRect(2,2,3,5);c.fillRect(11,2,3,5);c.fillStyle='#eee';c.fillRect(3,1,1,2);c.fillRect(12,1,1,2);c.fillStyle='#8B4513';c.fillRect(6,9,4,7);c.fillStyle='#448';c.fillRect(4,6,2,2);c.fillRect(10,6,2,2);c.fillStyle='#ffd700';c.fillRect(7,5,2,1)});
mkTile('bridge',c=>{c.fillStyle='#1858cc';c.fillRect(0,0,T,T);c.fillStyle='#a0622d';c.fillRect(2,0,12,T);c.fillStyle='#8B4513';c.fillRect(2,0,1,T);c.fillRect(13,0,1,T);c.fillStyle='#c08040';c.fillRect(4,0,2,T);c.fillRect(10,0,2,T);c.fillStyle='#604020';c.fillRect(3,3,10,1);c.fillRect(3,7,10,1);c.fillRect(3,11,10,1)});
mkTile('stairs_up',c=>{c.fillStyle='#d4b892';c.fillRect(0,0,T,T);c.fillStyle='#a07040';for(let i=0;i<5;i++){c.fillRect(1+i*2,i*3,T-2-i*4,2)}c.fillStyle='#c09060';for(let i=0;i<5;i++){c.fillRect(1+i*2,i*3,T-2-i*4,1)}});
mkTile('stairs_down',c=>{c.fillStyle='#d4b892';c.fillRect(0,0,T,T);c.fillStyle='#444';for(let i=0;i<5;i++){c.fillRect(1+i*2,i*3,T-2-i*4,2)}c.fillStyle='#555';for(let i=0;i<5;i++){c.fillRect(1+i*2,i*3,T-2-i*4,1)}});
mkTile('swamp',c=>{c.fillStyle='#3a6a2a';c.fillRect(0,0,T,T);c.fillStyle='#507a30';c.fillRect(0,0,8,8);c.fillRect(8,8,8,8);c.fillStyle='#2a5a1a';c.fillRect(2,10,4,3);c.fillRect(10,4,4,3);c.fillStyle='#6a3a6a';c.fillRect(5,5,2,2);c.fillRect(11,11,2,2)});
mkTile('tower',c=>{c.fillStyle='#3a9a3a';c.fillRect(0,0,T,T);c.fillStyle='#aaa';c.fillRect(4,3,8,13);c.fillStyle='#bbb';c.fillRect(5,4,6,11);c.fillStyle='#888';c.fillRect(4,0,2,5);c.fillRect(10,0,2,5);c.fillStyle='#999';c.fillRect(5,0,1,1);c.fillRect(11,0,1,1);c.fillStyle='#555';c.fillRect(6,10,4,6);c.fillStyle='#448';c.fillRect(6,5,2,2);c.fillRect(8,5,2,2)});
mkTile('chest',c=>{c.fillStyle='#d4b892';c.fillRect(0,0,T,T);c.fillStyle='#daa520';c.fillRect(3,5,10,7);c.fillStyle='#c89010';c.fillRect(3,5,10,2);c.fillStyle='#b08010';c.fillRect(3,7,10,1);c.fillStyle='#f0d040';c.fillRect(7,6,2,1);c.fillStyle='#fff';c.fillRect(7,8,2,2);c.fillStyle='#a07010';c.fillRect(3,5,1,7);c.fillRect(12,5,1,7)});
mkTile('chest_open',c=>{c.fillStyle='#d4b892';c.fillRect(0,0,T,T);c.fillStyle='#8a6a10';c.fillRect(3,5,10,7);c.fillStyle='#7a5a08';c.fillRect(3,3,10,3);c.fillStyle='#6a4a00';c.fillRect(3,5,10,1);c.fillStyle='#444';c.fillRect(5,7,6,3)});
// ローレシアの王子: 青い鎧、紫の兜、剣
['down','up','left','right'].forEach(dir=>{mkTile('hero_'+dir,c=>{
// 兜(紫)
c.fillStyle='#60c';c.fillRect(5,0,6,3);c.fillRect(4,1,1,2);c.fillRect(11,1,1,2);
// 顔(肌色)
c.fillStyle='#fdb';c.fillRect(5,3,6,3);
// 目
c.fillStyle='#000';
if(dir==='down'){c.fillRect(6,4,1,1);c.fillRect(9,4,1,1)}
else if(dir==='left'){c.fillRect(5,4,1,1)}
else if(dir==='right'){c.fillRect(10,4,1,1)}
// 鎧(青)
c.fillStyle='#22f';c.fillRect(4,6,8,5);
// 鎧のライン
c.fillStyle='#55f';c.fillRect(7,7,2,3);
// 腕
c.fillStyle='#22f';c.fillRect(3,7,1,4);c.fillRect(12,7,1,4);
// 剣(右手)
if(dir!=='up'){c.fillStyle='#ccc';c.fillRect(13,5,1,5);c.fillStyle='#daa520';c.fillRect(12,9,3,1)}
// 足
c.fillStyle='#a52';c.fillRect(5,11,2,3);c.fillRect(9,11,2,3);
// ブーツ
c.fillStyle='#630';c.fillRect(5,13,2,2);c.fillRect(9,13,2,2);
})});
// サマルトリアの王子: 緑のローブ、黄色い帽子
['down','up','left','right'].forEach(dir=>{mkTile('prince_'+dir,c=>{
// 帽子(黄)
c.fillStyle='#ec0';c.fillRect(5,0,6,2);c.fillRect(4,1,8,1);
// 髪
c.fillStyle='#530';c.fillRect(5,2,6,1);
// 顔
c.fillStyle='#fdb';c.fillRect(5,3,6,3);
c.fillStyle='#000';
if(dir==='down'){c.fillRect(6,4,1,1);c.fillRect(9,4,1,1)}
else if(dir==='left'){c.fillRect(5,4,1,1)}
else if(dir==='right'){c.fillRect(10,4,1,1)}
// ローブ(緑)
c.fillStyle='#0a0';c.fillRect(4,6,8,5);
c.fillStyle='#0c0';c.fillRect(6,6,4,1);
// 腕
c.fillStyle='#0a0';c.fillRect(3,7,1,3);c.fillRect(12,7,1,3);
// 杖
if(dir!=='up'){c.fillStyle='#a52';c.fillRect(13,3,1,8);c.fillStyle='#0ff';c.fillRect(13,2,1,1)}
// 足
c.fillStyle='#0a0';c.fillRect(5,11,2,3);c.fillRect(9,11,2,3);
c.fillStyle='#850';c.fillRect(5,13,2,2);c.fillRect(9,13,2,2);
})});
// ムーンブルクの王女: ピンクのローブ、長い髪
['down','up','left','right'].forEach(dir=>{mkTile('princess_'+dir,c=>{
// 髪(青紫)
c.fillStyle='#40a';c.fillRect(4,0,8,6);c.fillRect(3,2,1,8);c.fillRect(12,2,1,8);
// 顔
c.fillStyle='#fdb';c.fillRect(5,2,6,4);
c.fillStyle='#000';
if(dir==='down'){c.fillRect(6,3,1,1);c.fillRect(9,3,1,1);c.fillStyle='#f66';c.fillRect(7,5,2,1)}
else if(dir==='left'){c.fillRect(5,3,1,1)}
else if(dir==='right'){c.fillRect(10,3,1,1)}
// ローブ(ピンク)
c.fillStyle='#f6a';c.fillRect(4,6,8,5);
c.fillStyle='#f8c';c.fillRect(6,7,4,1);
// 腕
c.fillStyle='#f6a';c.fillRect(3,7,1,3);c.fillRect(12,7,1,3);
// スカート
c.fillStyle='#f6a';c.fillRect(4,11,8,3);
c.fillStyle='#d48';c.fillRect(4,13,8,1);
// 足
c.fillStyle='#f8c';c.fillRect(5,14,2,1);c.fillRect(9,14,2,1);
})});
}
initTiles();
const SPELLS={hoimi:{name:'ホイミ',mp:3,type:'heal',power:30,target:'ally'},behoimi:{name:'ベホイミ',mp:5,type:'heal',power:80,target:'ally'},gira:{name:'ギラ',mp:4,type:'damage',power:20,target:'enemies'},begirama:{name:'ベギラマ',mp:6,type:'damage',power:40,target:'enemies'},rariho:{name:'ラリホー',mp:3,type:'status',effect:'sleep',target:'enemy'},manusa:{name:'マヌーサ',mp:3,type:'status',effect:'blind',target:'enemies'},ruura:{name:'ルーラ',mp:8,type:'field'},riremito:{name:'リレミト',mp:6,type:'field'},zaoriku:{name:'ザオリク',mp:15,type:'revive',power:999,target:'ally'},ionazun:{name:'イオナズン',mp:10,type:'damage',power:70,target:'enemies'},sukuruto:{name:'スクルト',mp:4,type:'buff',effect:'def_up',target:'allies'},baikiruto:{name:'バイキルト',mp:6,type:'buff',effect:'atk_up',target:'ally'},
// 戦士スキル
kiaitame:{name:'きあいため',mp:0,type:'buff',effect:'atk_up',target:'self'},
kabutowari:{name:'かぶとわり',mp:0,type:'damage',power:30,target:'enemy',defDown:true},
shinkuuha:{name:'しんくうは',mp:0,type:'damage',power:40,target:'enemies'},
morobagiri:{name:'もろばぎり',mp:0,type:'damage',power:70,target:'enemy',selfDmg:0.25},
// 魔法使いスキル
mera:{name:'メラ',mp:2,type:'damage',power:15,target:'enemy'},
hyado:{name:'ヒャド',mp:3,type:'damage',power:20,target:'enemy'},
merami:{name:'メラミ',mp:5,type:'damage',power:45,target:'enemy'},
mahyado:{name:'マヒャド',mp:8,type:'damage',power:50,target:'enemies'},
// 僧侶スキル
bagi:{name:'バギ',mp:4,type:'damage',power:18,target:'enemies'},
// 武闘家スキル
mawashigeri:{name:'まわしげり',mp:0,type:'damage',power:25,target:'enemy'},
tobihizageri:{name:'とびひざげり',mp:0,type:'damage',power:38,target:'enemy'},
seikenzuki:{name:'せいけんづき',mp:0,type:'damage',power:55,target:'enemy',miss:0.15},
bakuretsken:{name:'ばくれつけん',mp:0,type:'damage_multi',power:15,hits:4,target:'enemies'},
// 踊り子スキル
fushiginaodori:{name:'ふしぎなおどり',mp:0,type:'drain_mp',power:8,target:'enemy'},
sasouodori:{name:'さそうおどり',mp:0,type:'status',effect:'sleep',target:'enemy'},
medapanidance:{name:'メダパニダンス',mp:0,type:'status',effect:'confuse',target:'enemies'},
hussle:{name:'ハッスルダンス',mp:0,type:'heal',power:40,target:'allies'},
// 盗賊スキル
nusumu:{name:'ぬすむ',mp:0,type:'steal',target:'enemy'},
touzokubashiri:{name:'とうぞくばしり',mp:0,type:'buff',effect:'agi_up',target:'self'},
inpas:{name:'インパス',mp:2,type:'identify',target:'enemy'},
remirama:{name:'レミラーマ',mp:4,type:'field'},
// バトルマスタースキル
hayabusagiri:{name:'はやぶさぎり',mp:0,type:'damage_multi',power:25,hits:2,target:'enemy'},
midareuchi:{name:'みだれうち',mp:0,type:'damage_multi',power:18,hits:4,target:'enemies'},
kyodaitsumuji:{name:'きょだいつむじ',mp:0,type:'damage',power:65,target:'enemies'},
gigaslash:{name:'ギガスラッシュ',mp:15,type:'damage',power:110,target:'enemies'},
// 賢者スキル
begiragon:{name:'ベギラゴン',mp:10,type:'damage',power:85,target:'enemies'},
behomaraa:{name:'ベホマラー',mp:12,type:'heal',power:60,target:'allies'},
mahyado2:{name:'マヒャデドス',mp:14,type:'damage',power:90,target:'enemies'},
madante:{name:'マダンテ',mp:0,type:'madante',target:'enemies'},
// 魔法戦士スキル
flameslash:{name:'かえんぎり',mp:2,type:'damage',power:40,target:'enemy'},
iceslash:{name:'ふぶきのつるぎ',mp:2,type:'damage',power:40,target:'enemy'},
mppassion:{name:'MPパサー',mp:0,type:'mp_give',target:'ally'},
baikicrush:{name:'バイキルト斬り',mp:4,type:'damage',power:60,target:'enemy'},
// パラディンスキル
palashield:{name:'パラディンガード',mp:0,type:'buff',effect:'def_up',target:'self'},
grandcross_s:{name:'グランドクロス',mp:8,type:'damage',power:70,target:'enemies'},
megante:{name:'メガンテ',mp:0,type:'megante',target:'enemies'},
palaguard:{name:'におうだち',mp:0,type:'buff',effect:'cover',target:'self'},
// レンジャースキル
fieldguard:{name:'フィールドガード',mp:0,type:'buff',effect:'def_up',target:'allies'},
toxicbreath:{name:'どくのいき',mp:0,type:'status',effect:'poison',target:'enemies'},
mofusen:{name:'もうどくのきり',mp:0,type:'status',effect:'poison',target:'enemies'},
deathcutter:{name:'デスカッター',mp:0,type:'damage',power:75,target:'enemy'},
// スーパースタースキル
starlight:{name:'スターライト',mp:3,type:'heal',power:25,target:'allies'},
grandbocce:{name:'グランドボッケ',mp:0,type:'damage',power:45,target:'enemies'},
hussledance2:{name:'ハッスルダンス',mp:0,type:'heal',power:60,target:'allies'},
moonlight:{name:'ムーンサルト',mp:0,type:'damage',power:55,target:'enemies'},
// 勇者スキル
gigaslash2:{name:'ギガブレイク',mp:18,type:'damage',power:130,target:'enemies'},
jigopark:{name:'ジゴスパーク',mp:16,type:'damage',power:100,target:'enemies'},
grandcross:{name:'グランドクロス',mp:12,type:'damage',power:90,target:'enemies'},
madante2:{name:'マダンテ',mp:0,type:'madante',target:'enemies'}};
const JOBS={
none:{id:0,name:'なし',statMod:{str:1,agi:1,maxHp:1,maxMp:1},skills:[],req:null},
warrior:{id:1,name:'戦士',statMod:{str:1.2,agi:0.9,maxHp:1.1,maxMp:0.5},skills:[[1,'kiaitame'],[3,'kabutowari'],[5,'shinkuuha'],[8,'morobagiri']],req:null},
mage:{id:2,name:'魔法使い',statMod:{str:0.7,agi:1.0,maxHp:0.8,maxMp:1.3},skills:[[1,'mera'],[3,'hyado'],[5,'merami'],[8,'mahyado']],req:null},
priest:{id:3,name:'僧侶',statMod:{str:0.9,agi:1.0,maxHp:1.0,maxMp:1.2},skills:[[1,'hoimi'],[3,'bagi'],[5,'behoimi'],[8,'zaoriku']],req:null},
fighter:{id:4,name:'武闘家',statMod:{str:1.1,agi:1.3,maxHp:1.0,maxMp:0.3},skills:[[1,'mawashigeri'],[3,'tobihizageri'],[5,'seikenzuki'],[8,'bakuretsken']],req:null},
dancer:{id:5,name:'踊り子',statMod:{str:0.8,agi:1.2,maxHp:0.9,maxMp:1.0},skills:[[1,'fushiginaodori'],[3,'sasouodori'],[5,'medapanidance'],[8,'hussle']],req:null},
thief:{id:6,name:'盗賊',statMod:{str:0.9,agi:1.4,maxHp:0.9,maxMp:0.8},skills:[[1,'nusumu'],[3,'touzokubashiri'],[5,'inpas'],[8,'remirama']],req:null},
battlemaster:{id:7,name:'バトルマスター',statMod:{str:1.4,agi:1.1,maxHp:1.2,maxMp:0.4},skills:[[2,'hayabusagiri'],[4,'midareuchi'],[6,'kyodaitsumuji'],[8,'gigaslash']],req:{warrior:8,fighter:8}},
sage:{id:8,name:'賢者',statMod:{str:0.8,agi:1.0,maxHp:0.9,maxMp:1.5},skills:[[2,'begiragon'],[4,'mahyado2'],[6,'behomaraa'],[8,'madante']],req:{mage:8,priest:8}},
magicknight:{id:9,name:'魔法戦士',statMod:{str:1.1,agi:1.0,maxHp:1.0,maxMp:1.1},skills:[[2,'flameslash'],[4,'iceslash'],[6,'mppassion'],[8,'baikicrush']],req:{warrior:8,mage:8}},
paladin:{id:10,name:'パラディン',statMod:{str:1.0,agi:0.9,maxHp:1.3,maxMp:1.1},skills:[[2,'palashield'],[4,'grandcross_s'],[6,'megante'],[8,'palaguard']],req:{priest:8,fighter:8}},
ranger:{id:11,name:'レンジャー',statMod:{str:1.0,agi:1.2,maxHp:1.0,maxMp:0.9},skills:[[2,'fieldguard'],[4,'toxicbreath'],[6,'mofusen'],[8,'deathcutter']],req:{thief:8,fighter:8}},
superstar:{id:12,name:'スーパースター',statMod:{str:0.9,agi:1.1,maxHp:0.9,maxMp:1.2},skills:[[2,'starlight'],[4,'grandbocce'],[6,'hussledance2'],[8,'moonlight']],req:{dancer:8,mage:8}},
hero_job:{id:13,name:'勇者',statMod:{str:1.3,agi:1.2,maxHp:1.3,maxMp:1.3},skills:[[2,'gigaslash2'],[4,'jigopark'],[6,'grandcross'],[8,'madante2']],req:{battlemaster:8,sage:8}}};
const JOB_KEYS=Object.keys(JOBS);
const WEAPONS=[{id:0,name:'ひのきのぼう',atk:2,price:10,who:[0,1]},{id:1,name:'どうのつるぎ',atk:10,price:100,who:[0,1]},{id:2,name:'はがねのつるぎ',atk:25,price:500,who:[0,1]},{id:3,name:'はやぶさのけん',atk:35,price:0,who:[0],hits:2},{id:4,name:'いなずまのけん',atk:45,price:0,who:[0]},{id:5,name:'ロトのつるぎ',atk:60,price:0,who:[0]},{id:6,name:'てつのやり',atk:20,price:300,who:[1]},{id:7,name:'まどうしのつえ',atk:8,price:200,who:[2]},{id:8,name:'ちからのつえ',atk:15,price:0,who:[2]}];
const ARMORS=[{id:0,name:'ぬののふく',def:2,price:30,who:[0,1,2]},{id:1,name:'かわのよろい',def:8,price:80,who:[0,1]},{id:2,name:'くさりかたびら',def:16,price:300,who:[0,1]},{id:3,name:'はがねのよろい',def:25,price:700,who:[0]},{id:4,name:'みずのはごろも',def:35,price:0,who:[0,1,2]},{id:5,name:'ロトのよろい',def:50,price:0,who:[0]}];
const SHIELDS=[{id:0,name:'かわのたて',def:4,price:60,who:[0,1]},{id:1,name:'てつのたて',def:10,price:250,who:[0,1]},{id:2,name:'ちからのたて',def:18,price:0,who:[0]},{id:3,name:'ロトのたて',def:30,price:0,who:[0]}];
const HELMETS=[{id:0,name:'かわのぼうし',def:2,price:40,who:[0,1,2]},{id:1,name:'てつかぶと',def:6,price:200,who:[0,1]},{id:2,name:'ロトのかぶと',def:20,price:0,who:[0]}];
const ITEMS=[{id:0,name:'やくそう',type:'heal',power:30,price:8},{id:1,name:'どくけしそう',type:'cure',cure:'poison',price:10},{id:2,name:'キメラのつばさ',type:'field',effect:'ruura',price:25},{id:3,name:'せかいじゅのは',type:'revive',power:999,price:0},{id:4,name:'ぎんのカギ',type:'key',price:0},{id:5,name:'きんのカギ',type:'key',price:0},{id:6,name:'ろうやのカギ',type:'key',price:0},{id:7,name:'ふねのきっぷ',type:'key',price:0},{id:8,name:'ラーのかがみ',type:'story',price:0},{id:9,name:'つきのかけら',type:'story',price:0},{id:10,name:'いのちのきのみ',type:'stat',stat:'maxHp',value:5,price:0},{id:11,name:'ふしぎなきのみ',type:'stat',stat:'maxMp',value:5,price:0}];
const HERO_LV=[[0,20,0,8,4,[]],[10,28,0,12,6,[]],[30,36,5,16,9,[]],[80,44,8,22,12,[]],[150,55,12,28,16,['gira']],[250,65,16,35,20,[]],[400,78,20,42,25,['begirama']],[600,90,25,50,30,[]],[900,105,30,58,36,['ionazun']],[1300,120,35,68,42,[]],[1800,138,42,78,48,[]],[2500,155,48,88,55,['baikiruto']],[3500,170,55,98,62,[]],[5000,190,62,110,70,[]],[7000,210,70,120,80,[]]];
const PRINCE_LV=[[0,18,10,6,5,['hoimi']],[12,24,16,10,8,[]],[40,30,22,14,11,['gira']],[100,38,28,18,15,[]],[200,48,36,24,20,['behoimi','sukuruto']],[350,56,42,30,24,[]],[550,66,50,36,29,['begirama']],[800,78,58,44,34,['zaoriku']],[1200,88,66,52,40,[]],[1700,100,75,60,46,[]],[2400,112,84,68,52,[]],[3300,126,94,78,60,[]],[4500,140,104,88,68,[]],[6200,156,116,98,76,[]],[8500,172,128,108,85,[]]];
const PRINCESS_LV=[[0,14,18,4,6,['hoimi','rariho']],[15,18,26,6,10,[]],[50,22,34,8,14,['manusa']],[120,28,42,11,18,['ruura']],[230,34,52,14,23,['behoimi']],[400,40,60,17,28,['riremito']],[650,48,70,21,34,[]],[1000,56,80,26,40,['ionazun']],[1500,64,92,31,46,[]],[2200,74,104,36,52,['zaoriku']],[3100,84,116,42,58,[]],[4200,94,128,48,64,[]],[5800,106,142,55,72,[]],[7800,118,156,62,80,[]],[10000,132,172,70,88,[]]];
const MONSTERS=[
// Zone 0: ローレシア周辺
{name:'スライム',hp:8,mp:0,atk:6,def:3,agi:3,exp:2,gold:2,spells:[],zone:[0]},
{name:'おおなめくじ',hp:14,mp:0,atk:10,def:4,agi:2,exp:4,gold:4,spells:[],zone:[0]},
{name:'アイアンアント',hp:16,mp:0,atk:12,def:6,agi:4,exp:5,gold:5,spells:[],zone:[0]},
// Zone 1: サマルトリア～ムーンペタ
{name:'ドラキー',hp:12,mp:0,atk:9,def:5,agi:6,exp:3,gold:3,spells:[],zone:[0,1]},
{name:'バブルスライム',hp:18,mp:0,atk:14,def:6,agi:4,exp:6,gold:6,spells:[],zone:[1]},
{name:'マンドリル',hp:35,mp:0,atk:28,def:15,agi:10,exp:14,gold:18,spells:[],zone:[1,2]},
{name:'リビングデッド',hp:30,mp:0,atk:22,def:12,agi:6,exp:10,gold:14,spells:[],zone:[1]},
{name:'まじゅつし',hp:25,mp:10,atk:16,def:10,agi:14,exp:12,gold:16,spells:['gira'],zone:[1]},
// Zone 2: ロンダルキアへの洞窟
{name:'バピラス',hp:40,mp:8,atk:32,def:20,agi:14,exp:18,gold:22,spells:['rariho'],zone:[2]},
{name:'ドラゴン',hp:70,mp:0,atk:45,def:35,agi:16,exp:30,gold:40,spells:['gira'],zone:[2]},
{name:'キラーマシン',hp:120,mp:0,atk:55,def:80,agi:25,exp:65,gold:50,spells:[],zone:[2,3]},
{name:'フレイム',hp:50,mp:8,atk:38,def:25,agi:20,exp:25,gold:30,spells:['gira'],zone:[2]},
{name:'はぐれメタル',hp:5,mp:99,atk:10,def:250,agi:200,exp:1050,gold:10,spells:[],zone:[2,3],flee:0.5},
// Zone 3: ハーゴン神殿
{name:'ギガンテス',hp:100,mp:0,atk:65,def:45,agi:12,exp:55,gold:60,spells:[],zone:[3]},
{name:'アークデーモン',hp:80,mp:20,atk:55,def:35,agi:20,exp:50,gold:60,spells:['begirama'],zone:[3]},
{name:'ブリザード',hp:60,mp:20,atk:40,def:30,agi:35,exp:45,gold:50,spells:['ionazun'],zone:[3]},
{name:'あくましんかん',hp:90,mp:30,atk:45,def:40,agi:22,exp:55,gold:55,spells:['behoimi'],zone:[3]},
// ボス
{name:'ハーゴン',hp:200,mp:50,atk:80,def:60,agi:40,exp:0,gold:0,spells:['begirama','behoimi'],zone:[],boss:true},
{name:'シドー',hp:300,mp:99,atk:120,def:80,agi:50,exp:0,gold:0,spells:['ionazun','behoimi'],zone:[],boss:true}];
const TILE_NAMES=['grass','sea','forest','mountain','desert','swamp','town','castle','cave','tower','bridge'];
const WALKABLE=[true,false,true,false,true,true,true,true,true,true,true];
function genWorld(){const W=64,H=64,m=[];for(let y=0;y<H;y++){m[y]=[];for(let x=0;x<W;x++){if(x<2||x>W-3||y<2||y>H-3){m[y][x]=1;continue}const cx=W/2,cy=H/2,d=Math.sqrt((x-cx)**2+(y-cy)**2);if(d>28){m[y][x]=1;continue}if(d>18&&d<22&&y>cy-3&&y<cy+3&&x>cx+5){m[y][x]=1;continue}m[y][x]=0;const n=Math.sin(x*0.8)*Math.cos(y*0.6)*0.5+Math.sin(x*0.3+y*0.4)*0.5;if(n>0.6)m[y][x]=2;if(y>18&&y<26&&x>12&&x<22)m[y][x]=3;if(y>36&&y<42&&x>36&&x<46)m[y][x]=3;if(x>40&&x<52&&y>12&&y<22&&d<28)m[y][x]=4;if(x>26&&x<33&&y>38&&y<44)m[y][x]=5}}
// Locations: all within d<28 from center(32,32) except hargon island
// ローレシア城(12,14) サマルトリア城(16,40) リリザ(22,28) ムーンペタ(28,42)
// ベラヌール(42,18) ペルポイ(48,35) ロンダルキアのほこら(38,10)
m[14][12]=7;m[28][22]=6;m[42][28]=6;m[18][42]=6;m[35][48]=6;m[40][16]=7;m[10][38]=7;m[20][30]=7;
// 湖の洞窟(20,22) ロンの洞窟(45,28) ドラゴンの角(40,40)
m[22][20]=8;m[28][45]=8;m[40][40]=9;
// ハーゴン島 (55,50) - small island only reachable by ship
for(let y=48;y<=53;y++)for(let x=53;x<=58;x++){if(m[y]&&m[y][x]!==undefined)m[y][x]=0}
m[50][55]=9; // ハーゴン神殿
// Bridges
m[14][18]=10;m[14][19]=10;m[40][20]=10;m[40][21]=10;
// Clear paths near start
for(let x=13;x<22;x++)if(m[14][x]===0||m[14][x]===2)m[14][x]=0;
for(let y=14;y<28;y++)if(m[y][22]===0||m[y][22]===2)m[y][22]=0;
// Path south to samaltria
for(let y=28;y<41;y++)if(m[y][16]===3||m[y][16]===2)m[y][16]=0;
return m}
const worldMap=genWorld(),WORLD_W=64,WORLD_H=64;
function getZone(x,y){if(x<25&&y<30)return 0;if(x<40&&y<45)return 1;if(x<50)return 2;return 3}
const GS={TITLE:0,EXPLORE:1,BATTLE:2,MENU:3,DIALOG:4,SHOP:5,GAMEOVER:6,ENDING:7};
class Chara{constructor(id,name,lt){this.id=id;this.name=name;this.lt=lt;this.level=1;this.exp=0;const s=lt[0];this._baseMaxHp=s[1];this.hp=s[1];this._baseMaxMp=s[2];this.mp=s[2];this._baseStr=s[3];this._baseAgi=s[4];this.spells=[...s[5]];this.weapon=null;this.armor=null;this.shield=null;this.helmet=null;this.alive=true;this.status=[];this.atkBuf=0;this.defBuf=0;this.job='none';this.jobProf={};this.learnedSkills=[];for(const k in JOBS)if(k!=='none')this.jobProf[k]=0}
get maxHp(){return Math.floor(this._baseMaxHp*(JOBS[this.job]?JOBS[this.job].statMod.maxHp||1:1))}
set maxHp(v){this._baseMaxHp=v}
get maxMp(){return Math.floor(this._baseMaxMp*(JOBS[this.job]?JOBS[this.job].statMod.maxMp||1:1))}
set maxMp(v){this._baseMaxMp=v}
get str(){return Math.floor(this._baseStr*(JOBS[this.job]?JOBS[this.job].statMod.str||1:1))}
set str(v){this._baseStr=v}
get agi(){return Math.floor(this._baseAgi*(JOBS[this.job]?JOBS[this.job].statMod.agi||1:1))}
set agi(v){this._baseAgi=v}
get atk(){return this.str+(this.weapon!=null?WEAPONS[this.weapon].atk:0)+this.atkBuf}
get def(){let d=Math.floor(this.agi/2);if(this.armor!=null)d+=ARMORS[this.armor].def;if(this.shield!=null)d+=SHIELDS[this.shield].def;if(this.helmet!=null)d+=HELMETS[this.helmet].def;return d+this.defBuf}
get allSkills(){const s=new Set([...this.spells,...this.learnedSkills]);const j=JOBS[this.job];if(j&&j.skills){const p=this.jobProf[this.job]||0;for(const[rp,sk]of j.skills)if(p>=rp)s.add(sk)}return[...s].filter(k=>SPELLS[k])}
lvUp(){let didLevel=false;while(this.level<this.lt.length){const n=this.lt[this.level];if(this.exp>=n[0]){this.level++;this.maxHp=n[1];this.maxMp=n[2];this.str=n[3];this.agi=n[4];this.hp=this.maxHp;this.mp=this.maxMp;for(const s of n[5])if(!this.spells.includes(s))this.spells.push(s);didLevel=true}else break}return didLevel}}
const G={state:GS.TITLE,keys:{},kp:{},hero:null,prince:null,princess:null,party:[],mapId:'world',px:10,py:10,pdir:0,moveTimer:0,cam:{x:0,y:0},steps:0,gold:50,items:[],flags:{},hasShip:false,shipX:0,shipY:0,onShip:false,visited:[],msgQ:[],msgT:'',msgCb:null,ms:null,bs:null,ss:null,frame:0,maps:{},warps:{},npcs:{},shops:{},chests:{},innPrice:6};
window.addEventListener('keydown',e=>{G.keys[e.code]=true;G.kp[e.code]=true;e.preventDefault()});
window.addEventListener('keyup',e=>{G.keys[e.code]=false});
function kp(c){const r=G.kp[c];G.kp[c]=false;return r}
function kh(c){return G.keys[c]}
const cv=document.getElementById('cv'),ctx=cv.getContext('2d');ctx.imageSmoothingEnabled=false;ctx.scale(3,3);
function dt(t,x,y,s=8,c='#fff'){ctx.font=s+'px monospace';ctx.textAlign='left';ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillText(t,x+.5,y+.5);ctx.fillStyle=c;ctx.fillText(t,x,y)}
function dtc(t,x,y,s=8,c='#fff'){ctx.font=s+'px monospace';ctx.textAlign='center';ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillText(t,x+.5,y+.5);ctx.fillStyle=c;ctx.fillText(t,x,y)}
function dw(x,y,w,h){ctx.fillStyle='rgba(8,8,40,0.92)';ctx.fillRect(x,y,w,h);ctx.strokeStyle='#48f';ctx.lineWidth=1;ctx.strokeRect(x+.5,y+.5,w-1,h-1);ctx.strokeStyle='rgba(100,160,255,0.4)';ctx.strokeRect(x+1.5,y+1.5,w-3,h-3);ctx.fillStyle='rgba(100,180,255,0.15)';ctx.fillRect(x+2,y+2,w-4,1)}
function dc(x,y){const a=.6+.4*Math.sin(G.frame*.15);ctx.fillStyle=`rgba(255,215,0,${a})`;ctx.beginPath();ctx.moveTo(x,y);ctx.lineTo(x+6,y+4);ctx.lineTo(x,y+8);ctx.fill()}
function drawBar(x,y,w,h,ratio,c1,c2){ctx.fillStyle='rgba(0,0,0,0.5)';ctx.fillRect(x,y,w,h);const fw=Math.max(0,Math.floor(w*Math.min(1,ratio)));ctx.fillStyle=c1;ctx.fillRect(x,y,fw,h);ctx.fillStyle=c2;ctx.fillRect(x,y,fw,Math.floor(h/2));ctx.strokeStyle='rgba(255,255,255,0.2)';ctx.lineWidth=.5;ctx.strokeRect(x,y,w,h)}
function showMsg(t,cb){G.msgQ.push({t,cb});if(!G.msgT)nxtMsg()}
function nxtMsg(){if(G.msgQ.length===0){G.msgT='';G.msgCb=null;return}const m=G.msgQ.shift();G.msgT=m.t;G.msgCb=m.cb||null;G.msgCI=0}
function drawMsg(){if(!G.msgT)return;dw(8,SH-56,SW-16,48);if(G.msgCI===undefined)G.msgCI=0;if(G.msgCI<G.msgT.length)G.msgCI+=.5;const show=G.msgT.substring(0,Math.floor(G.msgCI));const mx=SW-32,ls=[];let l='';ctx.font='8px monospace';for(const ch of show){if(ctx.measureText(l+ch).width>mx||ch==='\n'){ls.push(l);l=ch==='\n'?'':ch}else l+=ch}if(l)ls.push(l);ctx.fillStyle='#fff';ctx.textAlign='left';for(let i=0;i<Math.min(ls.length,3);i++)ctx.fillText(ls[i],16,SH-42+i*14);if(G.msgCI>=G.msgT.length&&G.frame%40<20)dt('▼',SW-24,SH-12,8,'#ffd700')}
const INDOOR={5:'wall',6:'floor',7:'stairs_up',8:'stairs_down',9:'chest',10:'chest_open'};
function initMaps(){G.maps.loracia={w:16,h:16,data:mkTown(16,16,'castle'),er:0};G.maps.liriza={w:12,h:12,data:mkTown(12,12,'town'),er:0};G.maps.moonpeta={w:14,h:14,data:mkTown(14,14,'town'),er:0};G.maps.beranule={w:12,h:12,data:mkTown(12,12,'town'),er:0};G.maps.samaltria={w:14,h:14,data:mkTown(14,14,'castle'),er:0};G.maps.perpoi={w:12,h:12,data:mkTown(12,12,'town'),er:0};G.maps.lake_cave={w:16,h:16,data:mkDungeon(16,16),er:16,zone:0};G.maps.ron_cave={w:20,h:20,data:mkDungeon(20,20),er:16,zone:1};G.maps.dragon_horn={w:14,h:14,data:mkDungeon(14,14),er:16,zone:2};G.maps.rhone={w:14,h:14,data:mkTown(14,14,'castle'),er:0};G.maps.dharma={w:12,h:12,data:mkTown(12,12,'castle'),er:0};G.maps.hargon={w:16,h:16,data:mkHargon(),er:12,zone:3};
// Place treasure chests in dungeons
placeChest('lake_cave',12,8,{id:8,name:'ラーのかがみ'});
placeChest('lake_cave',4,12,{id:4,name:'ぎんのカギ'});
placeChest('ron_cave',15,15,{id:7,name:'ふねのきっぷ'});
placeChest('ron_cave',5,10,{weapon:3,name:'はやぶさのけん'});
placeChest('dragon_horn',7,12,{armor:4,name:'みずのはごろも'});
placeChest('hargon',2,8,{id:3,name:'せかいじゅのは'});
placeChest('dragon_horn',5,5,{weapon:5,name:'ロトのつるぎ'});
placeChest('hargon',14,8,{armor:5,name:'ロトのよろい'});
// Chest in loracia castle
placeChest('loracia',10,3,{id:0,name:'やくそう',count:3});
G.warps={
'world_12_14':{map:'loracia',x:8,y:14},'loracia_8_15':{map:'world',x:12,y:15},
'world_22_28':{map:'liriza',x:6,y:10},'liriza_6_11':{map:'world',x:22,y:29},
'world_28_42':{map:'moonpeta',x:7,y:12},'moonpeta_7_13':{map:'world',x:28,y:43},
'world_42_18':{map:'beranule',x:6,y:10},'beranule_6_11':{map:'world',x:42,y:19},
'world_16_40':{map:'samaltria',x:7,y:12},'samaltria_7_13':{map:'world',x:16,y:41},
'world_48_35':{map:'perpoi',x:6,y:10},'perpoi_6_11':{map:'world',x:48,y:36},
'world_20_22':{map:'lake_cave',x:8,y:1},'lake_cave_8_0':{map:'world',x:20,y:21},
'world_45_28':{map:'ron_cave',x:10,y:1},'ron_cave_10_0':{map:'world',x:45,y:27},
'world_40_40':{map:'dragon_horn',x:7,y:1},'dragon_horn_7_0':{map:'world',x:40,y:39},
'world_55_50':{map:'hargon',x:8,y:14},'hargon_8_15':{map:'world',x:55,y:51},
'world_38_10':{map:'rhone',x:7,y:12},'rhone_7_13':{map:'world',x:38,y:11},
'world_30_20':{map:'dharma',x:6,y:10},'dharma_6_11':{map:'world',x:30,y:21}}}
function mkTown(w,h,type){const m=[];for(let y=0;y<h;y++){m[y]=[];for(let x=0;x<w;x++){if(x===0||x===w-1||y===0||y===h-1)m[y][x]=5;else m[y][x]=6}}if(type==='castle'){for(let y=2;y<6;y++)for(let x=3;x<7;x++)m[y][x]=5;m[5][5]=6;m[3][5]=6}m[h-1][Math.floor(w/2)]=6;return m}
function mkDungeon(w,h){const m=[];for(let y=0;y<h;y++){m[y]=[];for(let x=0;x<w;x++)m[y][x]=5}const rs=[];for(let i=0;i<6;i++){const rw=3+Math.floor(Math.random()*3),rh=3+Math.floor(Math.random()*3),rx=1+Math.floor(Math.random()*(w-rw-2)),ry=1+Math.floor(Math.random()*(h-rh-2));rs.push({x:rx,y:ry,w:rw,h:rh});for(let y=ry;y<ry+rh;y++)for(let x=rx;x<rx+rw;x++)m[y][x]=6}
// Connect rooms with corridors
for(let i=0;i<rs.length-1;i++){let cx=rs[i].x+Math.floor(rs[i].w/2),cy=rs[i].y+Math.floor(rs[i].h/2);const tx=rs[i+1].x+Math.floor(rs[i+1].w/2),ty=rs[i+1].y+Math.floor(rs[i+1].h/2);while(cx!==tx){m[cy][cx]=6;cx+=cx<tx?1:-1}while(cy!==ty){m[cy][cx]=6;cy+=cy<ty?1:-1}}
// Entrance at top center
const ex=Math.floor(w/2);m[0][ex]=6;m[1][ex]=6;
// Connect entrance to nearest room
let cx=ex,cy=1;const nr=rs[0];const tx=nr.x+Math.floor(nr.w/2),ty=nr.y+Math.floor(nr.h/2);
while(cx!==tx){m[cy][cx]=6;cx+=cx<tx?1:-1}while(cy!==ty){m[cy][cx]=6;cy+=cy<ty?1:-1}
// Exit at bottom center
m[h-2][ex]=6;m[h-1][ex]=6;
return m}
function placeChest(mapId,x,y,reward){const m=G.maps[mapId];if(!m||!m.data[y])return;m.data[y][x]=9;
// Carve path from chest to entrance using simple L-shaped corridor
const ex=Math.floor(m.w/2),ey=1; // entrance position
let cx=x,cy=y;
// First go horizontally toward entrance column, then vertically toward entrance row
while(cx!==ex){const nx=cx+(cx<ex?1:-1);if(m.data[cy][nx]===5)m.data[cy][nx]=6;cx=nx}
while(cy!==ey){const ny=cy+(cy<ey?1:-1);if(m.data[ny][cx]===5)m.data[ny][cx]=6;cy=ny}
const key=mapId+'_'+x+'_'+y;G.chests[key]=reward}
function openChest(mapId,x,y){const key=mapId+'_'+x+'_'+y;if(G.flags['chest_'+key])return;const r=G.chests[key];if(!r)return;G.flags['chest_'+key]=true;const m=G.maps[mapId];if(m&&m.data[y])m.data[y][x]=10;if(r.id!=null){const ex=G.items.find(it=>it.id===r.id);const cnt=r.count||1;if(ex)ex.count+=cnt;else G.items.push({id:r.id,count:cnt});showMsg('たからばこから\n'+r.name+'を みつけた！')}else if(r.weapon!=null){G.party[0].weapon=r.weapon;showMsg('たからばこから\n'+r.name+'を みつけた！\nそうびした！')}else if(r.armor!=null){G.party[0].armor=r.armor;showMsg('たからばこから\n'+r.name+'を みつけた！\nそうびした！')}}
function useInn(){const cost=G.innPrice*G.party.length;if(G.gold<cost){showMsg('ゴールドが たりない！\n('+cost+'G ひつよう)');return}G.gold-=cost;G.party.forEach(c=>{if(c.alive){c.hp=c.maxHp;c.mp=c.maxMp;c.status=[]}});showMsg('ゆっくり やすんだ。\nHPとMPが かいふくした！\n('+cost+'G)')}
function mkHargon(){const w=16,h=16,m=[];for(let y=0;y<h;y++){m[y]=[];for(let x=0;x<w;x++)m[y][x]=5}
// Entrance corridor
for(let y=13;y>=10;y--)m[y][8]=6;
// Main hall
for(let y=6;y<=10;y++)for(let x=4;x<=12;x++)m[y][x]=6;
// Corridor to Hargon
for(let y=5;y>=3;y--)m[y][8]=6;
// Hargon room
for(let y=2;y<=4;y++)for(let x=6;x<=10;x++)m[y][x]=6;
// Side rooms
for(let y=7;y<=9;y++){for(let x=1;x<=3;x++)m[y][x]=6;for(let x=13;x<=15;x++)m[y][x]=6}
m[8][3]=6;m[8][13]=6;
// Exit
m[14][8]=6;m[15][8]=6;
return m}
function drawMap(){const map=G.mapId==='world'?worldMap:G.maps[G.mapId].data;const mw=G.mapId==='world'?WORLD_W:G.maps[G.mapId].w;const mh=G.mapId==='world'?WORLD_H:G.maps[G.mapId].h;G.cam.x=Math.max(0,Math.min(G.px-Math.floor(COLS/2),mw-COLS));G.cam.y=Math.max(0,Math.min(G.py-Math.floor(ROWS/2),mh-ROWS));for(let sy=0;sy<ROWS+1;sy++)for(let sx=0;sx<COLS+1;sx++){const mx=G.cam.x+sx,my=G.cam.y+sy;if(mx<0||mx>=mw||my<0||my>=mh)continue;const tid=map[my][mx];let tn=G.mapId==='world'?(TILE_NAMES[tid]||'grass'):(INDOOR[tid]||'floor');if(TL[tn])ctx.drawImage(TL[tn],(mx-G.cam.x)*T,(my-G.cam.y)*T)}}
function drawPlayer(){const ds=['down','up','left','right'];const sx=(G.px-G.cam.x)*T,sy=(G.py-G.cam.y)*T;if(G.onShip&&G.mapId==='world'){ctx.fillStyle='#8B4513';ctx.fillRect(sx+1,sy+4,14,10);ctx.fillStyle='#daa520';ctx.fillRect(sx+6,sy+1,2,12);ctx.fillStyle='#fff';ctx.fillRect(sx+8,sy+2,5,4)}const sp='hero_'+ds[G.pdir];if(TL[sp])ctx.drawImage(TL[sp],sx,sy);if(G.hasShip&&!G.onShip&&G.mapId==='world'){const bx=(G.shipX-G.cam.x)*T,by=(G.shipY-G.cam.y)*T;if(bx>-T&&bx<SW&&by>-T&&by<SH){ctx.fillStyle='#8B4513';ctx.fillRect(bx+1,by+4,14,10);ctx.fillStyle='#daa520';ctx.fillRect(bx+6,by+1,2,12)}}}
function tryMove(dx,dy){const nx=G.px+dx,ny=G.py+dy;const map=G.mapId==='world'?worldMap:G.maps[G.mapId].data;const mw=G.mapId==='world'?WORLD_W:G.maps[G.mapId].w;const mh=G.mapId==='world'?WORLD_H:G.maps[G.mapId].h;if(nx<0||nx>=mw||ny<0||ny>=mh)return false;const tid=map[ny][nx];if(G.mapId==='world'){if(tid===1){if(!G.hasShip)return false;if(!G.onShip){if(Math.abs(nx-G.shipX)+Math.abs(ny-G.shipY)>1)return false;G.onShip=true}};if(tid!==1&&G.onShip){G.onShip=false;G.shipX=G.px;G.shipY=G.py}if(tid===3)return false;if(tid!==1&&!WALKABLE[tid])return false}else{if(tid===5)return false}
// NPC collision check - prevent walking onto NPCs
if(G.mapId!=='world'){const npcs=G.npcs[G.mapId];if(npcs&&npcs.some(n=>n.x===nx&&n.y===ny))return false}G.px=nx;G.py=ny;G.steps++;const wk=G.mapId+'_'+nx+'_'+ny;if(G.warps[wk]){const w=G.warps[wk];G.mapId=w.map;G.px=w.x;G.py=w.y;if(w.map!=='world'&&!G.visited.includes(w.map))G.visited.push(w.map);return true}if(G.mapId!=='world'&&tid===9){openChest(G.mapId,nx,ny);return true}
if(G.mapId==='world'&&tid!==6&&tid!==7&&tid!==8&&tid!==9&&tid!==10&&Math.random()*32<1)startBattle();else if(G.mapId!=='world'&&G.maps[G.mapId].er>0&&Math.random()*G.maps[G.mapId].er<1)startBattle();if(G.mapId==='world'&&tid===5)G.party.forEach(c=>{if(c.alive)c.hp=Math.max(1,c.hp-1)});return true}
function startBattle(bossName){const zone=bossName?3:(G.mapId==='world'?getZone(G.px,G.py):(G.maps[G.mapId].zone||0));let pool;if(bossName)pool=MONSTERS.filter(m=>m.name===bossName);else pool=MONSTERS.filter(m=>m.zone.includes(zone));if(pool.length===0)return;const count=bossName?1:1+Math.floor(Math.random()*3);const enemies=[];for(let i=0;i<count;i++){const m=pool[Math.floor(Math.random()*pool.length)];enemies.push({...m,hp:m.hp,maxHp:m.hp,alive:true,status:[]})}G.bs={enemies,cursor:0,spellCursor:0,itemCursor:0,partyActs:[],curActor:0,msg:'まものが あらわれた！',msgTimer:60,phase:'msg',nextPhase:'select',resultMsgs:[],resultIdx:0};G.state=GS.BATTLE}
function updateBattle(){const bs=G.bs;if(!bs)return;if(bs.phase==='msg'){bs.msgTimer--;if(bs.msgTimer<=0||kp('KeyZ')||kp('Enter')){if(bs.nextPhase){bs.phase=bs.nextPhase;bs.nextPhase=null}else bs.phase='select';bs.msg=''}return}if(bs.phase==='start'){bs.phase='select';bs.cursor=0;bs.partyActs=[];bs.curActor=0}if(bs.phase==='select'){const a=G.party[bs.curActor];if(!a||!a.alive){bs.curActor++;if(bs.curActor>=G.party.length){bs.phase='exec';bs.curActor=0}return}if(kp('ArrowUp'))bs.cursor=(bs.cursor-1+5)%5;if(kp('ArrowDown'))bs.cursor=(bs.cursor+1)%5;if(kp('KeyZ')||kp('Enter')){if(bs.cursor===0){bs.partyActs.push({ai:bs.curActor,type:'atk',tgt:0});bs.curActor++;bs.cursor=0}else if(bs.cursor===1){if(a.spells.length>0){bs.phase='spell';bs.spellCursor=0}else{bs.msg='じゅもんを おぼえていない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}}else if(bs.cursor===2){const sk=a.learnedSkills.filter(k=>SPELLS[k]);if(sk.length>0){bs.phase='skill';bs.skillCursor=0}else{bs.msg='とくぎを おぼえていない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}}else if(bs.cursor===3){if(G.items.length>0){bs.phase='item';bs.itemCursor=0}else{bs.msg='どうぐがない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}}else if(bs.cursor===4){if(bs.enemies.some(e=>e.boss)){bs.msg='ボスからは にげられない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='select'}else if(Math.random()>0.5){bs.msg='うまく にげきれた！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='end'}else{bs.msg='にげられない！';bs.msgTimer=40;bs.phase='msg';bs.partyActs.push({ai:bs.curActor,type:'def'});bs.curActor++;bs.nextPhase='select'}}}if(bs.curActor>=G.party.length&&bs.phase==='select'){bs.phase='exec';bs.curActor=0}}if(bs.phase==='spell'){const a=G.party[bs.curActor];if(!a){bs.phase='select';return}if(kp('ArrowUp'))bs.spellCursor=Math.max(0,bs.spellCursor-1);if(kp('ArrowDown'))bs.spellCursor=Math.min(a.spells.length-1,bs.spellCursor);if(kp('KeyZ')||kp('Enter')){const sp=SPELLS[a.spells[bs.spellCursor]];if(a.mp<sp.mp){bs.msg='MPが たりない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='spell'}else{bs.partyActs.push({ai:bs.curActor,type:'spell',spell:a.spells[bs.spellCursor],tgt:0});bs.curActor++;bs.spellCursor=0;bs.phase='select'}}if(kp('KeyX')||kp('Escape')){bs.phase='select';bs.cursor=1}}if(bs.phase==='item'){if(kp('ArrowUp'))bs.itemCursor=Math.max(0,bs.itemCursor-1);if(kp('ArrowDown'))bs.itemCursor=Math.min(G.items.length-1,bs.itemCursor);if(kp('KeyZ')||kp('Enter')){bs.partyActs.push({ai:bs.curActor,type:'item',itemId:G.items[bs.itemCursor].id});bs.curActor++;bs.itemCursor=0;bs.phase='select'}if(kp('KeyX')||kp('Escape')){bs.phase='select';bs.cursor=3}}if(bs.phase==='skill'){const a=G.party[bs.curActor];if(!a){bs.phase='select';return}const sk=a.learnedSkills.filter(k=>SPELLS[k]);if(kp('ArrowUp'))bs.skillCursor=Math.max(0,bs.skillCursor-1);if(kp('ArrowDown'))bs.skillCursor=Math.min(sk.length-1,bs.skillCursor);if(kp('KeyZ')||kp('Enter')){if(sk.length>0){const sp=SPELLS[sk[bs.skillCursor]];if(sp.mp>0&&a.mp<sp.mp){bs.msg='MPが たりない！';bs.msgTimer=40;bs.phase='msg';bs.nextPhase='skill'}else{bs.partyActs.push({ai:bs.curActor,type:'spell',spell:sk[bs.skillCursor],tgt:0});bs.curActor++;bs.skillCursor=0;bs.phase='select'}}}if(kp('KeyX')||kp('Escape')){bs.phase='select';bs.cursor=2}}if(bs.phase==='exec')execBattle();if(bs.phase==='result'){bs.msgTimer--;if(bs.msgTimer<=0){if(bs.resultIdx<bs.resultMsgs.length){bs.msg=bs.resultMsgs[bs.resultIdx];bs.resultIdx++;bs.msgTimer=50}else if(kp('KeyZ')||kp('Enter')||bs.msgTimer<-60){const allED=bs.enemies.every(e=>!e.alive),allPD=G.party.every(c=>!c.alive);if(allPD)G.state=GS.GAMEOVER;else if(G.flags.sidoDown)G.state=GS.ENDING;else if(allED)bs.phase='end';else{bs.phase='select';bs.cursor=0;bs.partyActs=[];bs.curActor=0;bs.msg=''}}}}if(bs.phase==='end'){G.state=GS.EXPLORE;G.bs=null;G.party.forEach(c=>{c.atkBuf=0;c.defBuf=0})}}
function execBattle(){const bs=G.bs,acts=[];bs.partyActs.forEach(a=>{const ac=G.party[a.ai];if(ac&&ac.alive)acts.push({...a,agi:ac.agi,isP:true,obj:ac})});bs.enemies.forEach((e,i)=>{if(!e.alive)return;let t='atk';if(e.spells.length>0&&e.mp>0&&Math.random()>0.5)t='spell';acts.push({type:t,ai:i,isP:false,obj:e,agi:e.agi,spell:t==='spell'?e.spells[Math.floor(Math.random()*e.spells.length)]:null,tgt:Math.floor(Math.random()*G.party.length)})});acts.sort((a,b)=>b.agi-a.agi);const ms=[];for(const act of acts){if(act.isP){const a=act.obj;if(!a.alive)continue;if(a.status.includes('sleep')){if(Math.random()>0.5)a.status=a.status.filter(s=>s!=='sleep');ms.push(a.name+'は ねている。');continue}if(act.type==='atk'){const al=bs.enemies.filter(e=>e.alive);if(al.length===0)continue;const t=al[Math.floor(Math.random()*al.length)];const w=a.weapon!=null?WEAPONS[a.weapon]:null;const hits=w&&w.hits?w.hits:1;let td=0;for(let h=0;h<hits;h++){const d=Math.max(1,Math.floor(a.atk-t.def/2+Math.random()*4-2));t.hp-=d;td+=d}ms.push(a.name+'のこうげき！ '+t.name+'に '+td+'ダメージ！');if(t.hp<=0){t.alive=false;ms.push(t.name+'を たおした！')}}else if(act.type==='spell'){const sp=SPELLS[act.spell];a.mp-=sp.mp;if(sp.type==='damage'){const al=bs.enemies.filter(e=>e.alive);al.forEach(e=>{const d=Math.max(1,Math.floor(sp.power+Math.random()*10-e.def/4));e.hp-=d;if(e.hp<=0){e.alive=false;ms.push(e.name+'を たおした！')}});ms.push(a.name+'は '+sp.name+'！')}else if(sp.type==='heal'){const t=G.party.find(c=>c.alive&&c.hp<c.maxHp)||a;t.hp=Math.min(t.maxHp,t.hp+sp.power);ms.push(a.name+'は '+sp.name+'！ '+t.name+'のHPかいふく！')}else if(sp.type==='buff'){if(sp.effect==='def_up'){G.party.forEach(c=>{if(c.alive)c.defBuf+=10});ms.push(a.name+'は '+sp.name+'！ しゅびりょくUP！')}else if(sp.effect==='atk_up'){a.atkBuf+=15;ms.push(a.name+'は '+sp.name+'！ こうげきりょくUP！')}}else if(sp.type==='status'){const al=bs.enemies.filter(e=>e.alive);if(al.length>0){const t=al[Math.floor(Math.random()*al.length)];if(Math.random()>0.3){t.status.push('sleep');ms.push(a.name+'は '+sp.name+'！ '+t.name+'は ねむった！')}else ms.push(a.name+'は '+sp.name+'！ しかし きかなかった！')}}else if(sp.type==='revive'){const t=G.party.find(c=>!c.alive);if(t){t.alive=true;t.hp=t.maxHp;ms.push(a.name+'は '+sp.name+'！ '+t.name+'は いきかえった！')}else ms.push(a.name+'は '+sp.name+'！ しかし だれも たおれていない。')}else if(sp.type==='madante'){const dmg=a.mp*3;a.mp=0;const al=bs.enemies.filter(e=>e.alive);al.forEach(e=>{e.hp-=dmg;if(e.hp<=0){e.alive=false;ms.push(e.name+'を たおした！')}});ms.push(a.name+'は マダンテ！ '+dmg+'ダメージ！')}else if(sp.type==='damage_multi'){const al=bs.enemies.filter(e=>e.alive);const h=sp.hits||2;let td=0;for(let hi=0;hi<h;hi++){if(al.length===0)break;const t=al[Math.floor(Math.random()*al.length)];const d=Math.max(1,Math.floor(sp.power+Math.random()*8-t.def/4));t.hp-=d;td+=d;if(t.hp<=0){t.alive=false;ms.push(t.name+'を たおした！');al.splice(al.indexOf(t),1)}}ms.push(a.name+'は '+sp.name+'！ '+td+'ダメージ！')}else if(sp.type==='drain_mp'){const al=bs.enemies.filter(e=>e.alive);if(al.length>0){const t=al[Math.floor(Math.random()*al.length)];const drain=Math.min(t.mp,sp.power);t.mp-=drain;a.mp=Math.min(a.maxMp,a.mp+drain);ms.push(a.name+'は '+sp.name+'！ '+drain+'MP うばった！')}else ms.push(a.name+'は '+sp.name+'！ しかし きかなかった！')}else if(sp.type==='steal'){const al=bs.enemies.filter(e=>e.alive);if(al.length>0){const t=al[Math.floor(Math.random()*al.length)];if(Math.random()>0.4){const sg=Math.floor(t.gold*0.5)+1;G.gold+=sg;ms.push(a.name+'は '+sp.name+'！ '+sg+'Gを ぬすんだ！')}else ms.push(a.name+'は '+sp.name+'！ しかし しっぱいした！')}else ms.push(a.name+'は '+sp.name+'！')}else if(sp.type==='identify'){const al=bs.enemies.filter(e=>e.alive);if(al.length>0){const t=al[Math.floor(Math.random()*al.length)];ms.push(a.name+'は '+sp.name+'！ '+t.name+' HP:'+t.hp+'/'+t.maxHp)}else ms.push(a.name+'は '+sp.name+'！')}else if(sp.type==='megante'){a.hp=0;a.alive=false;const al=bs.enemies.filter(e=>e.alive);al.forEach(e=>{const d=Math.floor(a.maxHp*1.5);e.hp-=d;if(e.hp<=0){e.alive=false;ms.push(e.name+'を たおした！')}});ms.push(a.name+'は メガンテ！ いのちを ささげた！')}else if(sp.type==='mp_give'){const t=G.party.find(c=>c.alive&&c!==a&&c.mp<c.maxMp);if(t){const give=Math.min(a.mp,Math.floor(a.maxMp/2));a.mp-=give;t.mp=Math.min(t.maxMp,t.mp+give);ms.push(a.name+'は '+sp.name+'！ '+t.name+'に '+give+'MP わたした！')}else ms.push(a.name+'は '+sp.name+'！ しかし こうかがなかった！')}else{ms.push(a.name+'は '+sp.name+'！')}if(sp.selfDmg){const sd=Math.floor(a.maxHp*sp.selfDmg);a.hp-=sd;if(a.hp<=0){a.hp=0;a.alive=false;ms.push(a.name+'は ちからつきた…')}}}else if(act.type==='item'){const itIdx=G.items.findIndex(i=>i.id===act.itemId);if(itIdx>=0){const it=G.items[itIdx];const item=ITEMS[it.id];if(item.type==='heal'){a.hp=Math.min(a.maxHp,a.hp+item.power);ms.push(a.name+'は '+item.name+'を つかった！ HPが '+item.power+' かいふく！');it.count--;if(it.count<=0)G.items.splice(itIdx,1)}else if(item.type==='revive'){const t=G.party.find(c=>!c.alive);if(t){t.alive=true;t.hp=t.maxHp;ms.push(a.name+'は '+item.name+'を つかった！ '+t.name+'は いきかえった！');it.count--;if(it.count<=0)G.items.splice(itIdx,1)}else{ms.push(a.name+'は '+item.name+'を つかった！ しかし こうかがなかった！')}}else{ms.push(a.name+'は '+item.name+'を つかった！ しかし こうかがなかった！')}}}}else{const e=act.obj;if(!e.alive)continue;if(e.flee&&Math.random()<e.flee){e.alive=false;ms.push(e.name+'は にげだした！');continue}if(e.status.includes('sleep')){if(Math.random()>0.5)e.status=e.status.filter(s=>s!=='sleep');ms.push(e.name+'は ねている。');continue}const ap=G.party.filter(c=>c.alive);if(ap.length===0)continue;const t=ap[Math.floor(Math.random()*ap.length)];if(act.type==='atk'){const d=Math.max(1,Math.floor(e.atk-t.def/2+Math.random()*4-2));t.hp-=d;ms.push(e.name+'のこうげき！ '+t.name+'に '+d+'ダメージ！');if(t.hp<=0){t.hp=0;t.alive=false;ms.push(t.name+'は ちからつきた…')}}else if(act.type==='spell'){const sp=SPELLS[act.spell];if(e.mp<sp.mp){const d=Math.max(1,Math.floor(e.atk-t.def/2+Math.random()*4-2));t.hp-=d;ms.push(e.name+'のこうげき！ '+t.name+'に '+d+'ダメージ！');if(t.hp<=0){t.hp=0;t.alive=false;ms.push(t.name+'は ちからつきた…')}}else{e.mp-=sp.mp;if(sp.type==='damage'){ap.forEach(c=>{const d=Math.max(1,Math.floor(sp.power+Math.random()*8-c.def/4));c.hp-=d;if(c.hp<=0){c.hp=0;c.alive=false;ms.push(c.name+'は ちからつきた…')}});ms.push(e.name+'は '+sp.name+'！')}else if(sp.type==='heal'){e.hp=Math.min(e.maxHp,e.hp+sp.power);ms.push(e.name+'は '+sp.name+'！ HPかいふく！')}}}}}const allED=bs.enemies.every(e=>!e.alive),allPD=G.party.every(c=>!c.alive);if(allED){let te=0,tg=0;bs.enemies.forEach(e=>{te+=e.exp;tg+=e.gold});G.gold+=tg;ms.push('かった！ '+te+'EXP '+tg+'G かくとく！');G.party.forEach(c=>{if(!c.alive)return;c.exp+=te;if(c.lvUp())ms.push(c.name+' Lv'+c.level+'に UP！')});bs.enemies.forEach(e=>{if(e.name==='ハーゴン')G.flags.hargonDown=true;if(e.name==='シドー'){G.flags.sidoDown=true;ms.push('へいわが おとずれた…！')}});
// 熟練度獲得
const bzone=G.mapId==='world'?getZone(G.px,G.py):(G.maps[G.mapId]?G.maps[G.mapId].zone||0:0);
G.party.forEach(c=>{if(!c.alive||c.job==='none')return;const p=c.jobProf[c.job]||0;if(p>=8)return;if(p>=bzone*2+4)return;c.jobProf[c.job]=(c.jobProf[c.job]||0)+1;const j=JOBS[c.job];if(j&&j.skills){for(const[rp,sk]of j.skills){if(c.jobProf[c.job]>=rp&&!c.learnedSkills.includes(sk)){c.learnedSkills.push(sk);ms.push(c.name+'は '+((SPELLS[sk]||{}).name||sk)+'を おぼえた！')}}}if(c.jobProf[c.job]>=8)ms.push(c.name+'は '+j.name+'を きわめた！')})}if(allPD)ms.push('ぜんめつ…');bs.phase='result';bs.resultMsgs=ms;bs.resultIdx=0;bs.msgTimer=0}
function drawMonster(c,x,y,name){
switch(name){
case'スライム':
// 水色の水滴形
c.fillStyle='#5cf';c.fillRect(x-6,y-2,12,10);c.fillRect(x-8,y+2,16,6);c.fillRect(x-4,y-6,8,6);c.fillRect(x-2,y-8,4,4);
// ハイライト
c.fillStyle='#8ef';c.fillRect(x-4,y-4,3,3);
// 目
c.fillStyle='#000';c.fillRect(x-4,y,2,3);c.fillRect(x+2,y,2,3);
// 口
c.fillRect(x-2,y+4,4,1);
break;
case'おおなめくじ':
// 紫の楕円体
c.fillStyle='#808';c.fillRect(x-10,y+2,20,8);c.fillRect(x-8,y-2,16,12);c.fillRect(x-6,y-4,12,4);
// ハイライト
c.fillStyle='#a2a';c.fillRect(x-6,y-2,6,3);
// 触角
c.fillStyle='#606';c.fillRect(x-6,y-6,2,4);c.fillRect(x+4,y-6,2,4);c.fillRect(x-7,y-8,2,3);c.fillRect(x+5,y-8,2,3);
// 目
c.fillStyle='#ff0';c.fillRect(x-4,y+1,2,2);c.fillRect(x+2,y+1,2,2);
break;
case'アイアンアント':
// 赤茶色の体
c.fillStyle='#a33';c.fillRect(x-4,y-2,8,6);c.fillRect(x-8,y,4,4);c.fillRect(x+4,y,4,4);
// 頭
c.fillStyle='#822';c.fillRect(x-3,y-6,6,5);
// 顎
c.fillRect(x-4,y-8,2,3);c.fillRect(x+2,y-8,2,3);
// 脚6本
c.fillStyle='#611';
c.fillRect(x-10,y-1,3,1);c.fillRect(x-10,y+2,3,1);c.fillRect(x-10,y+5,3,1);
c.fillRect(x+7,y-1,3,1);c.fillRect(x+7,y+2,3,1);c.fillRect(x+7,y+5,3,1);
// 目
c.fillStyle='#ff0';c.fillRect(x-2,y-5,1,1);c.fillRect(x+1,y-5,1,1);
break;
case'ドラキー':
// 青い翼
c.fillStyle='#22a';c.fillRect(x-12,y-4,24,6);c.fillRect(x-10,y-8,4,6);c.fillRect(x+6,y-8,4,6);
c.fillRect(x-12,y-6,3,3);c.fillRect(x+9,y-6,3,3);
// 体
c.fillStyle='#33c';c.fillRect(x-4,y-4,8,10);c.fillRect(x-2,y-6,4,3);
// 目
c.fillStyle='#ff0';c.fillRect(x-3,y-2,2,2);c.fillRect(x+1,y-2,2,2);
c.fillStyle='#000';c.fillRect(x-2,y-1,1,1);c.fillRect(x+2,y-1,1,1);
// 口(牙)
c.fillStyle='#fff';c.fillRect(x-2,y+3,1,2);c.fillRect(x+1,y+3,1,2);
break;
case'バブルスライム':
// 緑のスライム体
c.fillStyle='#0a0';c.fillRect(x-6,y-2,12,10);c.fillRect(x-8,y+2,16,6);c.fillRect(x-4,y-6,8,6);c.fillRect(x-2,y-8,4,4);
// 毒々しいハイライト
c.fillStyle='#0d0';c.fillRect(x-4,y-4,3,3);
// 目
c.fillStyle='#000';c.fillRect(x-4,y,2,3);c.fillRect(x+2,y,2,3);
// 口
c.fillRect(x-2,y+4,4,1);
// 泡
c.fillStyle='#8f8';c.fillRect(x+6,y-8,3,3);c.fillRect(x+4,y-5,2,2);c.fillRect(x-8,y-6,2,2);c.fillRect(x+8,y-4,2,2);
break;
case'マンドリル':
// 茶色の体
c.fillStyle='#840';c.fillRect(x-6,y-4,12,14);c.fillRect(x-8,y+2,16,6);
// 頭
c.fillRect(x-5,y-8,10,6);
// 赤い顔
c.fillStyle='#e22';c.fillRect(x-3,y-6,6,5);
// 目
c.fillStyle='#fff';c.fillRect(x-2,y-5,2,2);c.fillRect(x+1,y-5,2,2);
c.fillStyle='#000';c.fillRect(x-1,y-4,1,1);c.fillRect(x+2,y-4,1,1);
// 鼻
c.fillStyle='#c00';c.fillRect(x-1,y-2,2,2);
// 腕
c.fillStyle='#840';c.fillRect(x-10,y,4,8);c.fillRect(x+6,y,4,8);
break;
case'リビングデッド':
// 灰色の体
c.fillStyle='#686';c.fillRect(x-5,y-4,10,14);
// 頭
c.fillStyle='#797';c.fillRect(x-4,y-10,8,8);
// 目(くぼんだ)
c.fillStyle='#300';c.fillRect(x-3,y-8,2,2);c.fillRect(x+1,y-8,2,2);
// 口(開いた)
c.fillStyle='#200';c.fillRect(x-2,y-4,4,2);
// 腕
c.fillStyle='#686';c.fillRect(x-9,y-2,5,3);c.fillRect(x+4,y-2,5,3);
// ボロ衣
c.fillStyle='#554';c.fillRect(x-6,y+2,12,6);c.fillRect(x-4,y+8,2,2);c.fillRect(x+2,y+8,2,2);
break;
case'まじゅつし':
// 紫のローブ
c.fillStyle='#60a';c.fillRect(x-6,y-4,12,14);c.fillRect(x-8,y+4,16,6);
// フード
c.fillStyle='#508';c.fillRect(x-5,y-10,10,8);c.fillRect(x-3,y-12,6,4);
// 顔
c.fillStyle='#fdb';c.fillRect(x-3,y-6,6,4);
// 目
c.fillStyle='#f00';c.fillRect(x-2,y-5,1,1);c.fillRect(x+1,y-5,1,1);
// 杖
c.fillStyle='#a70';c.fillRect(x+8,y-10,2,20);
c.fillStyle='#ff0';c.fillRect(x+7,y-12,4,3);
break;
case'バピラス':
// 緑の翼竜体
c.fillStyle='#2a4';c.fillRect(x-4,y-2,8,10);
// 頭
c.fillStyle='#2a4';c.fillRect(x-3,y-8,6,7);
c.fillStyle='#184';c.fillRect(x-5,y-6,2,3);
// 翼
c.fillStyle='#3b5';c.fillRect(x-12,y-6,10,4);c.fillRect(x+2,y-6,10,4);
c.fillRect(x-12,y-8,4,3);c.fillRect(x+8,y-8,4,3);
// 目
c.fillStyle='#ff0';c.fillRect(x-2,y-6,2,2);c.fillRect(x+1,y-6,2,2);
// 口
c.fillStyle='#a62';c.fillRect(x-4,y-3,8,2);
// 脚
c.fillStyle='#184';c.fillRect(x-3,y+8,2,3);c.fillRect(x+1,y+8,2,3);
break;
case'ドラゴン':
// オレンジの大きな竜体
c.fillStyle='#d80';c.fillRect(x-8,y-2,16,12);
// 頭
c.fillStyle='#e90';c.fillRect(x-6,y-10,12,10);
c.fillRect(x-8,y-6,4,4);
// 角
c.fillStyle='#a60';c.fillRect(x-4,y-12,2,4);c.fillRect(x+3,y-12,2,4);
// 目
c.fillStyle='#f00';c.fillRect(x-4,y-7,3,2);c.fillRect(x+2,y-7,3,2);
c.fillStyle='#000';c.fillRect(x-3,y-6,1,1);c.fillRect(x+3,y-6,1,1);
// 口・牙
c.fillStyle='#a60';c.fillRect(x-6,y-3,12,2);
c.fillStyle='#fff';c.fillRect(x-5,y-2,2,2);c.fillRect(x+3,y-2,2,2);
// 翼
c.fillStyle='#c70';c.fillRect(x-12,y-8,6,8);c.fillRect(x+6,y-8,6,8);
break;
case'キラーマシン':
// メタリック体
c.fillStyle='#889';c.fillRect(x-5,y-4,10,14);
// 頭
c.fillStyle='#99a';c.fillRect(x-4,y-10,8,7);
// 目(赤いレンズ)
c.fillStyle='#f00';c.fillRect(x-3,y-8,2,2);c.fillRect(x+1,y-8,2,2);
// 腕(右に弓)
c.fillStyle='#778';c.fillRect(x-9,y-4,5,3);c.fillRect(x+4,y-4,5,3);
// 弓
c.fillStyle='#a70';c.fillRect(x+9,y-10,2,16);c.fillStyle='#ccc';c.fillRect(x+9,y-10,1,1);c.fillRect(x+9,y+5,1,1);
// 脚
c.fillStyle='#778';c.fillRect(x-4,y+8,3,3);c.fillRect(x+1,y+8,3,3);
// 装甲ライン
c.fillStyle='#aab';c.fillRect(x-4,y-2,8,1);c.fillRect(x-4,y+4,8,1);
break;
case'フレイム':
// 赤い炎の塊
c.fillStyle='#e30';c.fillRect(x-6,y-2,12,10);c.fillRect(x-4,y-6,8,6);
c.fillStyle='#f80';c.fillRect(x-4,y-4,8,8);
c.fillStyle='#fd0';c.fillRect(x-2,y-2,4,6);
// 炎の先端
c.fillStyle='#f40';c.fillRect(x-2,y-10,4,6);c.fillRect(x-6,y-8,3,4);c.fillRect(x+3,y-8,3,4);
c.fillStyle='#f80';c.fillRect(x,y-12,2,4);
// 目
c.fillStyle='#fff';c.fillRect(x-3,y,2,2);c.fillRect(x+1,y,2,2);
break;
case'はぐれメタル':
// 銀色のスライム形(小さめ)
c.fillStyle='#ccd';c.fillRect(x-5,y-1,10,8);c.fillRect(x-7,y+2,14,4);c.fillRect(x-3,y-4,6,5);c.fillRect(x-1,y-6,2,3);
// ハイライト
c.fillStyle='#eef';c.fillRect(x-3,y-2,3,2);
// 影
c.fillStyle='#99a';c.fillRect(x+2,y+3,4,3);
// 目
c.fillStyle='#000';c.fillRect(x-3,y+1,2,2);c.fillRect(x+1,y+1,2,2);
// 口
c.fillRect(x-1,y+4,2,1);
break;
case'ギガンテス':
// 肌色の巨体
c.fillStyle='#da8';c.fillRect(x-8,y-4,16,16);
// 頭
c.fillRect(x-6,y-12,12,10);
// 目
c.fillStyle='#000';c.fillRect(x-4,y-9,3,2);c.fillRect(x+1,y-9,3,2);
// 口
c.fillStyle='#800';c.fillRect(x-3,y-4,6,2);
// 棍棒
c.fillStyle='#860';c.fillRect(x+8,y-12,4,22);c.fillStyle='#640';c.fillRect(x+8,y-12,4,4);
// 腕
c.fillStyle='#c96';c.fillRect(x-12,y-2,5,4);c.fillRect(x+7,y-2,5,4);
// パンツ
c.fillStyle='#a60';c.fillRect(x-8,y+6,16,6);
break;
case'アークデーモン':
// 紫の体
c.fillStyle='#60a';c.fillRect(x-6,y-4,12,14);
// 頭
c.fillStyle='#70b';c.fillRect(x-5,y-10,10,8);
// 角
c.fillStyle='#a0e';c.fillRect(x-6,y-12,2,4);c.fillRect(x+4,y-12,2,4);
// 目
c.fillStyle='#f00';c.fillRect(x-3,y-8,2,2);c.fillRect(x+1,y-8,2,2);
// 翼
c.fillStyle='#508';c.fillRect(x-12,y-6,8,8);c.fillRect(x+4,y-6,8,8);
c.fillRect(x-12,y-8,3,4);c.fillRect(x+9,y-8,3,4);
// 口
c.fillStyle='#a00';c.fillRect(x-2,y-4,4,2);
// 脚
c.fillStyle='#508';c.fillRect(x-4,y+8,3,3);c.fillRect(x+1,y+8,3,3);
break;
case'ブリザード':
// 水色の氷の精霊
c.fillStyle='#6cf';c.fillRect(x-5,y-2,10,12);c.fillRect(x-3,y-6,6,6);
// 氷の結晶
c.fillStyle='#aef';c.fillRect(x-2,y-10,4,6);c.fillRect(x-8,y-4,4,2);c.fillRect(x+4,y-4,4,2);
c.fillStyle='#cff';c.fillRect(x-1,y-12,2,4);c.fillRect(x-6,y-6,2,2);c.fillRect(x+4,y-6,2,2);
// 目
c.fillStyle='#009';c.fillRect(x-3,y-2,2,2);c.fillRect(x+1,y-2,2,2);
// 口
c.fillStyle='#06a';c.fillRect(x-2,y+3,4,2);
// 下部(消える感じ)
c.fillStyle='#4af';c.fillRect(x-3,y+8,2,2);c.fillRect(x+1,y+8,2,2);
break;
case'あくましんかん':
// 黒いローブ
c.fillStyle='#222';c.fillRect(x-6,y-4,12,14);c.fillRect(x-8,y+4,16,6);
// フード
c.fillStyle='#111';c.fillRect(x-5,y-10,10,8);c.fillRect(x-3,y-12,6,4);
// 顔(暗い)
c.fillStyle='#a88';c.fillRect(x-3,y-6,6,4);
// 目(光る)
c.fillStyle='#f0f';c.fillRect(x-2,y-5,1,1);c.fillRect(x+1,y-5,1,1);
// 杖
c.fillStyle='#606';c.fillRect(x+8,y-10,2,20);
c.fillStyle='#f0f';c.fillRect(x+7,y-12,4,3);
break;
case'ハーゴン':
// 青い大きなローブ
c.fillStyle='#22a';c.fillRect(x-8,y-4,16,16);c.fillRect(x-10,y+4,20,8);
// フード
c.fillStyle='#118';c.fillRect(x-6,y-12,12,10);c.fillRect(x-4,y-14,8,4);
// 角
c.fillStyle='#a00';c.fillRect(x-6,y-16,2,6);c.fillRect(x+4,y-16,2,6);
// 顔
c.fillStyle='#a8f';c.fillRect(x-4,y-8,8,5);
// 目(光る)
c.fillStyle='#f00';c.fillRect(x-3,y-7,2,2);c.fillRect(x+1,y-7,2,2);
// 杖
c.fillStyle='#aa0';c.fillRect(x+10,y-14,2,24);
c.fillStyle='#ff0';c.fillRect(x+9,y-16,4,4);
// ローブ装飾
c.fillStyle='#44c';c.fillRect(x-6,y+2,12,2);
break;
case'シドー':
// 紫+赤の巨大な悪魔
c.fillStyle='#808';c.fillRect(x-10,y-4,20,16);
// 頭
c.fillStyle='#a08';c.fillRect(x-8,y-14,16,12);
// 角
c.fillStyle='#c00';c.fillRect(x-8,y-18,3,6);c.fillRect(x+5,y-18,3,6);
// 目(3つ)
c.fillStyle='#ff0';c.fillRect(x-5,y-11,3,2);c.fillRect(x+2,y-11,3,2);c.fillRect(x-1,y-8,2,2);
// 翼
c.fillStyle='#606';c.fillRect(x-14,y-10,6,12);c.fillRect(x+8,y-10,6,12);
c.fillRect(x-14,y-12,3,4);c.fillRect(x+11,y-12,3,4);
// 口
c.fillStyle='#f00';c.fillRect(x-4,y-5,8,3);
c.fillStyle='#fff';c.fillRect(x-3,y-4,2,2);c.fillRect(x+1,y-4,2,2);
// 尾
c.fillStyle='#606';c.fillRect(x-6,y+10,4,2);c.fillRect(x-10,y+8,5,2);c.fillRect(x-12,y+6,4,2);
break;
default:
// フォールバック
c.fillStyle='#c80';c.fillRect(x-12,y-12,24,24);
c.fillStyle='#fff';c.fillRect(x-6,y-6,4,4);c.fillRect(x+2,y-6,4,4);
c.fillStyle='#000';c.fillRect(x-4,y+2,8,2);
}}
function drawBattle(){const bs=G.bs;if(!bs)return;for(let i=0;i<90;i++){const g=Math.floor(8+i*.3);ctx.fillStyle=`rgb(${g},${g},${Math.floor(g*1.5)})`;ctx.fillRect(0,i,SW,1)}ctx.fillStyle='#111';ctx.fillRect(0,90,SW,SH-90);ctx.fillStyle='rgba(68,136,255,0.2)';ctx.fillRect(0,90,SW,1);const al=bs.enemies.filter(e=>e.alive);al.forEach((e,i)=>{const ex=SW/(al.length+1)*(i+1),ey=60;drawMonster(ctx,ex,ey,e.name);dtc(e.name,ex,ey+22,6);dtc('HP'+e.hp,ex,ey+30,5,'#0f0')});dw(SW-120,SH-100,112,92);G.party.forEach((c,i)=>{const y=SH-92+i*28;dt(c.name.slice(0,4),SW-112,y,6,c.alive?'#fff':'#888');drawBar(SW-112,y+4,60,4,c.hp/c.maxHp,c.hp<c.maxHp/4?'#c00':'#0a0',c.hp<c.maxHp/4?'#f44':'#0f0');dt('HP'+c.hp+'/'+c.maxHp,SW-112,y+10,5,'#fff');drawBar(SW-112,y+14,60,3,c.mp/c.maxMp,'#06a','#0af');dt('MP'+c.mp+'/'+c.maxMp,SW-112,y+20,5,'#fff')});if(bs.phase==='select'){const a=G.party[bs.curActor];if(a){dw(8,SH-90,80,82);dt(a.name.slice(0,5),16,SH-80,6,'#ffd700');['たたかう','じゅもん','とくぎ','どうぐ','にげる'].forEach((c,i)=>dt(c,24,SH-68+i*13,7));dc(14,SH-74+bs.cursor*13)}}if(bs.phase==='skill'){const a=G.party[bs.curActor];if(a){const sk=a.learnedSkills.filter(k=>SPELLS[k]);dw(8,8,140,sk.length*14+20);dt('とくぎ',16,24,7,'#ffd700');sk.forEach((s,i)=>{const sp=SPELLS[s];dt((i===bs.skillCursor?'▶':' ')+sp.name+(sp.mp>0?' '+sp.mp:''),16,38+i*14,7)})}}if(bs.phase==='spell'){const a=G.party[bs.curActor];if(a){dw(8,8,120,a.spells.length*14+20);dt('じゅもん',16,24,7,'#ffd700');a.spells.forEach((sp,i)=>{const s=SPELLS[sp];dt((i===bs.spellCursor?'▶':' ')+s.name+' '+s.mp,16,38+i*14,7)})}}if(bs.phase==='item'){dw(8,8,140,G.items.length*14+20);dt('どうぐ',16,24,7,'#ffd700');G.items.forEach((it,i)=>{dt((i===bs.itemCursor?'▶':' ')+ITEMS[it.id].name,16,38+i*14,7)})}if(bs.msg){dw(8,SH-40,SW-16,32);dt(bs.msg,16,SH-22,7)}}
function updateMenu(){if(G.msgT)return;const ms=G.ms;if(!ms)return;if(ms.pg==='main'){const it=['はなす','じゅもん','どうぐ','つよさ','そうび','さくせん','とじる'];if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+it.length)%it.length;if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%it.length;if(kp('KeyZ')||kp('Enter')){switch(ms.cursor){case 0:G.state=GS.EXPLORE;checkInteraction();break;case 1:ms.pg='spell';ms.cursor=0;ms.ci=0;break;case 2:ms.pg='item';ms.cursor=0;break;case 3:ms.pg='status';ms.ci=0;break;case 4:ms.pg='equip';ms.cursor=0;ms.ci=0;break;case 5:ms.pg='sakusen';ms.cursor=0;break;case 6:G.state=GS.EXPLORE;break}}if(kp('KeyX')||kp('Escape'))G.state=GS.EXPLORE}else if(ms.pg==='status'){if(kp('KeyX')||kp('Escape')||kp('KeyZ'))ms.pg='main';if(kp('ArrowLeft'))ms.ci=(ms.ci-1+G.party.length)%G.party.length;if(kp('ArrowRight'))ms.ci=(ms.ci+1)%G.party.length}else if(ms.pg==='item'){if(kp('ArrowUp'))ms.cursor=Math.max(0,ms.cursor-1);if(kp('ArrowDown'))ms.cursor=Math.min(G.items.length-1,ms.cursor);if(kp('KeyZ')||kp('Enter')){if(G.items.length>0)useItem(ms.cursor)}if(kp('KeyX')||kp('Escape'))ms.pg='main'}else if(ms.pg==='spell'){const c=G.party[ms.ci];if(kp('ArrowUp'))ms.cursor=Math.max(0,ms.cursor-1);if(kp('ArrowDown'))ms.cursor=Math.min(c.spells.length-1,ms.cursor);if(kp('ArrowLeft')){ms.ci=(ms.ci-1+G.party.length)%G.party.length;ms.cursor=0}if(kp('ArrowRight')){ms.ci=(ms.ci+1)%G.party.length;ms.cursor=0}if(kp('KeyZ')||kp('Enter')){if(c.spells.length>0)useFieldSpell(c,c.spells[ms.cursor])}if(kp('KeyX')||kp('Escape'))ms.pg='main'}else if(ms.pg==='equip'){const c=G.party[ms.ci];if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+4)%4;if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%4;if(kp('ArrowLeft')){ms.ci=(ms.ci-1+G.party.length)%G.party.length;ms.cursor=0}if(kp('ArrowRight')){ms.ci=(ms.ci+1)%G.party.length;ms.cursor=0}if(kp('KeyZ')||kp('Enter')){if(ms.cursor===0&&c.weapon!=null){c.weapon=null;showMsg('ぶきを はずした。');G.state=GS.EXPLORE}else if(ms.cursor===1&&c.armor!=null){c.armor=null;showMsg('よろいを はずした。');G.state=GS.EXPLORE}else if(ms.cursor===2&&c.shield!=null){c.shield=null;showMsg('たてを はずした。');G.state=GS.EXPLORE}else if(ms.cursor===3&&c.helmet!=null){c.helmet=null;showMsg('かぶとを はずした。');G.state=GS.EXPLORE}}if(kp('KeyX')||kp('Escape'))ms.pg='main'}
else if(ms.pg==='dharma'){
if(ms.subPg==='charSelect'){
if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+G.party.length)%G.party.length;
if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%G.party.length;
if(kp('KeyZ')||kp('Enter')){ms.ci=ms.cursor;ms.subPg='jobList';ms.cursor=0}
if(kp('KeyX')||kp('Escape')){G.state=GS.EXPLORE}
}else if(ms.subPg==='jobList'){
const jl=JOB_KEYS.filter(k=>k!=='none');
if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+jl.length)%jl.length;
if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%jl.length;
if(kp('KeyZ')||kp('Enter')){
const jk=jl[ms.cursor],job=JOBS[jk],c=G.party[ms.ci];
const unlocked=!job.req||Object.entries(job.req).every(([j,lv])=>(c.jobProf[j]||0)>=lv);
if(unlocked){c.job=jk;c.hp=Math.min(c.hp,c.maxHp);c.mp=Math.min(c.mp,c.maxMp);
showMsg(c.name+'は '+job.name+'に てんしょくした！');G.state=GS.EXPLORE}
else{showMsg('まだ その しょくぎょうには\nつけない…');G.state=GS.EXPLORE}}
if(kp('KeyX')||kp('Escape')){ms.subPg='charSelect';ms.cursor=ms.ci}
}}
else if(ms.pg==='sakusen'){
if(kp('ArrowUp'))ms.cursor=(ms.cursor-1+3)%3;
if(kp('ArrowDown'))ms.cursor=(ms.cursor+1)%3;
if(kp('KeyZ')||kp('Enter')){
if(ms.cursor===0){saveGame();G.state=GS.EXPLORE}
else if(ms.cursor===1){ms.pg='jumon_show';ms.jumon=encodeJumon()}
else{ms.pg='main';ms.cursor=5}
}if(kp('KeyX')||kp('Escape')){ms.pg='main';ms.cursor=5}
}else if(ms.pg==='jumon_show'){
if(kp('KeyZ')||kp('Enter')||kp('KeyX')||kp('Escape')){ms.pg='sakusen';ms.cursor=1}
}else if(ms.pg==='jumon_input'){
if(!ms.inputBuf)ms.inputBuf='';
if(!ms.jcursor)ms.jcursor={x:0,y:0};
const jc=JUMON_CHARS;const cols=10;const rows=Math.ceil(jc.length/cols);
if(kp('ArrowRight'))ms.jcursor.x=Math.min(cols-1,ms.jcursor.x+1);
if(kp('ArrowLeft'))ms.jcursor.x=Math.max(0,ms.jcursor.x-1);
if(kp('ArrowDown'))ms.jcursor.y=Math.min(rows,ms.jcursor.y+1);
if(kp('ArrowUp'))ms.jcursor.y=Math.max(0,ms.jcursor.y-1);
if(kp('KeyZ')||kp('Enter')){
if(ms.jcursor.y===rows){
// けってい row
const data=decodeJumon(ms.inputBuf);
if(data){applyJumon(data);showMsg('ふっかつのじゅもんを うけつけた！')}
else showMsg('じゅもんが ちがいます。');
ms.pg='main';ms.cursor=0;
}else{
const idx=ms.jcursor.y*cols+ms.jcursor.x;
if(idx<jc.length)ms.inputBuf+=jc[idx];
}}
if(kp('KeyX')||kp('Escape')){
if(ms.inputBuf.length>0)ms.inputBuf=ms.inputBuf.slice(0,-1);
else{ms.pg='sakusen';ms.cursor=1}
}}
}
function drawMenu(){const ms=G.ms;if(!ms)return;if(ms.pg==='main'){dw(8,8,80,120);['はなす','じゅもん','どうぐ','つよさ','そうび','さくせん','とじる'].forEach((t,i)=>dt(t,24,24+i*14));dc(14,17+ms.cursor*14);dw(96,8,152,44*G.party.length);G.party.forEach((c,i)=>{const y=20+i*42;dt(c.name.slice(0,6),104,y,7);dt('Lv'+c.level,180,y,7);drawBar(104,y+5,80,4,c.hp/c.maxHp,c.hp<c.maxHp/4?'#c00':'#0a0',c.hp<c.maxHp/4?'#f44':'#0f0');dt('HP'+c.hp+'/'+c.maxHp,104,y+14,6);drawBar(104,y+18,80,3,c.mp/c.maxMp,'#06a','#0af');dt('MP'+c.mp+'/'+c.maxMp,104,y+26,6)})}else if(ms.pg==='status'){const c=G.party[ms.ci];dw(8,8,240,214);dt('< '+c.name+' >',16,26,8,'#ffd700');dt('レベル: '+c.level,16,44);dt('HP: '+c.hp+'/'+c.maxHp,16,58);dt('MP: '+c.mp+'/'+c.maxMp,16,72);dt('ちから: '+c.str,16,86);dt('すばやさ: '+c.agi,16,100);dt('こうげき力: '+c.atk,16,114);dt('しゅび力: '+c.def,16,128);dt('しょくぎょう: '+JOBS[c.job].name,16,142);dt('EXP: '+c.exp,16,156);const nx=c.level<c.lt.length?c.lt[c.level][0]-c.exp:'---';dt('つぎのLvまで: '+nx,16,170);if(c.job!=='none'){const p=c.jobProf[c.job]||0;dt('じゅくれんど: '+'★'.repeat(Math.min(8,p))+'☆'.repeat(Math.max(0,8-p)),16,184,6,'#ff0')}dt('←→ キャラ切替 Z/Escで戻る',16,200,6,'#888')}else if(ms.pg==='item'){dw(8,8,200,180);dt('どうぐ',16,26,8,'#ffd700');if(G.items.length===0)dt('なにも もっていない',16,44);G.items.forEach((it,i)=>{dt((i===ms.cursor?'▶':'  ')+ITEMS[it.id].name+(it.count>1?' x'+it.count:''),16,44+i*14,7)});dt('G: '+G.gold,16,170,7,'#ffd700')}else if(ms.pg==='spell'){const c=G.party[ms.ci];dw(8,8,200,180);dt(c.name+'のじゅもん',16,26,8,'#ffd700');if(c.spells.length===0)dt('おぼえていない',16,44);c.spells.forEach((sp,i)=>{const s=SPELLS[sp];dt((i===ms.cursor?'▶':'  ')+s.name+' MP'+s.mp,16,44+i*14,7)});dt('←→ キャラ切替',16,170,6,'#888')}else if(ms.pg==='equip'){const c=G.party[ms.ci];dw(8,8,240,150);dt(c.name+'のそうび',16,26,8,'#ffd700');dt((ms.cursor===0?'▶':' ')+'ぶき: '+(c.weapon!=null?WEAPONS[c.weapon].name:'なし'),16,44);dt((ms.cursor===1?'▶':' ')+'よろい: '+(c.armor!=null?ARMORS[c.armor].name:'なし'),16,58);dt((ms.cursor===2?'▶':' ')+'たて: '+(c.shield!=null?SHIELDS[c.shield].name:'なし'),16,72);dt((ms.cursor===3?'▶':' ')+'かぶと: '+(c.helmet!=null?HELMETS[c.helmet].name:'なし'),16,86);dt('Z:はずす ←→:キャラ切替',16,110,6,'#888');dt('X:もどる',16,122,6,'#888')}
else if(ms.pg==='dharma'){
if(ms.subPg==='charSelect'){dw(4,4,248,30+G.party.length*16);dt('だれの しょくぎょうを かえる？',12,22,7,'#ffd700');G.party.forEach((c,i)=>{const sel=i===ms.cursor;dt((sel?'▶':' ')+c.name+' ['+JOBS[c.job].name+']',12,38+i*16,7,sel?'#fff':'#aaa')})}
else if(ms.subPg==='jobList'){const c=G.party[ms.ci];const jl=JOB_KEYS.filter(k=>k!=='none');dw(4,4,248,228);dt(c.name+'の てんしょく',12,20,7,'#ffd700');dt('げんざい: '+JOBS[c.job].name,12,32,6,'#0af');jl.forEach((k,i)=>{const j=JOBS[k];const unlocked=!j.req||Object.entries(j.req).every(([jk,lv])=>(c.jobProf[jk]||0)>=lv);const p=c.jobProf[k]||0;const sel=i===ms.cursor;const col=unlocked?(k===c.job?'#0f0':'#fff'):'#555';const stars='★'.repeat(Math.min(8,p))+'☆'.repeat(Math.max(0,8-p));dt((sel?'▶':' ')+j.name,12,46+i*14,6,col);dt(stars.slice(0,8),80,46+i*14,5,unlocked?'#ff0':'#333')})}}
else if(ms.pg==='sakusen'){
dw(8,8,140,66);dt('さくせん',16,26,8,'#ffd700');
['きろくする','ふっかつのじゅもん','もどる'].forEach((t,i)=>dt((i===ms.cursor?'▶':' ')+t,16,42+i*14,7));
}else if(ms.pg==='jumon_show'){
dw(4,4,248,232);dt('ふっかつのじゅもん',16,24,8,'#ffd700');
dt('この じゅもんを ひかえよ！',16,42,7);
const j=ms.jumon||'';
for(let i=0;i<j.length;i++){
const row=Math.floor(i/14),col=i%14;
dt(j[i],16+col*16,66+row*18,8,'#0f0');
}dt('Z/Escで もどる',16,218,6,'#888');
}else if(ms.pg==='jumon_input'){
dw(4,4,248,232);dt('ふっかつのじゅもんを いれよ',16,22,7,'#ffd700');
// Show input buffer
dw(8,32,240,24);dt(ms.inputBuf||'',14,48,8,'#0f0');
// Kana grid
const jc=JUMON_CHARS,cols=10;
for(let i=0;i<jc.length;i++){
const r=Math.floor(i/cols),c=i%cols;
const sel=ms.jcursor&&ms.jcursor.y===r&&ms.jcursor.x===c;
dt(jc[i],14+c*22,76+r*16,8,sel?'#ff0':'#fff');
}
// けってい button
const rows=Math.ceil(jc.length/cols);
const selK=ms.jcursor&&ms.jcursor.y===rows;
dt('けってい',14,76+rows*16,8,selK?'#ff0':'#fff');
dt('X:1文字けす Esc:もどる',14,218,5,'#888');
}}
function useItem(idx){if(idx>=G.items.length)return;const it=G.items[idx],item=ITEMS[it.id];if(item.type==='heal'){const c=G.party.find(c=>c.alive&&c.hp<c.maxHp);if(c){c.hp=Math.min(c.maxHp,c.hp+item.power);it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(c.name+'のHP '+item.power+' かいふく！')}else showMsg('つかう ひつようが ない。')}else if(item.type==='cure'){const c=G.party.find(c=>c.alive&&c.status.includes(item.cure));if(c){c.status=c.status.filter(s=>s!==item.cure);it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(item.cure+'が なおった！')}else showMsg('つかう ひつようが ない。')}else if(item.type==='revive'){const c=G.party.find(c=>!c.alive);if(c){c.alive=true;c.hp=c.maxHp;it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(c.name+'は いきかえった！')}else showMsg('つかう ひつようが ない。')}else if(item.type==='field'&&item.effect==='ruura'){if(G.visited.length===0){showMsg('まだ町を訪れていない。');return}it.count--;if(it.count<=0)G.items.splice(idx,1);G.mapId='world';G.px=12;G.py=15;G.state=GS.EXPLORE;showMsg('キメラのつばさを つかった！')}else if(item.type==='stat'){const c=G.party[0];if(c){c[item.stat]=(c[item.stat]||0)+item.value;if(item.stat==='maxHp')c.hp=Math.min(c.hp+item.value,c.maxHp);if(item.stat==='maxMp')c.mp=Math.min(c.mp+item.value,c.maxMp);it.count--;if(it.count<=0)G.items.splice(idx,1);G.state=GS.EXPLORE;showMsg(item.name+'を つかった！')}else showMsg('つかえない。')}else showMsg('ここでは つかえない。')}
function useFieldSpell(caster,sid){const s=SPELLS[sid];if(caster.mp<s.mp){showMsg('MPが たりない！');return}if(s.type==='heal'){const t=G.party.find(c=>c.alive&&c.hp<c.maxHp);if(!t){showMsg('つかう ひつようがない。');return}caster.mp-=s.mp;t.hp=Math.min(t.maxHp,t.hp+s.power);G.state=GS.EXPLORE;showMsg(caster.name+'は '+s.name+'！\n'+t.name+'のHP '+s.power+' かいふく！')}else if(s.type==='revive'){const t=G.party.find(c=>!c.alive);if(!t){showMsg('つかう ひつようがない。');return}caster.mp-=s.mp;t.alive=true;t.hp=t.maxHp;G.state=GS.EXPLORE;showMsg(caster.name+'は '+s.name+'！\n'+t.name+'は いきかえった！')}else if(sid==='ruura'){if(G.visited.length===0){showMsg('まだ町を訪れていない。');return}caster.mp-=s.mp;G.mapId='world';G.px=12;G.py=15;G.state=GS.EXPLORE;showMsg(caster.name+'は ルーラ！')}else if(sid==='riremito'){if(G.mapId==='world'){showMsg('ここでは つかえない。');return}caster.mp-=s.mp;G.mapId='world';G.state=GS.EXPLORE;showMsg(caster.name+'は リレミト！')}else showMsg('ここでは つかえない。')}
function initNPCs(){G.npcs={loracia:[
{x:5,y:3,name:'ローレシア王',msg:()=>{
if(G.flags.sidoDown)return'ローレシア王「おお 勇者たちよ！\nよくぞ邪神シドーを倒した！\nお前たちは まことの勇者じゃ！」';
if(G.flags.hargonDown)return'ローレシア王「ハーゴンは倒したか！\nしかし まだ不吉な気配が…\n油断するでないぞ！」';
if(G.party.length>=3)return'ローレシア王「3人が揃ったか！\n北にあるダーマ神殿で\n転職すれば さらに強くなれるぞ。\nハーゴンを 必ず倒すのじゃ！」';
if(G.flags.princeJoined)return'ローレシア王「おお 王子を見つけたか！\n次はムーンブルクの王女じゃ。\nムーンペタの町に手がかりがある。」';
return'ローレシア王「おお ローレシアのおうじよ！\n魔王ハーゴンを倒す旅に出るのじゃ！\n南西のサマルトリア城で\n王子を仲間にするのじゃ！」'}},
{x:10,y:8,name:'兵士',msg:()=>{
if(G.party.length>=3)return'兵士「三人の勇者が揃いましたな！\n北のダーマ神殿をご存知ですか？\n転職で新たな力を得られます。\nハーゴン討伐の鍵になるかと。」';
return'兵士「東にリリザの町があります。\n南の湖のほこらには\n大切なものがあるそうです。」'}},
{x:3,y:8,name:'宿屋',msg:'inn',inn:true}],
liriza:[
{x:4,y:5,name:'商人',msg:'商人「ここはリリザだよ。\n旅に必要なものは揃ってるぜ。」',shop:true},
{x:8,y:3,name:'女性',msg:()=>{
if(G.flags.princeJoined)return'女性「王子を見つけたのね！\nそういえば 北の方に\nダーマ神殿があるって話よ。\n転職で強くなれるんですって。」';
return'女性「サマルトリアの王子は\n旅に出たらしいわよ。\nサマルトリア城にいるみたい。」'}},
{x:6,y:9,name:'老人',msg:()=>{
if(G.party.some(c=>c.job!=='none'))return'老人「ほう 転職しておるのか。\nひとつの職を★8まで極めれば\n上級の職への道が開けるぞ。\n戦士と武闘家でバトルマスター…\n魔法使いと僧侶で賢者じゃ。」';
return'老人「わしが若い頃は\nダーマ神殿で修行したものじゃ。\n転職して様々な技を覚えれば\n魔王にも立ち向かえよう。」'}},
{x:2,y:8,name:'宿屋',msg:'inn',inn:true}],
samaltria:[
{x:7,y:3,name:'サマルトリア王',msg:()=>{
if(G.flags.princeJoined)return'サマルトリア王「息子を頼んだぞ。\nダーマ神殿で鍛えてやってくれ。\nあそこなら 職を変えて\n新しい力を身につけられる。」';
return'サマルトリア王「うちの王子が\nお前を探していたぞ。\nこの城のどこかにいるはず。」'}},
{x:5,y:8,name:'サマルトリアのおうじ',recruit:'prince',msg:'サマルトリアのおうじ「おお！\nぼくも つれていってください！\nいっしょに ハーゴンを倒そう！」'},
{x:10,y:8,name:'宿屋',msg:'inn',inn:true},
{x:3,y:5,name:'兵士',msg:'兵士「ダーマ神殿はご存知ですか？\nこの城から北の方角に\n神殿があるそうです。\n転職で 新たな技を覚えられると。」'}],
moonpeta:[
{x:5,y:5,name:'老人',msg:'老人「この町の東に犬がいるだろう？\nあれは ムーンブルクの王女\nなのじゃ。ラーのかがみが\nあれば 元の姿にもどせるぞ。」'},
{x:9,y:7,name:'犬',recruit:'princess',msg:'犬「ワン！ワン！」\nラーのかがみを つかった！'},
{x:3,y:9,name:'道具屋',msg:'道具屋「いらっしゃい！」',shop:true},
{x:3,y:3,name:'宿屋',msg:'inn',inn:true},
{x:7,y:3,name:'女性',msg:()=>{
if(G.flags.princessJoined)return'女性「王女さまが元に戻ったのね！\n3人揃えばダーマ神殿で\n転職できるわ。\n踊り子になれば回復の踊りを\n覚えられるって噂よ。」';
return'女性「ムーンブルク城は\nハーゴンに滅ぼされたの…\n王女さまだけが生き残ったけど\n呪いで犬の姿にされたらしいわ。」'}}],
beranule:[
{x:4,y:5,name:'船乗り',msg:'船乗り「船が欲しいのか？\nふねのきっぷを持ってきな！」',giveShip:true},
{x:8,y:3,name:'道具屋',msg:'道具屋「いらっしゃい！」',shop:true},
{x:8,y:8,name:'宿屋',msg:'inn',inn:true},
{x:6,y:3,name:'老人',msg:()=>{
const hasAdv=G.party.some(c=>{const j=JOBS[c.job];return j&&j.req!==null});
if(hasAdv)return'老人「おお 上級職に就いたか！\n素晴らしい。その調子で\nバトルマスターと賢者を極めれば\n最後の職…勇者への道が開ける。\nマダンテの力があれば\nハーゴンにも勝てるじゃろう。」';
return'老人「海の向こうには\n強い魔物がうようよしている。\nダーマ神殿で転職して\n己を鍛えてから挑むがよい。\n戦士や魔法使い 僧侶に武闘家…\n様々な技が身につくぞ。」'}}],
perpoi:[
{x:4,y:5,name:'学者',msg:()=>{
const heroJob=G.party.some(c=>c.job==='hero_job');
if(heroJob)return'学者「なんと…勇者の職に！\nマダンテの力を持つ者がいれば\nハーゴンも恐るるに足らぬ。\n東の果ての神殿へ向かうがよい。」';
return'学者「ロンダルキアへの洞窟は\n北西にある。\n強い装備と転職で鍛えた力が\n必要じゃ。\nハーゴンの神殿は東の果てに。」'}},
{x:8,y:3,name:'道具屋',msg:'道具屋「いらっしゃい！」',shop:true},
{x:2,y:8,name:'宿屋',msg:'inn',inn:true},
{x:6,y:7,name:'女性',msg:'女性「ダーマ神殿で修行した者が\n最後にたどり着く職業…\nそれが勇者だそうよ。\nバトルマスターと賢者を極めた\n者だけが なれるんですって。」'}],
rhone:[
{x:7,y:5,name:'神官',msg:()=>{
const totalProf=G.party.reduce((s,c)=>{let t=0;for(const k in c.jobProf)t+=c.jobProf[k];return s+t},0);
if(totalProf>30)return'神官「よくぞここまで鍛えた。\nダーマ神殿で積んだ修行の力…\nその技と魂で 闇を打ち払え。\nハーゴン神殿は東の果てにある。」';
return'神官「ここはロンダルキアのほこら。\nハーゴン神殿は東の果てにある。\n気をつけてゆくのじゃ。\n…もっと鍛えてから来てもよいぞ。」'}},
{x:5,y:5,name:'宿屋',msg:'inn',inn:true}],
dharma:[
{x:6,y:3,name:'ダーマ神官',msg:()=>{
const heroJob=G.party.some(c=>c.job==='hero_job');
if(heroJob)return'ダーマ神官「おお…ついに勇者が\n誕生したか！\nその者は あらゆる職を極め\n真の力を手に入れた。\nマダンテの光で\n闇を打ち砕くがよい！\nハーゴンを倒し 世界を救うのじゃ。」';
const hasAdv=G.party.some(c=>{const j=JOBS[c.job];return j&&j.req!==null});
if(hasAdv)return'ダーマ神官「上級職に進んだか。\n見事じゃ。\nしかし まだ先がある。\nバトルマスターと賢者…\nその2つを極めし者には\n最強の職 勇者への道が開ける。\n転職して参るがよい。」';
const anyJob=G.party.some(c=>c.job!=='none');
if(anyJob)return'ダーマ神官「修行は順調かな？\n戦い続ければ熟練度が上がり\n新たな技を覚えられる。\n★8まで極めれば 上級職への\n道も見えてこよう。\n転職して参るがよい。」';
return'ダーマ神官「ようこそ ダーマ神殿へ。\nここは 天空より授かりし\n転職の力を司る聖なる場所。\n\n戦士 魔法使い 僧侶 武闘家\n踊り子 盗賊…\n6つの職を修めることで\n更なる高みへと至れる。\n\nさあ 転職して参るがよい。」'},dharma:true},
{x:3,y:8,name:'宿屋',msg:'inn',inn:true},
{x:9,y:5,name:'女性',msg:()=>{
const anyMastered=G.party.some(c=>{for(const k in c.jobProf)if(c.jobProf[k]>=8)return true;return false});
if(anyMastered)return'女性「職を極めたのですね！\n2つの基本職を★8にすれば\n上級職になれますよ。\n戦士＋武闘家→バトルマスター\n魔法使い＋僧侶→賢者\nぜひ挑戦してみて。」';
return'女性「ここで転職すると\n職業ごとの技を覚えられます。\n戦って熟練度を上げましょう。\n★の数が増えると新しい技を\n覚えますよ。」'}}]};G.shops={liriza:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:0,p:10},{id:1,p:100}],armors:[{id:0,p:30},{id:1,p:80}]},moonpeta:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:2,p:500},{id:7,p:200}],armors:[{id:2,p:300}]},beranule:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:2,p:500},{id:6,p:300}],armors:[{id:3,p:700}]},perpoi:{items:[{id:0,p:8},{id:1,p:10},{id:2,p:25}],weapons:[{id:4,p:3500}],armors:[{id:4,p:3000}]}}}
function checkInteraction(){const dirs=[[0,1],[0,-1],[-1,0],[1,0]];const d=dirs[G.pdir],tx=G.px+d[0],ty=G.py+d[1];if(G.mapId==='world')return;const npcs=G.npcs[G.mapId];if(!npcs)return;for(const npc of npcs){if(npc.x===tx&&npc.y===ty){if(npc.inn){useInn();return}if(npc.recruit==='prince'&&!G.prince&&!G.flags.princeJoined){G.flags.princeJoined=true;G.prince=new Chara(1,'サマルトリアのおうじ',PRINCE_LV);G.prince.weapon=0;G.prince.armor=0;G.party.push(G.prince);showMsg(npc.msg,()=>showMsg('サマルトリアのおうじ が なかまになった！'));return}if(npc.recruit==='princess'&&!G.princess&&!G.flags.princessJoined){if(G.items.some(it=>it.id===8)){G.flags.princessJoined=true;G.princess=new Chara(2,'ムーンブルクのおうじょ',PRINCESS_LV);G.princess.weapon=7;G.princess.armor=0;G.party.push(G.princess);const ki=G.items.findIndex(it=>it.id===8);if(ki>=0)G.items.splice(ki,1);showMsg('ラーのかがみを つかった！\n犬の姿が みるみる変わっていく…',()=>showMsg('ムーンブルクのおうじょ が なかまになった！'));return}else{showMsg('犬「ワン！ ワン！」\n（ラーのかがみが あれば…）');return}}if(npc.dharma){G.state=GS.MENU;G.ms={pg:'dharma',cursor:0,ci:0,subPg:'charSelect'};return}if(npc.giveShip){if(G.items.some(it=>it.id===7)){G.hasShip=true;
// Find nearest sea tile to beranule exit
let sx=42,sy=20,found=false;
for(let r=1;r<10&&!found;r++)for(let dy=-r;dy<=r&&!found;dy++)for(let dx=-r;dx<=r&&!found;dx++){
if(Math.abs(dx)===r||Math.abs(dy)===r){const nx=42+dx,ny=19+dy;if(nx>=0&&nx<64&&ny>=0&&ny<64&&worldMap[ny][nx]===1){sx=nx;sy=ny;found=true}}}
G.shipX=sx;G.shipY=sy;G.items=G.items.filter(it=>it.id!==7);showMsg('船乗り「おお きっぷを持っているな！\nこの船を つかいな！」',()=>showMsg('船を てにいれた！'));return}else{showMsg('船乗り「船が欲しいのか？\nふねのきっぷを持ってきな！\n東の洞窟にあるらしいぞ。」');return}}if(npc.shop&&G.shops[G.mapId]){enterShop();return}showMsg(typeof npc.msg==='function'?npc.msg():npc.msg);return}}showMsg('だれもいない。')}
function enterShop(){const s=G.shops[G.mapId];if(!s)return;G.state=GS.SHOP;G.ss={pg:'main',cursor:0,items:s.items||[],weapons:s.weapons||[],armors:s.armors||[]}}
function updateShop(){if(G.msgT)return;const ss=G.ss;if(!ss)return;if(ss.pg==='main'){if(kp('ArrowUp'))ss.cursor=(ss.cursor-1+4)%4;if(kp('ArrowDown'))ss.cursor=(ss.cursor+1)%4;if(kp('KeyZ')||kp('Enter')){if(ss.cursor===0){ss.pg='buy_item';ss.cursor=0}else if(ss.cursor===1){ss.pg='buy_weapon';ss.cursor=0}else if(ss.cursor===2){ss.pg='buy_armor';ss.cursor=0}else{G.state=GS.EXPLORE;G.ss=null}}if(kp('KeyX')||kp('Escape')){G.state=GS.EXPLORE;G.ss=null}}else{let list;if(ss.pg==='buy_item')list=ss.items;else if(ss.pg==='buy_weapon')list=ss.weapons;else list=ss.armors;if(kp('ArrowUp'))ss.cursor=Math.max(0,ss.cursor-1);if(kp('ArrowDown'))ss.cursor=Math.min(list.length-1,ss.cursor);if(kp('KeyZ')||kp('Enter')){if(list.length>0){const it=list[ss.cursor];if(G.gold>=it.p){G.gold-=it.p;if(ss.pg==='buy_item'){const ex=G.items.find(i=>i.id===it.id);if(ex)ex.count++;else G.items.push({id:it.id,count:1});showMsg(ITEMS[it.id].name+'を かった！')}else if(ss.pg==='buy_weapon'){const w=WEAPONS[it.id];const tgt=G.party.find(c=>c.alive&&w.who.includes(c.id))||G.party[0];tgt.weapon=it.id;showMsg(w.name+'を かった！\n'+tgt.name+'が そうびした！')}else{const a=ARMORS[it.id];const tgt=G.party.find(c=>c.alive&&a.who.includes(c.id))||G.party[0];tgt.armor=it.id;showMsg(a.name+'を かった！\n'+tgt.name+'が そうびした！')}}else showMsg('ゴールドが たりない！')}}if(kp('KeyX')||kp('Escape')){ss.pg='main';ss.cursor=0}}}
function drawShop(){const ss=G.ss;if(!ss)return;if(ss.pg==='main'){dw(8,8,120,80);dt('おみせ  G:'+G.gold,16,26,7,'#ffd700');['どうぐ','ぶき','よろい','やめる'].forEach((t,i)=>dt((i===ss.cursor?'▶':' ')+t,16,42+i*14,7))}else{let list,names;if(ss.pg==='buy_item'){list=ss.items;names=list.map(i=>ITEMS[i.id].name)}else if(ss.pg==='buy_weapon'){list=ss.weapons;names=list.map(i=>WEAPONS[i.id].name)}else{list=ss.armors;names=list.map(i=>ARMORS[i.id].name)}dw(8,8,200,list.length*14+40);dt('G: '+G.gold,16,26,7,'#ffd700');list.forEach((it,i)=>dt((i===ss.cursor?'▶':' ')+names[i]+' '+it.p+'G',16,42+i*14,7));dt('Xで もどる',16,list.length*14+42,6,'#888')}}
function drawNPCs(){if(G.mapId==='world')return;const npcs=G.npcs[G.mapId];if(!npcs)return;const npcColors={'ローレシア王':'#c00','サマルトリア王':'#00c','船乗り':'#a52','老人':'#888','学者':'#448','神官':'#fff','ダーマ神官':'#f80','犬':'#a80','宿屋':'#0a8','兵士':'#888','女性':'#f6a','商人':'#da0','道具屋':'#0a0'};npcs.forEach(npc=>{const sx=(npc.x-G.cam.x)*T,sy=(npc.y-G.cam.y)*T;if(sx<-T||sx>SW||sy<-T||sy>SH)return;if(npc.name==='犬'){ctx.fillStyle='#a60';ctx.fillRect(sx+4,sy+8,8,4);ctx.fillRect(sx+4,sy+12,2,3);ctx.fillRect(sx+10,sy+12,2,3);ctx.fillRect(sx+3,sy+6,4,3);ctx.fillStyle='#000';ctx.fillRect(sx+4,sy+7,1,1);ctx.fillStyle='#a60';ctx.fillRect(sx+11,sy+9,2,1);return}const col=npcColors[npc.name]||'#fa0';ctx.fillStyle='#fdb';ctx.fillRect(sx+5,sy+2,6,4);ctx.fillStyle='#000';ctx.fillRect(sx+6,sy+3,1,1);ctx.fillRect(sx+9,sy+3,1,1);ctx.fillStyle=col;ctx.fillRect(sx+4,sy+6,8,5);ctx.fillRect(sx+3,sy+7,1,3);ctx.fillRect(sx+12,sy+7,1,3);ctx.fillRect(sx+5,sy+11,2,3);ctx.fillRect(sx+9,sy+11,2,3);if(npc.name.includes('王')){ctx.fillStyle='#ffd700';ctx.fillRect(sx+5,sy+0,6,2);ctx.fillRect(sx+5,sy+0,1,1);ctx.fillRect(sx+7,sy+0,1,1);ctx.fillRect(sx+10,sy+0,1,1)}else if(npc.name==='女性'){ctx.fillStyle='#a06';ctx.fillRect(sx+4,sy+0,8,3);ctx.fillRect(sx+3,sy+1,1,5);ctx.fillRect(sx+12,sy+1,1,5)}else{ctx.fillStyle='#531';ctx.fillRect(sx+5,sy+1,6,1)}})}
function drawTitle(){
// 背景: 深い青のグラデーション
const bgGrd=ctx.createLinearGradient(0,0,0,SH);bgGrd.addColorStop(0,'#080820');bgGrd.addColorStop(0.5,'#101040');bgGrd.addColorStop(1,'#000010');ctx.fillStyle=bgGrd;ctx.fillRect(0,0,SW,SH);
const s=Math.sin,cx=SW/2,f=G.frame;
// 背景パーティクル（ゆっくり上昇する光の粒）
for(let i=0;i<25;i++){const px=(i*79+i*i*17)%SW,py=((i*53+i*i*11)-f*0.3)%SH;const pa=0.15+0.15*s(f*0.015+i*2);ctx.fillStyle=`rgba(180,200,255,${pa})`;ctx.fillRect(px,(py+SH)%SH,1,1)}
// ロトの紋章（中央上部、大きく）
const ey=48,er=28;
// 外円（ゴールドリング）
const ga=0.6+0.2*s(f*0.03);
ctx.strokeStyle=`rgba(255,215,0,${ga})`;ctx.lineWidth=1.5;ctx.beginPath();ctx.arc(cx,ey,er,0,Math.PI*2);ctx.stroke();
ctx.strokeStyle=`rgba(255,200,0,${ga*0.5})`;ctx.lineWidth=0.5;ctx.beginPath();ctx.arc(cx,ey,er+2,0,Math.PI*2);ctx.stroke();
// 紋章の鳥（不死鳥/ラーミア風）
ctx.fillStyle=`rgba(255,215,0,${ga})`;
// 体
ctx.fillRect(cx-2,ey-4,4,10);
// 翼（左）
ctx.fillRect(cx-6,ey-6,4,2);ctx.fillRect(cx-10,ey-8,4,2);ctx.fillRect(cx-14,ey-8,4,2);ctx.fillRect(cx-16,ey-6,3,2);ctx.fillRect(cx-18,ey-4,3,2);
// 翼（右）
ctx.fillRect(cx+2,ey-6,4,2);ctx.fillRect(cx+6,ey-8,4,2);ctx.fillRect(cx+10,ey-8,4,2);ctx.fillRect(cx+13,ey-6,3,2);ctx.fillRect(cx+15,ey-4,3,2);
// 頭
ctx.fillRect(cx-1,ey-8,2,4);ctx.fillRect(cx-2,ey-10,4,3);
// 尾羽
ctx.fillRect(cx-4,ey+6,2,4);ctx.fillRect(cx+2,ey+6,2,4);ctx.fillRect(cx-1,ey+8,2,4);
// 紋章の十字
ctx.fillRect(cx-er+4,ey-1,er*2-8,2);ctx.fillRect(cx-1,ey-er+4,2,er*2-8);
// DRAGONQUESTロゴ
const ly=ey+er+12;
// メインタイトル（英字ロゴ風）
ctx.font='bold 11px monospace';ctx.textAlign='center';
// 影（二重）
ctx.fillStyle='rgba(0,0,0,0.9)';ctx.fillText('DRAGON QUEST',cx+1,ly+1);
ctx.fillStyle='rgba(80,40,0,0.6)';ctx.fillText('DRAGON QUEST',cx+0.5,ly+0.5);
// 本体（グラデーション）
const tgrd=ctx.createLinearGradient(cx-50,ly-10,cx+50,ly+2);tgrd.addColorStop(0,'#ffd700');tgrd.addColorStop(0.3,'#fff4a0');tgrd.addColorStop(0.5,'#ffe040');tgrd.addColorStop(0.7,'#fff4a0');tgrd.addColorStop(1,'#ffd700');
ctx.fillStyle=tgrd;ctx.fillText('DRAGON QUEST',cx,ly);
// 「II」を大きく
ctx.font='bold 16px monospace';
ctx.fillStyle='rgba(0,0,0,0.9)';ctx.fillText('II',cx+1,ly+18+1);
const igrd=ctx.createLinearGradient(cx-10,ly+4,cx+10,ly+20);igrd.addColorStop(0,'#ffd700');igrd.addColorStop(0.5,'#fffce0');igrd.addColorStop(1,'#daa520');
ctx.fillStyle=igrd;ctx.fillText('II',cx,ly+18);
// サブタイトル（日本語）
ctx.font='8px monospace';
ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillText('悪霊の神々',cx+0.5,ly+30+0.5);
ctx.fillStyle='#e0b030';ctx.fillText('悪霊の神々',cx,ly+30);
// 装飾区切りライン
const dy=ly+36;
ctx.strokeStyle=`rgba(255,215,0,${0.3+0.15*s(f*0.03)})`;ctx.lineWidth=0.5;
ctx.beginPath();ctx.moveTo(cx-80,dy);ctx.lineTo(cx-10,dy);ctx.stroke();
ctx.beginPath();ctx.moveTo(cx+10,dy);ctx.lineTo(cx+80,dy);ctx.stroke();
// 中央ダイヤ
ctx.fillStyle=`rgba(255,215,0,${0.5+0.3*s(f*0.05)})`;
ctx.beginPath();ctx.moveTo(cx,dy-3);ctx.lineTo(cx+3,dy);ctx.lineTo(cx,dy+3);ctx.lineTo(cx-3,dy);ctx.closePath();ctx.fill();
// 3人のシルエット（ロト三勇者）
const sy2=ly+44;
// ローレシア（中央、剣）
ctx.fillStyle='#446';
ctx.fillRect(cx-2,sy2,4,7);ctx.fillRect(cx-3,sy2+2,1,3);ctx.fillRect(cx+2,sy2+2,1,3);ctx.fillRect(cx-1,sy2+7,1,3);ctx.fillRect(cx,sy2+7,1,3);
ctx.fillStyle='#668';ctx.fillRect(cx-1,sy2-2,2,2);
ctx.fillStyle='#aab';ctx.fillRect(cx+3,sy2-1,1,6);
// サマルトリア（左、杖）
ctx.fillStyle='#343';
ctx.fillRect(cx-16,sy2+1,4,6);ctx.fillRect(cx-17,sy2+3,1,2);ctx.fillRect(cx-12,sy2+3,1,2);ctx.fillRect(cx-15,sy2+7,1,3);ctx.fillRect(cx-14,sy2+7,1,3);
ctx.fillStyle='#565';ctx.fillRect(cx-15,sy2-1,2,2);
ctx.fillStyle='#886';ctx.fillRect(cx-11,sy2-2,1,8);
// ムーンブルク（右、魔法）
ctx.fillStyle='#436';
ctx.fillRect(cx+12,sy2+1,4,6);ctx.fillRect(cx+11,sy2+3,1,2);ctx.fillRect(cx+16,sy2+3,1,2);ctx.fillRect(cx+13,sy2+7,1,3);ctx.fillRect(cx+14,sy2+7,1,3);
ctx.fillStyle='#658';ctx.fillRect(cx+13,sy2-1,2,2);
// 魔法エフェクト
const ma=0.3+0.3*s(f*0.08);ctx.fillStyle=`rgba(100,200,255,${ma})`;ctx.fillRect(cx+17,sy2,2,1);ctx.fillRect(cx+18,sy2+1,1,1);
// メニュー
const my=196;
dtc('ぼうけんをはじめる',cx,my,8);dtc('ぼうけんのしょ',cx,my+14,8);dtc('ふっかつのじゅもん',cx,my+28,8);
const tc=G.ms?G.ms.cursor||0:0;
if(G.frame%40<20)dc(SW/2-66,189+tc*14);
if(kp('Enter')||kp('Space')||kp('KeyZ')){
if(tc===0)newGame();
else if(tc===1)loadGame();
else{G.state=GS.MENU;G.ms={pg:'jumon_input',cursor:0,ci:0,inputBuf:'',jcursor:{x:0,y:0}}}
}
if(kp('ArrowDown')){if(!G.ms)G.ms={cursor:0};G.ms.cursor=Math.min(2,(G.ms.cursor||0)+1)}
if(kp('ArrowUp')){if(!G.ms)G.ms={cursor:0};G.ms.cursor=Math.max(0,(G.ms.cursor||0)-1)};dtc('Z: けってい  矢印: いどう',cx,236,5,'#445')}
function newGame(){G.hero=new Chara(0,'ローレシアのおうじ',HERO_LV);G.hero.weapon=1;G.hero.armor=1;G.party=[G.hero];G.gold=50;G.items=[{id:0,count:3}];G.mapId='world';G.px=12;G.py=15;G.pdir=0;G.flags={};G.visited=['loracia'];G.prince=null;G.princess=null;G.hasShip=false;G.onShip=false;G.chests={};initMaps();initNPCs();G.state=GS.DIALOG;showMsg('ローレシア王「おお ローレシアのおうじよ！\n邪教の教祖ハーゴンが\n世界を闇に染めようとしている。」',()=>{showMsg('ローレシア王「ロトの血を引く3人の\n勇者が揃えば 奴を倒せるはず。\nまずは南のサマルトリア城で\n王子を仲間にするのじゃ！」',()=>{showMsg('ローレシア王「そうじゃ…\n北にダーマ神殿がある。\n転職の力で己を鍛えれば\nさらに強くなれるじゃろう。」',()=>{G.state=GS.EXPLORE})})})}
// ===== FUKKATSU NO JUMON (Revival Password) =====
const JUMON_CHARS='あいうえおかきくけこさしすせそたちつてとなにぬねのはひふへほまみむめもやゆよらりるれろわをん';
function encodeJumon(){
const d=[];
// Hero level (4bit), prince level (4bit), princess level (4bit)
d.push(G.hero?G.hero.level:0);
d.push(G.prince?G.prince.level:0);
d.push(G.princess?G.princess.level:0);
// Gold (16bit, max 65535)
const g=Math.min(G.gold,65535);
d.push(g>>8);d.push(g&0xFF);
// Hero exp (16bit)
const he=G.hero?Math.min(G.hero.exp,65535):0;
d.push(he>>8);d.push(he&0xFF);
// Prince exp (16bit)
const pe=G.prince?Math.min(G.prince.exp,65535):0;
d.push(pe>>8);d.push(pe&0xFF);
// Princess exp (16bit)
const pre=G.princess?Math.min(G.princess.exp,65535):0;
d.push(pre>>8);d.push(pre&0xFF);
// Flags (8bit): princeJoined, princessJoined, hasShip, hargonDown, key items...
let flags=0;
if(G.flags.princeJoined)flags|=1;
if(G.flags.princessJoined)flags|=2;
if(G.hasShip)flags|=4;
if(G.flags.hargonDown)flags|=8;
if(G.items.some(it=>it.id===4))flags|=16; // ぎんのカギ
if(G.items.some(it=>it.id===5))flags|=32; // きんのカギ
if(G.items.some(it=>it.id===8))flags|=64; // ラーのかがみ
d.push(flags);
// Equipment: hero weapon(4bit)+armor(4bit)
const hw=G.hero&&G.hero.weapon!=null?G.hero.weapon+1:0;
const ha=G.hero&&G.hero.armor!=null?G.hero.armor+1:0;
d.push((hw<<4)|ha);
// Items count: yakusou (4bit)
const yc=G.items.find(it=>it.id===0);
d.push(yc?Math.min(yc.count,15):0);
// Checksum
let cs=0;for(const v of d)cs=(cs+v)&0xFF;
d.push(cs);
// Encode to kana: each byte -> 2 chars (high nibble + low nibble) using base-46
const jc=JUMON_CHARS;
let s='';
for(const v of d){s+=jc[Math.floor(v/42)%42];s+=jc[v%42]}
return s;
}
function decodeJumon(s){
const jc=JUMON_CHARS;
const clean=s.replace(/[\s　]/g,'');
if(clean.length<30)return null;
const d=[];
for(let i=0;i<clean.length;i+=2){
const hi=jc.indexOf(clean[i]),lo=jc.indexOf(clean[i+1]);
if(hi<0||lo<0)return null;
d.push(hi*42+lo);
}
// Verify checksum
const cs=d.pop();
let ck=0;for(const v of d)ck=(ck+v)&0xFF;
if(ck!==cs)return null;
// Decode
const heroLv=d[0],princeLv=d[1],princessLv=d[2];
const gold=(d[3]<<8)|d[4];
const heroExp=(d[5]<<8)|d[6];
const princeExp=(d[7]<<8)|d[8];
const princessExp=(d[9]<<8)|d[10];
const flags=d[11];
const hw=d[12]>>4,ha=d[12]&0xF;
const yakusou=d[13];
return{heroLv,princeLv,princessLv,gold,heroExp,princeExp,princessExp,flags,hw,ha,yakusou};
}
function applyJumon(data){
G.hero=new Chara(0,'ローレシアのおうじ',HERO_LV);
G.hero.level=1;G.hero.exp=0;
while(G.hero.level<data.heroLv&&G.hero.level<HERO_LV.length)
{G.hero.level++;const s=HERO_LV[G.hero.level-1];G.hero.maxHp=s[1];G.hero.maxMp=s[2];G.hero.str=s[3];G.hero.agi=s[4];for(const sp of s[5])if(!G.hero.spells.includes(sp))G.hero.spells.push(sp)}
G.hero.hp=G.hero.maxHp;G.hero.mp=G.hero.maxMp;G.hero.exp=data.heroExp;
if(data.hw>0)G.hero.weapon=data.hw-1;
if(data.ha>0)G.hero.armor=data.ha-1;
G.party=[G.hero];G.prince=null;G.princess=null;
if(data.flags&1){
G.prince=new Chara(1,'サマルトリアのおうじ',PRINCE_LV);
G.prince.level=1;
while(G.prince.level<data.princeLv&&G.prince.level<PRINCE_LV.length)
{G.prince.level++;const s=PRINCE_LV[G.prince.level-1];G.prince.maxHp=s[1];G.prince.maxMp=s[2];G.prince.str=s[3];G.prince.agi=s[4];for(const sp of s[5])if(!G.prince.spells.includes(sp))G.prince.spells.push(sp)}
G.prince.hp=G.prince.maxHp;G.prince.mp=G.prince.maxMp;G.prince.exp=data.princeExp;
G.party.push(G.prince);G.flags.princeJoined=true;
}
if(data.flags&2){
G.princess=new Chara(2,'ムーンブルクのおうじょ',PRINCESS_LV);
G.princess.level=1;
while(G.princess.level<data.princessLv&&G.princess.level<PRINCESS_LV.length)
{G.princess.level++;const s=PRINCESS_LV[G.princess.level-1];G.princess.maxHp=s[1];G.princess.maxMp=s[2];G.princess.str=s[3];G.princess.agi=s[4];for(const sp of s[5])if(!G.princess.spells.includes(sp))G.princess.spells.push(sp)}
G.princess.hp=G.princess.maxHp;G.princess.mp=G.princess.maxMp;G.princess.exp=data.princessExp;
G.party.push(G.princess);G.flags.princessJoined=true;
}
G.gold=data.gold;
G.items=[];
if(data.yakusou>0)G.items.push({id:0,count:data.yakusou});
if(data.flags&16)G.items.push({id:4,count:1});
if(data.flags&32)G.items.push({id:5,count:1});
if(data.flags&64)G.items.push({id:8,count:1});
G.hasShip=!!(data.flags&4);
if(data.flags&8)G.flags.hargonDown=true;
G.mapId='world';G.px=12;G.py=15;G.pdir=0;
G.visited=['loracia'];G.chests={};initMaps();initNPCs();
G.state=GS.EXPLORE;
}
function saveGame(){const d={party:G.party.map(c=>({id:c.id,name:c.name,level:c.level,exp:c.exp,hp:c.hp,maxHp:c._baseMaxHp,mp:c.mp,maxMp:c._baseMaxMp,str:c._baseStr,agi:c._baseAgi,spells:c.spells,weapon:c.weapon,armor:c.armor,shield:c.shield,helmet:c.helmet,alive:c.alive,job:c.job,jobProf:c.jobProf,learnedSkills:c.learnedSkills})),gold:G.gold,items:G.items,flags:G.flags,mapId:G.mapId,px:G.px,py:G.py,pdir:G.pdir,visited:G.visited,hasShip:G.hasShip,shipX:G.shipX,shipY:G.shipY};localStorage.setItem('dq2save',JSON.stringify(d));showMsg('ぼうけんのしょに きろくしました。')}
function loadGame(){const r=localStorage.getItem('dq2save');if(!r){showMsg('ぼうけんのしょが ありません。');return}try{const d=JSON.parse(r);const ts=[HERO_LV,PRINCE_LV,PRINCESS_LV];G.party=d.party.map(p=>{const c=new Chara(p.id,p.name,ts[p.id]);Object.assign(c,p);c.lt=ts[p.id];if(!c.job)c.job='none';if(!c.jobProf){c.jobProf={};for(const k in JOBS)if(k!=='none')c.jobProf[k]=0}if(!c.learnedSkills)c.learnedSkills=[];return c});G.hero=G.party[0];G.prince=G.party.find(c=>c.id===1)||null;G.princess=G.party.find(c=>c.id===2)||null;G.gold=d.gold;G.items=d.items;G.flags=d.flags;G.mapId=d.mapId;G.px=d.px;G.py=d.py;G.pdir=d.pdir;G.visited=d.visited||[];G.hasShip=d.hasShip||false;G.shipX=d.shipX||0;G.shipY=d.shipY||0;G.state=GS.EXPLORE}catch(e){showMsg('ぼうけんのしょが こわれています。')}}
function updateExplore(){if(G.msgT)return;G.moveTimer--;if(G.moveTimer>0)return;let dx=0,dy=0;if(kh('ArrowUp')){dy=-1;G.pdir=1}else if(kh('ArrowDown')){dy=1;G.pdir=0}else if(kh('ArrowLeft')){dx=-1;G.pdir=2}else if(kh('ArrowRight')){dx=1;G.pdir=3}if(dx||dy){tryMove(dx,dy);G.moveTimer=8}if(kp('KeyX')||kp('Escape')){G.state=GS.MENU;G.ms={pg:'main',cursor:0,ci:0}}if(kp('KeyZ')||kp('Enter'))checkInteraction()}
function drawGameOver(){ctx.fillStyle='#000';ctx.fillRect(0,0,SW,SH);dtc('ぜんめつ してしまった…',SW/2,80,10,'#f00');dtc('ローレシア王「おお なさけない！',SW/2,120,8);dtc('もういちど がんばるのじゃ！」',SW/2,136,8);dtc('▶ つづきから (Zキー)',SW/2,180,8);if(kp('KeyZ')||kp('Enter')){loadGame();if(G.state!==GS.EXPLORE){G.ms={cursor:0};G.state=GS.TITLE}else{G.party.forEach(c=>{c.alive=true;c.hp=Math.max(1,Math.floor(c.maxHp/2));c.status=[]});G.gold=Math.floor(G.gold/2)}}}
function drawEnding(){ctx.fillStyle='#000';ctx.fillRect(0,0,SW,SH);const t=Math.floor(G.frame/3)%400;const a=Math.min(1,t/30);ctx.globalAlpha=a;dtc('邪神シドーは たおされた！',SW/2,30,10,'#ffd700');dtc('せかいに へいわが もどった！',SW/2,52,8);G.party.forEach((c,i)=>{const jn=JOBS[c.job]?JOBS[c.job].name:'';const prof=Object.entries(c.jobProf).filter(([k,v])=>v>=8).length;dtc(c.name,SW/2,82+i*28,8);if(jn&&jn!=='なし')dtc('職業: '+jn,SW/2,94+i*28,6,'#8cf');if(prof>0)dtc(prof+'つの職を極めた',SW/2,94+i*28+(jn&&jn!=='なし'?10:0),6,'#fd0')});const by=82+G.party.length*28+10;dtc('ダーマ神殿で鍛え 幾多の技を学び',SW/2,by,7,'#aef');dtc('ロトの末裔たちは 真の勇者となった',SW/2,by+14,7,'#aef');dtc('あなたの ぼうけんは',SW/2,by+36,8);dtc('でんせつとして かたりつがれる',SW/2,by+52,8);dtc('- THE END -',SW/2,by+76,10,'#ffd700');ctx.globalAlpha=1}
function checkBossEvents(){if(G.mapId==='hargon'&&G.px===8&&G.py===3&&!G.flags.hargonDown){const heroJob=G.party.some(c=>c.job==='hero_job');showMsg('ハーゴン「おろかな ロトの末裔どもめ！\nわが闇の力の前には\n何者も ひざまずくのみ！」',()=>{if(heroJob)showMsg('勇者の力が光を放つ！\nハーゴン「な…なんだと！\nその光は…まさか！」',()=>startBattle('ハーゴン'));else startBattle('ハーゴン')})}if(G.mapId==='hargon'&&G.px===8&&G.py===2&&G.flags.hargonDown&&!G.flags.sidoDown){showMsg('ハーゴンの体から\n禍々しい闇があふれ出す…！',()=>{showMsg('大地が裂け 天が割れる！\n闇の中から 巨大な影が\nゆっくりと姿を現した…',()=>{showMsg('邪神シドー「ハーゴンの祈りに応え\nこの世に降臨せし\n破壊の神…それが我だ。」',()=>startBattle('シドー'))})})}}
function mainLoop(){G.frame++;switch(G.state){case GS.TITLE:drawTitle();break;case GS.EXPLORE:updateExplore();checkBossEvents();drawMap();drawPlayer();drawNPCs();if(G.party.length>0){dw(0,0,SW,18);G.party.forEach((c,i)=>{const bx=i*85+4;const col=c.alive?(c.hp<c.maxHp/4?'#f00':'#fff'):'#555';dt(c.name.slice(0,2),bx,9,6,col);drawBar(bx+16,4,32,3,c.hp/c.maxHp,c.hp<c.maxHp/4?'#c00':'#0a0',c.hp<c.maxHp/4?'#f44':'#0f0');dt('H'+c.hp,bx+16,13,5,col);drawBar(bx+16,10,32,2,c.mp/c.maxMp,'#06a','#0af');dt('M'+c.mp,bx+50,13,5,'#0af')})}break;case GS.BATTLE:updateBattle();drawBattle();break;case GS.MENU:updateMenu();drawMap();drawPlayer();drawNPCs();drawMenu();break;case GS.DIALOG:drawMap();drawPlayer();drawNPCs();break;case GS.SHOP:updateShop();drawMap();drawPlayer();drawNPCs();drawShop();break;case GS.GAMEOVER:drawGameOver();break;case GS.ENDING:drawEnding();break}if(G.msgT){drawMsg();if(kp('KeyZ')||kp('Enter')){if(G.msgCI<G.msgT.length){G.msgCI=G.msgT.length}else if(G.msgCb){const cb=G.msgCb;G.msgCb=null;G.msgT='';cb();if(!G.msgT)nxtMsg()}else nxtMsg()}}requestAnimationFrame(mainLoop)}
// ===== TOUCH CONTROLS =====
document.querySelectorAll('#pad button[data-key]').forEach(btn=>{
const key=btn.dataset.key;
function tstart(e){e.preventDefault();G.keys[key]=true;G.kp[key]=true;btn.classList.add('held')}
function tend(e){e.preventDefault();G.keys[key]=false;btn.classList.remove('held')}
btn.addEventListener('touchstart',tstart,{passive:false});
btn.addEventListener('touchend',tend,{passive:false});
btn.addEventListener('touchcancel',tend,{passive:false});
btn.addEventListener('mousedown',tstart);
btn.addEventListener('mouseup',tend);
btn.addEventListener('mouseleave',tend);
});
// Prevent zoom/scroll on mobile
document.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
initMaps();initNPCs();G.state=GS.TITLE;G.ms={cursor:0};mainLoop();
</script>
</body>
</html>
