import type { GameState, NpcData } from '../types';
import { JOBS } from './jobs';

/**
 * Creates the NPC data for all map locations.
 * NPCs are returned as a factory function because many NPC messages
 * are closures that reference the game state object (G).
 */
export function createNpcs(G: GameState): Record<string, NpcData[]> {
  return {
    // =============================================================
    // ローレシア城
    // =============================================================
    loracia: [
      {
        x: 5, y: 3, name: 'ローレシア王',
        msg: () => {
          if (G.flags.sidoDown)
            return 'ローレシア王「おお 勇者たちよ！\nよくぞ邪神シドーを倒した！\nお前たちは まことの勇者じゃ！」';
          if (G.flags.hargonDown)
            return 'ローレシア王「ハーゴンは倒したか！\nしかし まだ不吉な気配が…\n油断するでないぞ！」';
          if (G.party.length >= 3)
            return 'ローレシア王「3人が揃ったか！\n北にあるダーマ神殿で\n転職すれば さらに強くなれるぞ。\nハーゴンを 必ず倒すのじゃ！」';
          if (G.flags.princeJoined)
            return 'ローレシア王「おお 王子を見つけたか！\n次はムーンブルクの王女じゃ。\nムーンペタの町に手がかりがある。」';
          return 'ローレシア王「おお ローレシアのおうじよ！\n魔王ハーゴンを倒す旅に出るのじゃ！\n南西のサマルトリア城で\n王子を仲間にするのじゃ！」';
        },
      },
      {
        x: 10, y: 8, name: '兵士',
        msg: () => {
          if (G.party.length >= 3)
            return '兵士「三人の勇者が揃いましたな！\n北のダーマ神殿をご存知ですか？\n転職で新たな力を得られます。\nハーゴン討伐の鍵になるかと。」';
          return '兵士「東にリリザの町があります。\n南の湖のほこらには\n大切なものがあるそうです。」';
        },
      },
      {
        x: 3, y: 8, name: '宿屋',
        msg: 'inn', inn: true,
      },
    ],

    // =============================================================
    // リリザ
    // =============================================================
    liriza: [
      {
        x: 4, y: 5, name: '商人',
        msg: '商人「ここはリリザだよ。\n旅に必要なものは揃ってるぜ。」', shop: true,
      },
      {
        x: 8, y: 3, name: '女性',
        msg: () => {
          if (G.flags.princeJoined)
            return '女性「王子を見つけたのね！\nそういえば 北の方に\nダーマ神殿があるって話よ。\n転職で強くなれるんですって。」';
          return '女性「サマルトリアの王子は\n旅に出たらしいわよ。\nサマルトリア城にいるみたい。」';
        },
      },
      {
        x: 6, y: 9, name: '老人',
        msg: () => {
          if (G.party.some(c => c.job !== 'none'))
            return '老人「ほう 転職しておるのか。\nひとつの職を★8まで極めれば\n上級の職への道が開けるぞ。\n戦士と武闘家でバトルマスター…\n魔法使いと僧侶で賢者じゃ。」';
          return '老人「わしが若い頃は\nダーマ神殿で修行したものじゃ。\n転職して様々な技を覚えれば\n魔王にも立ち向かえよう。」';
        },
      },
      {
        x: 2, y: 8, name: '宿屋',
        msg: 'inn', inn: true,
      },
      {
        x: 9, y: 5, name: '酒場',
        msg: 'tavern', tavern: true,
      },
    ],

    // =============================================================
    // サマルトリア城
    // =============================================================
    samaltria: [
      {
        x: 7, y: 3, name: 'サマルトリア王',
        msg: () => {
          if (G.flags.princeJoined)
            return 'サマルトリア王「息子を頼んだぞ。\nダーマ神殿で鍛えてやってくれ。\nあそこなら 職を変えて\n新しい力を身につけられる。」';
          return 'サマルトリア王「うちの王子が\nお前を探していたぞ。\nこの城のどこかにいるはず。」';
        },
      },
      {
        x: 5, y: 8, name: 'サマルトリアのおうじ',
        recruit: 'prince',
        msg: 'サマルトリアのおうじ「おお！\nぼくも つれていってください！\nいっしょに ハーゴンを倒そう！」',
      },
      {
        x: 10, y: 8, name: '宿屋',
        msg: 'inn', inn: true,
      },
      {
        x: 3, y: 5, name: '兵士',
        msg: '兵士「ダーマ神殿はご存知ですか？\nこの城から北の方角に\n神殿があるそうです。\n転職で 新たな技を覚えられると。」',
      },
    ],

    // =============================================================
    // ムーンペタ
    // =============================================================
    moonpeta: [
      {
        x: 5, y: 5, name: '老人',
        msg: '老人「この町の東に犬がいるだろう？\nあれは ムーンブルクの王女\nなのじゃ。ラーのかがみが\nあれば 元の姿にもどせるぞ。」',
      },
      {
        x: 9, y: 7, name: '犬',
        recruit: 'princess',
        msg: '犬「ワン！ワン！」\nラーのかがみを つかった！',
      },
      {
        x: 3, y: 9, name: '道具屋',
        msg: '道具屋「いらっしゃい！」', shop: true,
      },
      {
        x: 3, y: 3, name: '宿屋',
        msg: 'inn', inn: true,
      },
      {
        x: 9, y: 9, name: '酒場',
        msg: 'tavern', tavern: true,
      },
      {
        x: 7, y: 3, name: '女性',
        msg: () => {
          if (G.flags.princessJoined)
            return '女性「王女さまが元に戻ったのね！\n3人揃えばダーマ神殿で\n転職できるわ。\n踊り子になれば回復の踊りを\n覚えられるって噂よ。」';
          return '女性「ムーンブルク城は\nハーゴンに滅ぼされたの…\n王女さまだけが生き残ったけど\n呪いで犬の姿にされたらしいわ。」';
        },
      },
    ],

    // =============================================================
    // ベラヌール
    // =============================================================
    beranule: [
      {
        x: 4, y: 5, name: '船乗り',
        msg: '船乗り「船が欲しいのか？\nふねのきっぷを持ってきな！」', giveShip: true,
      },
      {
        x: 8, y: 3, name: '道具屋',
        msg: '道具屋「いらっしゃい！」', shop: true,
      },
      {
        x: 8, y: 8, name: '宿屋',
        msg: 'inn', inn: true,
      },
      {
        x: 2, y: 3, name: '酒場',
        msg: 'tavern', tavern: true,
      },
      {
        x: 6, y: 3, name: '老人',
        msg: () => {
          const hasAdv = G.party.some(c => {
            const j = JOBS[c.job];
            return j && j.req !== null;
          });
          if (hasAdv)
            return '老人「おお 上級職に就いたか！\n素晴らしい。その調子で\nバトルマスターと賢者を極めれば\n最後の職…勇者への道が開ける。\nマダンテの力があれば\nハーゴンにも勝てるじゃろう。」';
          return '老人「海の向こうには\n強い魔物がうようよしている。\nダーマ神殿で転職して\n己を鍛えてから挑むがよい。\n戦士や魔法使い 僧侶に武闘家…\n様々な技が身につくぞ。」';
        },
      },
    ],

    // =============================================================
    // ペルポイ
    // =============================================================
    perpoi: [
      {
        x: 4, y: 5, name: '学者',
        msg: () => {
          const heroJob = G.party.some(c => c.job === 'hero_job');
          if (heroJob)
            return '学者「なんと…勇者の職に！\nマダンテの力を持つ者がいれば\nハーゴンも恐るるに足らぬ。\n東の果ての神殿へ向かうがよい。」';
          return '学者「ロンダルキアへの洞窟は\n北西にある。\n強い装備と転職で鍛えた力が\n必要じゃ。\nハーゴンの神殿は東の果てに。」';
        },
      },
      {
        x: 8, y: 3, name: '道具屋',
        msg: '道具屋「いらっしゃい！」', shop: true,
      },
      {
        x: 2, y: 8, name: '宿屋',
        msg: 'inn', inn: true,
      },
      {
        x: 9, y: 7, name: '酒場',
        msg: 'tavern', tavern: true,
      },
      {
        x: 6, y: 7, name: '女性',
        msg: '女性「ダーマ神殿で修行した者が\n最後にたどり着く職業…\nそれが勇者だそうよ。\nバトルマスターと賢者を極めた\n者だけが なれるんですって。」',
      },
    ],

    // =============================================================
    // ロンダルキアのほこら
    // =============================================================
    rhone: [
      {
        x: 7, y: 5, name: '神官',
        msg: () => {
          const totalProf = G.party.reduce((s, c) => {
            let t = 0;
            for (const k in c.jobProf) t += c.jobProf[k];
            return s + t;
          }, 0);
          if (totalProf > 30)
            return '神官「よくぞここまで鍛えた。\nダーマ神殿で積んだ修行の力…\nその技と魂で 闇を打ち払え。\nハーゴン神殿は東の果てにある。」';
          return '神官「ここはロンダルキアのほこら。\nハーゴン神殿は東の果てにある。\n気をつけてゆくのじゃ。\n…もっと鍛えてから来てもよいぞ。」';
        },
      },
      {
        x: 5, y: 5, name: '宿屋',
        msg: 'inn', inn: true,
      },
    ],

    // =============================================================
    // ダーマ神殿
    // =============================================================
    dharma: [
      {
        x: 6, y: 3, name: 'ダーマ神官',
        msg: () => {
          const heroJob = G.party.some(c => c.job === 'hero_job');
          if (heroJob)
            return 'ダーマ神官「おお…ついに勇者が\n誕生したか！\nその者は あらゆる職を極め\n真の力を手に入れた。\nマダンテの光で\n闇を打ち砕くがよい！\nハーゴンを倒し 世界を救うのじゃ。」';
          const hasAdv = G.party.some(c => {
            const j = JOBS[c.job];
            return j && j.req !== null;
          });
          if (hasAdv)
            return 'ダーマ神官「上級職に進んだか。\n見事じゃ。\nしかし まだ先がある。\nバトルマスターと賢者…\nその2つを極めし者には\n最強の職 勇者への道が開ける。\n転職して参るがよい。」';
          const anyJob = G.party.some(c => c.job !== 'none');
          if (anyJob)
            return 'ダーマ神官「修行は順調かな？\n戦い続ければ熟練度が上がり\n新たな技を覚えられる。\n★8まで極めれば 上級職への\n道も見えてこよう。\n転職して参るがよい。」';
          return 'ダーマ神官「ようこそ ダーマ神殿へ。\nここは 天空より授かりし\n転職の力を司る聖なる場所。\n\n戦士 魔法使い 僧侶 武闘家\n踊り子 盗賊…\n6つの職を修めることで\n更なる高みへと至れる。\n\nさあ 転職して参るがよい。」';
        },
        dharma: true,
      },
      {
        x: 3, y: 8, name: '宿屋',
        msg: 'inn', inn: true,
      },
      {
        x: 9, y: 5, name: '女性',
        msg: () => {
          const anyMastered = G.party.some(c => {
            for (const k in c.jobProf) {
              if (c.jobProf[k] >= 8) return true;
            }
            return false;
          });
          if (anyMastered)
            return '女性「職を極めたのですね！\n2つの基本職を★8にすれば\n上級職になれますよ。\n戦士＋武闘家→バトルマスター\n魔法使い＋僧侶→賢者\nぜひ挑戦してみて。」';
          return '女性「ここで転職すると\n職業ごとの技を覚えられます。\n戦って熟練度を上げましょう。\n★の数が増えると新しい技を\n覚えますよ。」';
        },
      },
    ],
  };
}
